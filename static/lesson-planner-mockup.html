<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Lesson Planner Pro Mockup</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap">

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <style>
        /* ALL YOUR CUSTOM CSS GOES HERE */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px); /* Adjust min-height to push footer down */
        }

        header {
            background-color: #4CAF50; /* Google Green */
            color: white;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 5px solid #388E3C;
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 600;
        }

        header h1 .fas {
            margin-right: 10px;
        }

        .license-banner {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .license-banner.expired {
            background-color: #D32F2F; /* Red for expired */
        }
        .license-banner.active {
            background-color: #388E3C; /* Darker green for active */
        }

        nav {
            display: flex;
            justify-content: center;
            background-color: #e0e0e0;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }

        nav button {
            background-color: transparent;
            border: none;
            padding: 12px 20px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav button:hover {
            background-color: #d0d0d0;
            color: #333;
        }

        nav button.active {
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
        }

        main {
            padding: 25px;
            flex-grow: 1;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        h2 {
            color: #4CAF50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        h3, h4 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #444;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        select[multiple] {
            min-height: 100px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn.primary-btn {
            background-color: #4CAF50;
            color: white;
        }

        .btn.primary-btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
        }

        .btn.secondary-btn {
            background-color: #f0f0f0;
            color: #555;
            border: 1px solid #ccc;
        }

        .btn.secondary-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }

        .btn.small-btn {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .form-actions {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* FullCalendar Styling */
        #calendar, #unit-calendar { /* Apply basic calendar styling to both */
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
            position: relative;
        }

        .fc-event-main {
            color: white !important;
        }
        .fc-event {
            border-color: transparent !important;
            font-size: 0.9em;
            padding: 3px 5px;
            border-radius: 3px;
        }

        .fc-daygrid-event-dot {
            color: white !important;
        }

        .fc-button-primary {
            background-color: #4CAF50 !important;
            border-color: #388E3C !important;
            color: white !important;
        }

        .fc-button-primary:hover {
            background-color: #388E3C !important;
            border-color: #2E7D32 !important;
        }

        /* Adjust FC's default button styling for consistency */
        .fc .fc-button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #e0e0e0;
            color: #555;
            border: 1px solid #ccc;
            padding: 8px 12px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.2s ease;
            box-shadow: none;
        }

        .fc .fc-button:hover {
            background-color: #d0d0d0;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .fc .fc-button:active,
        .fc .fc-button.fc-button-active {
            background-color: #4CAF50 !important;
            color: white !important;
            border-color: #388E3C !important;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Custom button styling for FullCalendar Add button */
        .fc-addBtn-button {
            background-color: #DB4437 !important; /* Google Red */
            color: white !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .fc-addBtn-button:hover {
            background-color: #C0392B !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .fc-addBtn-button:active {
            background-color: #A52A2A !important;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Style for the dropdown menu, now positioned relative to the calendar */
        #add-dropdown-menu {
            position: absolute;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            min-width: 220px;
            padding: 10px 0;
            display: none; /* Default hidden state */
            z-index: 2000;
            border: 1px solid #ddd;
        }

        #add-dropdown-menu.active {
            display: block !important; /* Forces visibility */
        }

        /* Styling for buttons INSIDE the dropdown */
        #add-dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            color: #333;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-radius: 0;
        }

        #add-dropdown-menu button:hover {
            background-color: #f0f0f0;
            color: #1a73e8;
        }

        #add-dropdown-menu button .fas {
            margin-right: 0;
            font-size: 1.2em;
        }

        /* Specific colors for dropdown items */
        #add-lesson-option-fc { color: #4CAF50; }
        #add-unit-option-fc { color: #2196F3; }
        #add-noschool-option-fc { color: #F44336; }

        /* New: Styling for Checkbox Groups */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Space between checkboxes */
            padding: 5px 0;
            border: 1px solid #ccc; /* Match input field border */
            border-radius: 5px;
            background-color: #fff;
            padding: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0; /* Override form-group label margin */
            font-weight: normal; /* Less bold than main labels */
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px; /* Space between checkbox and text */
            width: auto; /* Allow checkbox to be its natural size */
            cursor: pointer;
        }

        /* NEW: Calendar day hover effect */
        .fc-daygrid-day {
            cursor: pointer; /* Already set, but good to reiterate */
            transition: background-color 0.15s ease-in-out; /* Smooth transition */
        }
        .fc-daygrid-day:hover {
            background-color: #e0f2f7; /* Light blue highlight on hover */
        }

        /* NEW: Styling for non-working days (weekends and NoSchoolDays) */
        /* Applies to the day cell background for weekends */
        /* Higher specificity than other background colors (like unit backgrounds) */
        .fc-day-weekend {
            background-color: rgba(244, 67, 54, 0.1) !important; /* A light, translucent red for weekends */
        }

        /* Styles for the NoSchoolDay events themselves */
        .fc-event[data-event-id^="noschool-"] {
            background-color: #F44336 !important; /* Explicit red for No-School Day events */
            color: white !important;
            font-weight: bold;
            opacity: 0.85; /* Make the event itself more opaque for visibility */
            z-index: 2; /* Ensure NoSchoolDay events are on top of unit backgrounds */
        }
        /* Important: Unit background events should be lower z-index than regular events */
        /* This class is no longer used for the Dashboard calendar but kept for potential future use or context */
        .fc-event.unit-background {
            z-index: 1;
        }

        /* NEW: Styles for the new "Unit View" unit bars */
        .fc-unit-event {
            border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
            border-radius: 5px; /* Rounded corners */
            margin-bottom: 2px; /* Small gap between stacked bars */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Slight shadow for depth */
            opacity: 0.9; /* Slightly less than full opacity */
            overflow: hidden; /* Hide overflowing text */
            color: white; /* Default text color for unit bars */
            padding: 2px 5px; /* Padding inside the bar */
            font-weight: 500;
        }
        /* Rounded ends for start and end of unit - applies automatically by FullCalendar if event has start/end */
        /* You can override if you want different rounding: */
        /*
        .fc-event.fc-event-start {
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
        }
        .fc-event.fc-event-end {
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        */
        .fc-unit-event .fc-event-title {
            color: white; /* Ensure text is readable on colored background */
            white-space: nowrap; /* Keep title on one line */
            overflow: hidden; /* Hide overflowing text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        /* Tooltip for Unit View */
        .unit-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 9999; /* Ensure it's on top */
            font-size: 0.9em;
            max-width: 300px;
            pointer-events: none; /* Allow clicks to pass through to elements beneath */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none; /* Crucial: hidden by default */
        }
        .unit-tooltip p {
            margin: 0 0 5px 0;
        }
        .unit-tooltip p:last-child {
            margin-bottom: 0;
        }


        .filter-controls {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
        }
        .filter-controls label {
            font-weight: 500;
            color: #444;
            display: block;
            margin-bottom: 10px;
        }

        #dashboard-subject-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        #dashboard-subject-checkboxes .subject-checkbox-item {
            display: flex;
            align-items: center;
        }

        #dashboard-subject-checkboxes .subject-checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        /* Student View */
        #student-details {
            margin-top: 20px;
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 8px;
            background-color: #fcfcfc;
        }

        #student-details h3 {
            color: #4CAF50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        #student-details h4 {
            color: #555;
            margin-top: 20px;
        }

        #student-details ul {
            list-style: none;
            padding-left: 0;
        }

        #student-details ul li {
            background-color: #f0f4f7;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            border-left: 3px solid #64B5F6;
            font-size: 0.95em;
        }

        #student-details ul li a {
            color: #4285F4;
            text-decoration: none;
        }
        #student-details ul li a:hover {
            text-decoration: underline;
        }

        /* Settings View (Dropdown Editor) */
        .setting-group {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setting-group h4 {
            margin-top: 0;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            color: #4CAF50;
        }
        .tag-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .tag {
            background-color: #e0f2f7;
            border: 1px solid #b2ebf2;
            padding: 5px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: #00838F;
        }
        .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #EF5350;
        }
        .remove-tag:hover {
            color: #C62828;
        }
        .add-dropdown-input {
            width: calc(100% - 70px - 10px);
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        .add-dropdown-btn {
            vertical-align: middle;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-title {
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-actions {
            margin-top: 20px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Specific styling for 'View Lessons' modal list */
        #modal-body .lesson-modal-item {
            background-color: #e8f2f7; /* Light blueish for lesson details in modal */
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 5px solid #64B5F6; /* Blue border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #modal-body .lesson-modal-item h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #4285F4; /* Google Blue */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            border-bottom: 1px dashed #c8e6c9;
        }
        #modal-body .lesson-modal-item h4 .btn {
            font-size: 0.8em;
            padding: 4px 8px;
            gap: 5px;
        }

        #modal-body .lesson-modal-item .lesson-detail-section {
            margin-top: 10px;
            padding-left: 10px;
            border-left: 2px solid #90CAF9; /* Lighter blue */
        }
        #modal-body .lesson-modal-item .lesson-detail-section p {
            margin: 5px 0;
            font-size: 0.95em;
            line-height: 1.4;
        }
        #modal-body .lesson-modal-item .lesson-detail-section ul {
            list-style: disc;
            padding-left: 25px;
            margin: 5px 0;
        }
        #modal-body .lesson-modal-item .lesson-detail-section ul li {
            background-color: transparent;
            border-left: none;
            padding: 2px 0;
            margin-bottom: 2px;
        }

        /* Collapsible details within the modal */
        #modal-body .lesson-modal-item details {
            margin-top: 10px;
            border-top: 1px dashed #dcedc8;
            padding-top: 5px;
        }
        #modal-body .lesson-modal-item details summary {
            font-weight: 600;
            cursor: pointer;
            color: #1976D2; /* Darker blue */
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
        }
        #modal-body .lesson-modal-item details summary::-webkit-details-marker {
            display: none;
        }
        #modal-body .lesson-modal-item details summary .fas {
            transition: transform 0.2s;
        }
        #modal-body .lesson-modal-item details[open] summary .fas {
            transform: rotate(90deg);
        }

        #modal-body .modal-lesson-controls {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        #reuse-results {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .reuse-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
        }
        .reuse-item:last-child {
            border-bottom: none;
        }
        .reuse-item p {
            margin: 0;
        }

        .file-upload-group #uploaded-files-list {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .file-upload-group #uploaded-files-list p {
            margin: 5px 0;
        }
        .file-upload-group #uploaded-files-list a {
            color: #4285F4;
            text-decoration: none;
        }
        .file-upload-group #uploaded-files-list a:hover {
            text-decoration: underline;
        }

        /* Lesson Form Progressive Disclosure */
        .optional-field-group {
            border: 1px dashed #ccc;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #fcfcfc;
        }
        .optional-field-group .form-group {
            margin-bottom: 10px;
        }
        .toggle-field-btn {
            margin-top: 10px;
            margin-bottom: 15px;
            background-color: #64B5F6;
            color: white;
        }
        .toggle-field-btn:hover {
            background-color: #42A5F5;
        }
        .toggle-field-btn .fas {
            margin-right: 5px;
        }
        .field-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .field-group-header h4 {
            margin: 0;
            color: #4CAF50;
        }

        /* Loader Wheel */
        #loader {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #loader.hide {
            opacity: 0;
            visibility: hidden;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Today/Tomorrow/Yesterday Lesson Summaries */
        .lesson-summary-section {
            margin-top: 25px;
            background-color: #ffffff;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            overflow: hidden;
        }

        .lesson-summary-header {
            background-color: #f0f0f0;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #eee;
        }

        .lesson-summary-header:hover {
            background-color: #e5e5e5;
        }

        .lesson-summary-content {
            padding: 15px 20px;
            border-top: none;
        }
        .lesson-summary-content p {
            margin: 5px 0;
        }
        .lesson-summary-content ul {
            list-style: disc;
            padding-left: 20px;
            margin: 10px 0;
        }
        .lesson-summary-content ul li {
            margin-bottom: 5px;
        }

        /* For details/summary native collapse behavior */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] > summary .fa-chevron-down {
            transform: rotate(180deg);
        }
        .summary-icon {
            margin-left: 10px;
            transition: transform 0.2s ease-in-out;
        }

        /* NEW FOOTER STYLES */
        footer {
            background-color: #333; /* Dark background */
            color: #bbb; /* Light grey text */
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            border-top: 3px solid #4CAF50; /* Green top border */
            margin-top: auto; /* Pushes footer to the bottom */
        }

        footer p {
            margin: 5px 0;
            line-height: 1.5;
        }

        footer a {
            color: #79CC7C; /* Lighter green for links */
            text-decoration: none;
            transition: color 0.2s ease;
        }

        footer a:hover {
            color: #fff; /* White on hover */
            text-decoration: underline;
        }

        footer .fas {
            margin-right: 5px;
            color: #79CC7C; /* Icon color */
        }

    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    <div class="container">
        <header>
            <h1><i class="fas fa-chalkboard-teacher"></i> Lesson Planner Pro</h1>
            <div id="license-status" class="license-banner"></div>
        </header>

        <nav>
            <button id="dashboard-btn" class="active"><i class="fas fa-home"></i> Dashboard</button>
            <button id="unit-view-btn"><i class="fas fa-layer-group"></i> Unit View</button> <button id="student-view-btn"><i class="fas fa-user-graduate"></i> Student View</button>
            <button id="customize-btn"><i class="fas fa-cogs"></i> Customize</button>
        </nav>

        <main>
            <div id="dashboard-view" class="view active">
                <h2><i class="fas fa-calendar-alt"></i> Calendar & Overview</h2>
                <div class="filter-controls">
                    <label><i class="fas fa-book"></i> Select Subject(s)/Class(es):</label>
                    <div id="dashboard-subject-checkboxes">
                    </div>
                </div>

                <div id="daily-lessons-summary">
                    <div id="today-lesson-summary" class="lesson-summary-section">
                        <details open>
                            <summary class="lesson-summary-header">
                                <span><i class="fas fa-sun"></i> Today's Lesson: <span id="today-date-display"></span></span>
                                <i class="fas fa-chevron-down summary-icon"></i>
                            </summary>
                            <div class="lesson-summary-content">
                                <ul id="today-lessons-list">
                                    <li>Loading...</li>
                                </ul>
                                <p id="today-unit-info"></p>
                            </div>
                        </details>
                    </div>

                    <div id="tomorrow-lesson-summary" class="lesson-summary-section">
                        <details>
                            <summary class="lesson-summary-header">
                                <span><i class="fas fa-cloud-sun"></i> Tomorrow's Lesson: <span id="tomorrow-date-display"></span></span>
                                <i class="fas fa-chevron-down summary-icon"></i>
                            </summary>
                            <div class="lesson-summary-content">
                                <ul id="tomorrow-lessons-list">
                                    <li>Loading...</li>
                                </ul>
                                <p id="tomorrow-unit-info"></p>
                            </div>
                        </details>
                    </div>

                    <div id="yesterday-lesson-summary" class="lesson-summary-section">
                        <details>
                            <summary class="lesson-summary-header">
                                <span><i class="fas fa-cloud"></i> Yesterday's Lesson: <span id="yesterday-date-display"></span></span>
                                <i class="fas fa-chevron-down summary-icon"></i>
                            </summary>
                            <div class="lesson-summary-content">
                                <ul id="yesterday-lessons-list">
                                    <li>Loading...</li>
                                </ul>
                                <p id="yesterday-unit-info"></p>
                            </div>
                        </details>
                    </div>
                </div>

                <div id="calendar">
                </div>
            </div>

            <div id="unit-view-module" class="view"> <h2><i class="fas fa-layer-group"></i> Unit Overview</h2>
                <div id="unit-calendar"></div>
            </div>

            <div id="lesson-form-content" style="display:none;">
                <form id="lesson-form">
                    <div class="form-group">
                        <label for="lesson-title"><i class="fas fa-heading"></i> Lesson Title:</label>
                        <input type="text" id="lesson-title" required>
                    </div>
                    <div class="form-group">
                        <label for="unit-name-select"><i class="fas fa-layer-group"></i> Unit Name:</label>
                        <select id="unit-name-select"></select>
                        <input type="text" id="unit-name-new-input" placeholder="Enter new unit name" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label for="task"><i class="fas fa-thumbtack"></i> Task for the day:</label>
                        <textarea id="task" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="subject-class"><i class="fas fa-book"></i> Subject/Class:</label>
                        <select id="subject-class" required></select>
                    </div>
                    <div class="form-group">
                        <label for="lesson-date"><i class="fas fa-calendar-day"></i> Date:</label>
                        <input type="date" id="lesson-date" required>
                    </div>
                    <div class="form-group">
                        <label for="objective"><i class="fas fa-brain"></i> Objective:</label>
                        <textarea id="objective" rows="3"></textarea>
                    </div>
                    <button type="button" class="btn toggle-field-btn" data-target="detailed-lesson-plan-group"><i class="fas fa-plus"></i> Add Detailed Lesson Plan</button>
                    <div id="detailed-lesson-plan-group" class="optional-field-group" style="display: none;">
                        <div class="field-group-header">
                            <h4>Detailed Lesson Plan</h4>
                            </div>
                        <div class="form-group">
                            <label for="activities"><i class="fas fa-clipboard-list"></i> Plan Details:</label>
                            <textarea id="activities" rows="6"></textarea>
                        </div>
                    </div>

                    <button type="button" class="btn toggle-field-btn" data-target="standards-group"><i class="fas fa-plus"></i> Add Standards</button>
                    <div id="standards-group" class="optional-field-group" style="display: none;">
                        <div class="field-group-header">
                            <h4>Standards</h4>
                            </div>
                        <div class="form-group">
                            <label for="standards"><i class="fas fa-bookmark"></i> Standards:</label>
                            <select id="standards" multiple></select>
                        </div>
                    </div>

                    <button type="button" class="btn toggle-field-btn" data-target="materials-group"><i class="fas fa-plus"></i> Add Materials</button>
                    <div id="materials-group" class="optional-field-group" style="display: none;">
                        <div class="field-group-header">
                            <h4>Materials</h4>
                            </div>
                        <div class="form-group">
                            <label for="materials"><i class="fas fa-box"></i> Materials:</label>
                            <textarea id="materials" rows="3"></textarea>
                        </div>
                    </div>

                    <button type="button" class="btn toggle-field-btn" data-target="differentiation-group"><i class="fas fa-plus"></i> Add Differentiation</button>
                    <div id="differentiation-group" class="optional-field-group" style="display: none;">
                        <div class="field-group-header">
                            <h4>Differentiation Strategies</h4>
                            </div>
                        <div class="form-group">
                            <label><i class="fas fa-users"></i> Strategies:</label>
                            <div id="differentiation-strategies-checkboxes" class="checkbox-group"></div>
                        </div>
                        <div class="form-group">
                            <label for="differentiation-notes">Notes:</label>
                            <textarea id="differentiation-notes" rows="2" placeholder="Specific notes on differentiation"></textarea>
                        </div>
                    </div>

                    <button type="button" class="btn toggle-field-btn" data-target="assessments-group"><i class="fas fa-plus"></i> Add Assessments</button>
                    <div id="assessments-group" class="optional-field-group" style="display: none;">
                        <div class="field-group-header">
                            <h4>Assessments</h4>
                            </div>
                        <div class="form-group">
                            <label for="assessments"><i class="fas fa-clipboard-check"></i> Assessments:</label>
                            <textarea id="assessments" rows="3"></textarea>
                        </div>
                    </div>

                    <button type="button" class="btn toggle-field-btn" data-target="student-notes-group"><i class="fas fa-plus"></i> Add Student Notes</button>
                    <div id="student-notes-group" class="optional-field-group" style="display: none;">
                        <div class="field-group-header">
                            <h4>Student-Specific Notes</h4>
                            </div>
                        <div class="form-group">
                            <label for="student-notes"><i class="fas fa-user-tag"></i> Students:</label>
                            <select id="student-notes" multiple></select>
                        </div>
                        <div class="form-group">
                            <label for="student-notes-detail">Details:</label>
                            <textarea id="student-notes-detail" rows="3" placeholder="Notes for selected students"></textarea>
                        </div>
                    </div>

                    <button type="button" class="btn toggle-field-btn" data-target="reflection-upload-group"><i class="fas fa-plus"></i> Add Reflection & Files</button>
                    <div id="reflection-upload-group" class="optional-field-group" style="display: none;">
                        <div class="field-group-header">
                            <h4>Reflection & File Upload</h4>
                            </div>
                        <div class="form-group">
                            <label for="reflection-notes"><i class="fas fa-lightbulb"></i> Reflection / Amendment Notes:</label>
                            <textarea id="reflection-notes" rows="4"></textarea>
                        </div>
                        <div class="form-group file-upload-group">
                            <label for="lesson-file-upload"><i class="fas fa-upload"></i> Upload Lesson File:</label>
                            <input type="file" id="lesson-file-upload">
                            <div id="uploaded-files-list"></div>
                        </div>
                    </div>
                    <div class="form-actions" style="margin-top:20px; justify-content: flex-end;">
                        <button type="submit" id="modal-save-lesson-btn" class="btn primary-btn"><i class="fas fa-save"></i> Save Lesson</button>
                        <button type="button" id="modal-reuse-lesson-btn" class="btn secondary-btn"><i class="fas fa-sync-alt"></i> Reuse Past Lesson</button>
                        <button type="button" id="modal-export-doc-btn" class="btn secondary-btn"><i class="fas fa-file-word"></i> Export as Google Doc</button>
                        <button type="button" id="modal-cancel-lesson-edit" class="btn secondary-btn"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                </form>
            </div>

            <div id="student-view-module" class="view">
                <h2><i class="fas fa-user-graduate"></i> Student Progress View</h2>
                <div class="filter-controls">
                    <label for="student-select"><i class="fas fa-user"></i> Select Student:</label>
                    <select id="student-select"></select>
                </div>
                <div id="student-details">
                    <h3><span id="selected-student-name"></span></h3>
                    <div id="student-lesson-list">
                        <h4>Lessons Tagged:</h4>
                        <ul id="student-lessons"></ul>
                    </div>
                <div id="student-work-list">
                        <h4>Uploaded Work:</h4>
                        <ul id="student-work"></ul>
                    </div>
                    <div id="student-reflection-notes">
                        <h4>Teacher Notes & Reflections:</h4>
                        <ul id="student-reflections"></ul>
                    </div>
                </div>
            </div>

            <div id="unit-form-content" style="display:none;">
                <form id="unit-form">
                    <div class="form-group">
                        <label for="modal-unit-name-input"><i class="fas fa-tag"></i> Unit Name:</label>
                        <input type="text" id="modal-unit-name-input" placeholder="e.g., Geometry Unit 1" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-unit-subject-select"><i class="fas fa-book"></i> Subject/Class:</label>
                        <select id="modal-unit-subject-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="modal-unit-start-date"><i class="fas fa-calendar-check"></i> Start Date:</label>
                        <input type="date" id="modal-unit-start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-unit-end-date"><i class="fas fa-calendar-times"></i> End Date:</label>
                        <input type="date" id="modal-unit-end-date" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-unit-notes"><i class="fas fa-sticky-note"></i> Notes:</label>
                        <textarea id="modal-unit-notes" rows="2"></textarea>
                    </div>
                    <div class="form-actions" style="margin-top:20px; justify-content: flex-end;">
                        <button type="submit" id="modal-save-unit-btn" class="btn primary-btn"><i class="fas fa-save"></i> Save Unit</button>
                        <button id="modal-cancel-unit-btn" class="btn secondary-btn"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                </form>
            </div>

            <div id="noschool-form-content" style="display:none;">
                <form id="noschool-form">
                    <div class="form-group">
                        <label for="modal-noschool-start-date"><i class="fas fa-calendar-alt"></i> Start Date:</label>
                        <input type="date" id="modal-noschool-start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-noschool-end-date"><i class="fas fa-calendar-alt"></i> End Date (optional):</label>
                        <input type="date" id="modal-noschool-end-date">
                    </div>
                    <div class="form-group">
                        <label for="modal-noschool-reason"><i class="fas fa-comment-alt"></i> Reason:</label>
                        <input type="text" id="modal-noschool-reason" placeholder="e.g., Christmas Break, Holiday" required>
                    </div>
                </form>
                <div class="form-actions" style="margin-top:20px; justify-content: flex-end;">
                    <button type="submit" id="modal-save-noschool-btn" class="btn primary-btn"><i class="fas fa-save"></i> Add No-School Day(s)</button>
                    <button id="modal-cancel-noschool-btn" class="btn secondary-btn"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>


            <div id="customize-view" class="view">
                <h2><i class="fas fa-cogs"></i> Customize Application</h2>
                <p>Manage your custom dropdown options here. For subjects, you can also set a color.</p>

                <details class="setting-group" open>
                    <summary>
                        <h4><i class="fas fa-list"></i> Manage Dropdowns</h4>
                        <i class="fas fa-chevron-down"></i>
                    </summary>
                    <div id="dropdowns-editor" class="details-content">
                    </div>
                </details>

                <details class="setting-group">
                    <summary>
                        <h4><i class="fas fa-edit"></i> Daily Reflection Prompt</h4>
                        <i class="fas fa-chevron-down"></i>
                    </summary>
                    <div class="details-content">
                        <div class="form-group">
                            <label for="reflection-prompt"><i class="fas fa-pencil-alt"></i> Your Reflection Prompt:</label>
                            <textarea id="reflection-prompt" rows="3" placeholder="Write your daily/weekly reflection here..."></textarea>
                        </div>
                        <button id="save-reflection-btn" class="btn primary-btn"><i class="fas fa-check"></i> Save Reflection</button>
                    </div>
                </details>
            </div>

            <div id="modal" class="modal">
                <div class="modal-content">
                    <span class="close-button">Ã—</span>
                    <h3 id="modal-title"></h3>
                    <div id="modal-body"></div>
                </div>
            </div>

        </main>

        <footer>
            <p>Created by GC Education Analytics LLC</p>
            <p>
                <i class="fas fa-globe"></i> Website: <a href="https://gceducationanalytics.com" target="_blank">gceducationanalytics.com</a>
                <span style="margin: 0 10px;">|</span>
                <i class="fas fa-envelope"></i> Email: <a href="mailto:gcastillo@gceducationanalytics.com">gcastillo@gceducationanalytics.com</a>
            </p>
        </footer>
    </div>

    <script>
        // --- MOCK DATA FOR FRONTEND MOCKUP ---
        // This data replaces the Google Sheet backend for demonstration purposes.

        const MOCK_DATA = {
            dropdowns: [
                { type: 'Subjects', value: 'Math', color: '#4CAF50' },
                { type: 'Subjects', value: 'Science', color: '#FFC107' },
                { type: 'Subjects', value: 'ELA', color: '#2196F3' },
                { type: 'Subjects', value: 'History', color: '#9C27B0' },
                { type: 'Differentiation Strategies', value: 'Small Group', color: '' },
                { type: 'Differentiation Strategies', value: 'Tiered Assignments', color: '' },
                { type: 'Differentiation Strategies', value: 'Flexible Grouping', color: '' },
                { type: 'Differentiation Strategies', value: 'Scaffolding', color: '' },
                { type: 'Differentiation Strategies', value: 'One-on-One Support', color: '' },
                { type: 'Assessment Types', value: 'Formative', color: '' },
                { type: 'Assessment Types', value: 'Summative', color: '' },
                { type: 'Assessment Types', value: 'Observation', color: '' },
                { type: 'Assessment Types', value: 'Exit Ticket', color: '' },
                { type: 'Teaching Strategies', value: 'Direct Instruction', color: '' },
                { type: 'Teaching Strategies', 'value': 'Collaborative Learning', color: '' },
                { type: 'Teaching Strategies', 'value': 'Inquiry-Based Learning', color: '' },
                { type: 'Teaching Strategies', 'value': 'Project-Based Learning', color: '' },
            ],
            students: [
                { Name: 'Alice Smith', ID: 'STU001', Class: '5A', Notes: 'Struggles with fractions.' },
                { Name: 'Bob Johnson', ID: 'STU002', Class: '5B', Notes: 'Strong reader, needs more challenge.' },
                { Name: 'Charlie Brown', ID: 'STU003', Class: '5A', Notes: 'Excellent in art, shy in groups.' },
                { Name: 'Diana Prince', ID: 'STU004', Class: '5B', Notes: 'Gifted in science, requires hands-on activities.' },
            ],
            standards: [
                { Subject: 'Math', Standard: 'CCSS.MATH.CONTENT.5.NF.A.1' },
                { Subject: 'Math', Standard: 'CCSS.MATH.CONTENT.5.OA.A.2' },
                { Subject: 'Science', Standard: 'NGSS.5-PS1-1' },
                { Subject: 'Science', Standard: 'NGSS.5-LS2-1' },
                { Subject: 'ELA', Standard: 'CCSS.ELA-LITERACY.RL.5.1' },
                { Subject: 'ELA', Standard: 'CCSS.ELA-LITERACY.W.5.2' },
                { Subject: 'History', Standard: 'C3.D2.His.1.3-5' },
                { Subject: 'History', Standard: 'C3.D2.Geo.2.3-5' },
            ],
            units: [
                { ID: 'UNIT001', UnitName: 'Fractions & Decimals', Subject: 'Math', StartDate: '2025-08-01', EndDate: '2025-08-22', TotalWorkingDays: 16, Notes: 'Focus on real-world applications and mixed numbers.' },
                { ID: 'UNIT002', UnitName: 'Ecosystems & Biodiversity', Subject: 'Science', StartDate: '2025-08-01', EndDate: '2025-08-29', TotalWorkingDays: 21, Notes: 'Field trip planned Aug 28. Project on local ecosystems.' },
                { ID: 'UNIT003', UnitName: 'Narrative Writing', Subject: 'ELA', StartDate: '2025-08-01', EndDate: '2025-08-30', TotalWorkingDays: 22, Notes: 'Emphasis on character development and plot structure.' },
                { ID: 'UNIT004', UnitName: 'Ancient Civilizations', Subject: 'History', StartDate: '2025-08-01', EndDate: '2025-08-29', TotalWorkingDays: 21, Notes: 'Project-based learning approach on one ancient civilization.' },

                { ID: 'UNIT005', UnitName: 'Geometry Basics', Subject: 'Math', StartDate: '2025-08-25', EndDate: '2025-09-19', TotalWorkingDays: 20, Notes: 'Introduction to shapes, angles, and area.' },
                { ID: 'UNIT006', UnitName: 'Human Body Systems', Subject: 'Science', StartDate: '2025-09-02', EndDate: '2025-09-26', TotalWorkingDays: 19, Notes: 'Focus on skeletal and muscular systems.' },
                { ID: 'UNIT007', UnitName: 'Informative Essays', Subject: 'ELA', StartDate: '2025-09-02', EndDate: '2025-09-26', TotalWorkingDays: 19, Notes: 'Research skills and proper citation introduction.' },
                { ID: 'UNIT008', UnitName: 'World War II', Subject: 'History', StartDate: '2025-09-02', EndDate: '2025-09-30', TotalWorkingDays: 21, Notes: 'Impact on global politics and society.' },
            ],
            noSchoolDays: [
                { ID: 'NSD001', Date: '2025-09-01', Reason: 'Labor Day' },
                { ID: 'NSD002', Date: '2025-09-26', Reason: 'Teacher Workday' },
                { ID: 'NSD003', Date: '2025-08-28', Reason: 'Field Trip - Science' }, // Example of a school day taken by field trip for one subject
            ],
            lessons: [], // Will be populated dynamically below
            attachments: [], // Attachments are per-lesson, populated below
            licenseStatus: { expired: false, daysRemaining: 360 },
            reflectionPrompt: "What was one success I had today, and one area for growth?"
        };

        // Helper to generate a UUID (for mock data)
        function generateUuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Generate dummy lesson data for August and September 2025
        const lessonGenerationStartDate = moment('2025-08-01');
        const lessonGenerationEndDate = moment('2025-09-30');
        let currentLessonDate = lessonGenerationStartDate.clone();
        let lessonCounter = 1;

        const allSubjects = ['Math', 'Science', 'ELA', 'History'];
        const studentNames = MOCK_DATA.students.map(s => s.Name);

        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function getUnitForDateAndSubject(date, subject) {
            const mDate = moment(date);
            const matchingUnits = MOCK_DATA.units.filter(unit => {
                return unit.Subject === subject &&
                       mDate.isSameOrAfter(moment(unit.StartDate), 'day') &&
                       mDate.isSameOrBefore(moment(unit.EndDate), 'day');
            });
            // Prioritize units that specifically start/end closer to the date if multiple exist
            if (matchingUnits.length > 0) {
                return matchingUnits.sort((a, b) => {
                    const diffA = Math.abs(mDate.diff(moment(a.StartDate), 'days')) + Math.abs(mDate.diff(moment(a.EndDate), 'days'));
                    const diffB = Math.abs(mDate.diff(moment(b.StartDate), 'days')) + Math.abs(mDate.diff(moment(b.EndDate), 'days'));
                    return diffA - diffB;
                })[0];
            }
            return null; // No unit found for this date and subject
        }

        while (currentLessonDate.isSameOrBefore(lessonGenerationEndDate)) {
            const dayOfWeek = currentLessonDate.day(); // 0 = Sunday, 6 = Saturday
            const formattedDate = currentLessonDate.format('YYYY-MM-DD');

            // Skip weekends
            if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                allSubjects.forEach(subject => {
                    // Check for specific no-school days that might affect a subject (like a field trip)
                    const isNoSchoolDayForSubject = MOCK_DATA.noSchoolDays.some(nsd => nsd.Date === formattedDate && nsd.Reason.includes(subject));
                    if (formattedDate === '2025-09-01' || formattedDate === '2025-09-26' || isNoSchoolDayForSubject) {
                        // Skip if it's a general holiday or subject-specific non-school day
                        return;
                    }

                    const currentUnit = getUnitForDateAndSubject(formattedDate, subject);
                    if (!currentUnit) {
                        // If no unit found for the specific date and subject, skip this lesson generation
                        // console.warn(`No unit found for ${subject} on ${formattedDate}. Skipping lesson.`);
                        return;
                    }

                    let lessonTitle, standards, objective, activities, materials, diffStrategies, diffNotes, assessments, studentNotes, studentNotesDetail, reflectionNotes, task;
                    let assignedStudent = getRandomElement(studentNames);
                    let otherStudents = studentNames.filter(s => s !== assignedStudent);
                    let taggedStudents = (Math.random() > 0.6 && otherStudents.length > 0) ? `${assignedStudent}, ${getRandomElement(otherStudents)}` : assignedStudent;

                    switch (subject) {
                        case 'Math':
                            lessonTitle = `Math: ${currentUnit.UnitName} - Lesson ${lessonCounter % 10 || 1}`;
                            standards = getRandomElement(MOCK_DATA.standards.filter(s => s.Subject === 'Math')).Standard;
                            objective = `Students will apply concepts of ${currentUnit.UnitName.toLowerCase()} to real-world problems.`;
                            activities = `Review previous day's homework. Introduce new concept (e.g., unit fractions, geometric shapes). Guided practice with examples. Independent practice: Problem Set ${lessonCounter % 5 || 1}.`;
                            materials = 'Whiteboards, markers, Math textbook, Projector.';
                            diffStrategies = 'Small Group, Scaffolding';
                            diffNotes = `Work with a small group on concept review (e.g., ${assignedStudent}). Provide enrichment problems for advanced learners.`;
                            assessments = 'Observation, Exit Ticket, Problem Set completion.';
                            studentNotes = taggedStudents;
                            studentNotesDetail = `${assignedStudent} struggled with question 3, needs extra review on [specific concept]. Other student made good connections.`;
                            reflectionNotes = `Class struggled with multi-step problems today. Need to break down concepts into smaller chunks for tomorrow.`;
                            task = 'Complete assigned problems';
                            break;
                        case 'Science':
                            lessonTitle = `Science: ${currentUnit.UnitName} - Topic ${lessonCounter % 8 || 1}`;
                            standards = getRandomElement(MOCK_DATA.standards.filter(s => s.Subject === 'Science')).Standard;
                            objective = `Students will analyze interactions within ${currentUnit.UnitName.toLowerCase()}.`;
                            activities = `Opening question: How do living things interact? Video: Ecosystems basics. Lab Activity: Observe pond water samples. Discussion: Components of a healthy ecosystem.`;
                            materials = 'Microscopes, pond water samples, lab notebooks, projector.';
                            diffStrategies = 'Flexible Grouping, Inquiry-Based Learning';
                            diffNotes = `Provide pre-labeled diagrams for visual learners. Encourage hypothesis formation from advanced groups.`;
                            assessments = 'Lab sheet completion, Group discussion participation.';
                            studentNotes = taggedStudents;
                            studentNotesDetail = `${assignedStudent} showed great curiosity during lab, asked probing questions.`;
                            reflectionNotes = 'Lab was successful. Need clearer instructions for data recording next time.';
                            task = 'Prepare for lab activity';
                            break;
                        case 'ELA':
                            lessonTitle = `ELA: ${currentUnit.UnitName} - Craft ${lessonCounter % 7 || 1}`;
                            standards = getRandomElement(MOCK_DATA.standards.filter(s => s.Subject === 'ELA')).Standard;
                            objective = `Students will use descriptive language to enhance their narrative writing.`;
                            activities = `Read aloud: Excerpt from "The Wind in the Willows". Mini-lesson: Show, Don't Tell. Writing Workshop: Practice using stronger verbs and adjectives. Peer feedback.`;
                            materials = 'Mentor texts, writing notebooks, descriptive word lists.';
                            diffStrategies = 'Tiered Assignments, Graphic Organizers';
                            diffNotes = `Provide sentence starters for narrative descriptions. Encourage advanced writers to experiment with figurative language.`;
                            assessments = 'Draft review, Peer feedback reflection.';
                            studentNotes = taggedStudents;
                            studentNotesDetail = `${assignedStudent} used vivid imagery in their opening sentence. Encouraged more detail throughout.`;
                            reflectionNotes = 'Students are improving their vocabulary. Next, focus on developing character voice.';
                            task = 'Draft a descriptive paragraph';
                            break;
                        case 'History':
                            lessonTitle = `History: ${currentUnit.UnitName} - Culture ${lessonCounter % 6 || 1}`;
                            standards = getRandomElement(MOCK_DATA.standards.filter(s => s.Subject === 'History')).Standard;
                            objective = `Students will identify significant cultural contributions of ${currentUnit.UnitName.toLowerCase()}.`;
                            activities = `Review: Timeline of events. Primary Source Analysis: Examine artifacts from ancient civilizations. Small Group Discussion: How do these artifacts reflect culture? Presentation of findings.`;
                            materials = 'Image slides of artifacts, primary source excerpts, discussion questions.';
                            diffStrategies = 'Collaborative Learning, Visual Aids';
                            diffNotes = `Provide simplified primary source texts. Challenge advanced students to compare/contrast across civilizations.`;
                            assessments = 'Group presentation, Exit Ticket: One cultural contribution learned.';
                            studentNotes = taggedStudents;
                            studentNotesDetail = `${assignedStudent} was articulate during the presentation, demonstrating deep understanding.`;
                            reflectionNotes = 'Students were engaged in artifact analysis. Time management for presentations needs improvement.';
                            task = 'Research cultural aspects';
                            break;
                    }

                    MOCK_DATA.lessons.push({
                        ID: `L-${subject.substring(0,1).toUpperCase()}${formattedDate.replace(/-/g,'')}-${lessonCounter.toString().padStart(3, '0')}`,
                        LessonTitle: lessonTitle,
                        UnitName: currentUnit.UnitName, // Assign the found unit
                        SubjectClass: subject,
                        Date: formattedDate,
                        Standards: standards,
                        Objective: objective,
                        Activities: activities,
                        Materials: materials,
                        DifferentiationStrategies: diffStrategies,
                        DifferentiationNotes: diffNotes,
                        Assessments: assessments,
                        StudentNotes: studentNotes,
                        StudentNotesDetail: studentNotesDetail,
                        ReflectionNotes: reflectionNotes,
                        LastModified: moment().subtract(Math.random() * 5, 'days').toISOString(),
                        Task: task
                    });

                    // Add a mock attachment for every few lessons
                    if (Math.random() > 0.7) { // Reduce frequency to avoid too many
                        MOCK_DATA.attachments.push({
                            ID: generateUuid(),
                            LessonID: `L-${subject.substring(0,1).toUpperCase()}${formattedDate.replace(/-/g,'')}-${lessonCounter.toString().padStart(3, '0')}`,
                            FileName: `${subject}_${formattedDate.replace(/-/g,'')}_Resource.pdf`,
                            FileID: `mock-file-${generateUuid()}`,
                            URL: `https://example.com/mock-resource/${subject.toLowerCase()}_${formattedDate.replace(/-/g,'')}.pdf`,
                            MIMEType: 'application/pdf',
                            LessonDate: formattedDate,
                            Subject: subject,
                            UploadedOn: moment().toISOString(),
                            StudentTag: (Math.random() > 0.5) ? assignedStudent : ''
                        });
                    }
                    lessonCounter++;
                });
            }
            currentLessonDate.add(1, 'days'); // Move to next day
        }

        // --- MOCK google.script.run OBJECT ---
        // This object directly returns Promises to mimic asynchronous Apps Script calls.
        const mockGoogleScriptRun = {
            getDropdownOptions: function() {
                console.log('[MOCK Backend] getDropdownOptions called.');
                return Promise.resolve(MOCK_DATA.dropdowns);
            },
            getDropdownOptionsByType: function(type) {
                console.log(`[MOCK Backend] getDropdownOptionsByType('${type}') called.`);
                const filtered = MOCK_DATA.dropdowns.filter(d => d.type === type).map(d => d.value);
                return Promise.resolve(filtered);
            },
            addDropdownOption: function(type, value, color) {
                console.log(`[MOCK Backend] addDropdownOption('${type}', '${value}') called.`);
                if (MOCK_DATA.dropdowns.some(d => d.type === type && d.value === value)) {
                    return Promise.reject(new Error(`An option with value '${value}' already exists for type '${type}'.`));
                } else {
                    MOCK_DATA.dropdowns.push({ type, value, color });
                    return Promise.resolve(true);
                }
            },
            removeDropdownOption: function(type, value) {
                console.log(`[MOCK Backend] removeDropdownOption('${type}', '${value}') called.`);
                const initialLength = MOCK_DATA.dropdowns.length;
                MOCK_DATA.dropdowns = MOCK_DATA.dropdowns.filter(d => !(d.type === type && d.value === value));
                if (MOCK_DATA.dropdowns.length === initialLength) {
                    return Promise.reject(new Error('Option not found to remove.'));
                } else {
                    return Promise.resolve(true);
                }
            },
            updateDropdownOptionColor: function(type, value, newColor) {
                console.log(`[MOCK Backend] updateDropdownOptionColor('${type}', '${value}', '${newColor}') called.`);
                const item = MOCK_DATA.dropdowns.find(d => d.type === type && d.value === value);
                if (item) {
                    item.color = newColor;
                    return Promise.resolve(true);
                } else {
                    return Promise.reject(new Error('Option not found to update color.'));
                }
            },
            getLicenseStatus: function() {
                console.log('[MOCK Backend] getLicenseStatus called.');
                return Promise.resolve(MOCK_DATA.licenseStatus);
            },
            getReflectionPrompt: function() {
                console.log('[MOCK Backend] getReflectionPrompt called.');
                return Promise.resolve(MOCK_DATA.reflectionPrompt);
            },
            saveReflectionPrompt: function(prompt) {
                console.log(`[MOCK Backend] saveReflectionPrompt('${prompt.substring(0,20)}...') called.`);
                MOCK_DATA.reflectionPrompt = prompt;
                return Promise.resolve(true);
            },
            getStudents: function() {
                console.log('[MOCK Backend] getStudents called.');
                return Promise.resolve(MOCK_DATA.students);
            },
            getStudentTrackingData: function(studentName) {
                console.log(`[MOCK Backend] getStudentTrackingData('${studentName}') called.`);
                const studentLessons = MOCK_DATA.lessons.filter(l => l.StudentNotes && l.StudentNotes.includes(studentName)).map(l => ({
                    LessonID: l.ID,
                    Title: l.LessonTitle,
                    Date: l.Date,
                    StudentNotesDetail: l.StudentNotesDetail
                }));
                const studentReflections = []; // Not mocked here
                const studentAttachments = MOCK_DATA.attachments.filter(a => a.StudentTag && a.StudentTag.includes(studentName)).map(a => ({
                    FileName: a.FileName,
                    Url: a.URL,
                    LessonDate: a.LessonDate
                }));

                return Promise.resolve({
                    lessons: studentLessons,
                    reflections: studentReflections,
                    attachments: studentAttachments
                });
            },
            getLessonsForCalendar: function(startDate, endDate, subjectFilters) {
                console.log(`[MOCK Backend] getLessonsForCalendar('${startDate}', '${endDate}', ${JSON.stringify(subjectFilters)}) called.`);
                const filteredLessons = MOCK_DATA.lessons.filter(lesson => {
                    const lessonDate = moment(lesson.Date);
                    const filterStart = moment(startDate);
                    const filterEnd = moment(endDate);
                    const matchesDate = lessonDate.isBetween(filterStart, filterEnd, 'day', '[]'); // Inclusive start/end
                    const showAllSubjects = !subjectFilters || subjectFilters.length === 0 || subjectFilters.includes('All');
                    const matchesSubject = showAllSubjects ? true : subjectFilters.includes(lesson.SubjectClass);
                    return matchesDate && matchesSubject;
                });
                return Promise.resolve(filteredLessons);
            },
            getLessonsByDateAndSubject: function(dateStr, subjectFilters) {
                console.log(`[MOCK Backend] getLessonsByDateAndSubject('${dateStr}', ${JSON.stringify(subjectFilters)}) called.`);
                const filteredLessons = MOCK_DATA.lessons.filter(lesson => {
                    const matchesDate = lesson.Date === dateStr;
                    const showAllSubjects = !subjectFilters || subjectFilters.length === 0 || subjectFilters.includes('All');
                    const matchesSubject = showAllSubjects ? true : subjectFilters.includes(lesson.SubjectClass);
                    return matchesDate && matchesSubject;
                });
                return Promise.resolve(filteredLessons);
            },
            getUnits: function() {
                console.log('[MOCK Backend] getUnits called.');
                return Promise.resolve(MOCK_DATA.units);
            },
            getNoSchoolDays: function() {
                console.log('[MOCK Backend] getNoSchoolDays called.');
                return Promise.resolve(MOCK_DATA.noSchoolDays);
            },
            getLessonsAndUnitsForSummary: function(dateStr, subjectFilters) {
                console.log(`[MOCK Backend] getLessonsAndUnitsForSummary('${dateStr}', ${JSON.stringify(subjectFilters)}) called.`);
                const lessonsForDate = MOCK_DATA.lessons.filter(lesson => {
                    const matchesDate = lesson.Date === dateStr;
                    const showAllSubjects = !subjectFilters || subjectFilters.length === 0 || subjectFilters.includes('All');
                    const matchesSubject = showAllSubjects ? true : subjectFilters.includes(lesson.SubjectClass);
                    return matchesDate && matchesSubject;
                });
                const relevantUnits = lessonsForDate.length > 0
                    ? MOCK_DATA.units.filter(unit => lessonsForDate.some(lesson => lesson.UnitName === unit.UnitName && lesson.SubjectClass === unit.Subject))
                    : MOCK_DATA.units; // Return all units if no specific lesson found for context

                return Promise.resolve({
                    lessons: lessonsForDate,
                    units: relevantUnits,
                    noSchoolDays: MOCK_DATA.noSchoolDays // Always return all no-school days for calculation
                });
            },
            getRemainingWorkingDays: function(endDateStr) {
                console.log(`[MOCK Backend] getRemainingWorkingDays('${endDateStr}') called.`);
                const startDate = moment('2025-08-15').startOf('day'); // Fixed "Today" for mockup consistency
                const endDate = moment(endDateStr).startOf('day');
                let count = 0;
                let current = startDate.clone();
                while (current.isSameOrBefore(endDate, 'day')) {
                    const dayOfWeek = current.day();
                    const formattedDate = current.format('YYYY-MM-DD');
                    if (dayOfWeek !== 0 && dayOfWeek !== 6 && MOCK_DATA.noSchoolDays.every(nsd => nsd.Date !== formattedDate)) {
                        count++;
                    }
                    current.add(1, 'day');
                }
                return Promise.resolve(count);
            },
            getLessonById: function(lessonId) {
                console.log(`[MOCK Backend] getLessonById('${lessonId}') called.`);
                const lesson = MOCK_DATA.lessons.find(l => l.ID === lessonId);
                if (lesson) {
                    const attachments = MOCK_DATA.attachments.filter(a => a.LessonID === lesson.ID);
                    return Promise.resolve({ ...lesson, Attachments: attachments });
                } else {
                    return Promise.resolve(null);
                }
            },
            saveLesson: function(lessonData) {
                console.log(`[MOCK Backend] saveLesson('${lessonData.id || "NEW"}') called.`);
                if (lessonData.id) {
                    const index = MOCK_DATA.lessons.findIndex(l => l.ID === lessonData.id);
                    if (index !== -1) {
                        MOCK_DATA.lessons[index] = { ...lessonData, LastModified: moment().toISOString() };
                        return Promise.resolve(lessonData.id);
                    } else {
                        const newId = generateUuid();
                        MOCK_DATA.lessons.push({ ...lessonData, ID: newId, LastModified: moment().toISOString() });
                        return Promise.resolve(newId);
                    }
                } else {
                    const newId = generateUuid();
                    MOCK_DATA.lessons.push({ ...lessonData, ID: newId, LastModified: moment().toISOString() });
                    return Promise.resolve(newId);
                }
            },
            uploadLessonFiles: function(fileData) {
                console.log(`[MOCK Backend] uploadLessonFiles for ${fileData.files.length} files.`);
                fileData.files.forEach(file => {
                    MOCK_DATA.attachments.push({
                        ID: generateUuid(),
                        LessonID: fileData.lessonId,
                        FileName: file.fileName,
                        FileID: `mock-file-${generateUuid()}`,
                        URL: `https://example.com/mock-uploaded/${file.fileName}`,
                        MIMEType: file.mimeType,
                        LessonDate: fileData.lessonDate,
                        Subject: fileData.subjectClass,
                        UploadedOn: moment().toISOString(),
                        StudentTag: ''
                    });
                });
                return Promise.resolve(true);
            },
            getLessonsForReuse: function(lessonId, dateStr, subject) {
                console.log(`[MOCK Backend] getLessonsForReuse('${lessonId}', '${dateStr}', '${subject}') called.`);
                const filtered = MOCK_DATA.lessons.filter(l => {
                    const matchId = lessonId ? l.ID === lessonId : true;
                    const matchDate = dateStr ? l.Date === dateStr : true;
                    const matchSubject = subject ? l.SubjectClass === subject : true;
                    return matchId && matchDate && matchSubject;
                }).map(l => ({
                    ID: l.ID,
                    Title: l.LessonTitle,
                    Date: l.Date,
                    SubjectClass: l.SubjectClass
                }));
                return Promise.resolve(filtered);
            },
            saveUnit: function(unitData) {
                console.log(`[MOCK Backend] saveUnit('${unitData.id || "NEW"}') called.`);
                if (unitData.id) {
                    const index = MOCK_DATA.units.findIndex(u => u.ID === unitData.id);
                    if (index !== -1) {
                        const totalWorkingDays = MOCK_DATA.units[index].TotalWorkingDays; // Keep existing for simplicity
                        MOCK_DATA.units[index] = { ...unitData, TotalWorkingDays: totalWorkingDays };
                        return Promise.resolve(unitData.id);
                    } else {
                        const newId = generateUuid();
                        const totalWorkingDays = 15 + Math.floor(Math.random() * 5); // Mock a value
                        MOCK_DATA.units.push({ ...unitData, ID: newId, TotalWorkingDays: totalWorkingDays });
                        return Promise.resolve(newId);
                    }
                } else {
                    const newId = generateUuid();
                    const totalWorkingDays = 15 + Math.floor(Math.random() * 5); // Mock a value
                    MOCK_DATA.units.push({ ...unitData, ID: newId, TotalWorkingDays: totalWorkingDays });
                    return Promise.resolve(newId);
                }
            },
            deleteLesson: function(lessonId) {
                console.log(`[MOCK Backend] deleteLesson('${lessonId}') called.`);
                const initialLength = MOCK_DATA.lessons.length;
                MOCK_DATA.lessons = MOCK_DATA.lessons.filter(l => l.ID !== lessonId);
                MOCK_DATA.attachments = MOCK_DATA.attachments.filter(a => a.LessonID !== lessonId); // Also delete attachments
                if (MOCK_DATA.lessons.length === initialLength) {
                    return Promise.reject(new Error('Lesson not found to delete.'));
                } else {
                    return Promise.resolve(true);
                }
            },
            deleteNoSchoolDay: function(noSchoolDayId) {
                 console.log(`[MOCK Backend] deleteNoSchoolDay('${noSchoolDayId}') called.`);
                const initialLength = MOCK_DATA.noSchoolDays.length;
                MOCK_DATA.noSchoolDays = MOCK_DATA.noSchoolDays.filter(nsd => nsd.ID !== noSchoolDayId);
                if (MOCK_DATA.noSchoolDays.length === initialLength) {
                    return Promise.reject(new Error('No School Day not found to delete.'));
                } else {
                    return Promise.resolve(true);
                }
            },
            saveNoSchoolDay: function(data) {
                console.log(`[MOCK Backend] saveNoSchoolDay('${data.startDate}' to '${data.endDate}') called.`);
                let newId = generateUuid();
                let currentDate = moment(data.startDate);
                const endDate = moment(data.endDate);
                while (currentDate.isSameOrBefore(endDate)) {
                    const dateString = currentDate.format('YYYY-MM-DD');
                    if (!MOCK_DATA.noSchoolDays.some(nsd => nsd.Date === dateString && nsd.Reason === data.reason)) {
                        MOCK_DATA.noSchoolDays.push({
                            ID: generateUuid(),
                            Date: dateString,
                            Reason: data.reason
                        });
                    }
                    currentDate.add(1, 'day');
                }
                return Promise.resolve(true);
            },
            exportLessonAsGoogleDoc: function(lessonId) {
                console.log(`[MOCK Backend] exportLessonAsGoogleDoc('${lessonId}') called.`);
                const lesson = MOCK_DATA.lessons.find(l => l.ID === lessonId);
                if (lesson) {
                    return Promise.resolve(`https://docs.google.com/document/d/mock-doc-id-${lessonId}/edit`);
                } else {
                    return Promise.reject(new Error('Lesson not found for export.'));
                }
            }
        };

        // Replace google.script.run with the mock for local testing
        const google = {
            script: {
                run: mockGoogleScriptRun
            }
        };

        // --- Loader Functions ---
        const loader = document.getElementById('loader');

        function showLoader() {
            loader.classList.remove('hide');
            loader.classList.add('show');
            console.log('[Loader] Showing loader.');
        }

        function hideLoader() {
            loader.classList.remove('show');
            loader.classList.add('hide');
            console.log('[Loader] Hiding loader.');
        }

        // Helper function to wrap google.script.run calls in Promises for async/await
        // MODIFIED: Integrates showLoader/hideLoader automatically for backend calls
        function runScriptAsPromise(functionName, ...args) {
            showLoader(); // Show loader at the start of every backend call
            return new Promise((resolve, reject) => {
                // Call the mock function directly, which now returns a Promise
                const mockCall = google.script.run[functionName](...args);

                mockCall.then(result => {
                    hideLoader(); // Hide loader on success
                    console.log(`[Client Success] ${functionName} completed with result:`, result);
                    resolve(result);
                }).catch(error => {
                    hideLoader(); // Hide loader on failure
                    console.error(`[Client Error] ${functionName} failed with error:`, error);
                    reject(error);
                });
            });
        }

        // --- Global Variables and DOM Elements ---
        const dashboardView = document.getElementById('dashboard-view');
        const unitViewModule = document.getElementById('unit-view-module'); // New Unit View Module
        const studentViewModule = document.getElementById('student-view-module');
        const customizeView = document.getElementById('customize-view');

        const dashboardBtn = document.getElementById('dashboard-btn');
        const unitViewBtn = document.getElementById('unit-view-btn'); // New Unit View Button
        const studentViewBtn = document.getElementById('student-view-btn');
        const customizeBtn = document.getElementById('customize-btn');

        let addDropdownMenuElement = null; // Dynamically created dropdown div

        // Get the hidden content templates (these remain hidden and are cloned)
        const lessonFormContentTemplate = document.getElementById('lesson-form-content');
        const unitFormContentTemplate = document.getElementById('unit-form-content');
        const noSchoolFormContentTemplate = document.getElementById('noschool-form-content');

        // These will hold references to the *live* form elements *inside the modal*
        let currentLessonFormElements = {};
        let currentUnitFormElements = {};
        let currentNoSchoolFormElements = {};

        const dashboardSubjectCheckboxes = document.getElementById('dashboard-subject-checkboxes');
        const todayDateDisplay = document.getElementById('today-date-display');
        const todayLessonsList = document.getElementById('today-lessons-list');
        const todayUnitInfo = document.getElementById('today-unit-info');
        const tomorrowDateDisplay = document.getElementById('tomorrow-date-display');
        const tomorrowLessonsList = document.getElementById('tomorrow-lessons-list');
        const tomorrowUnitInfo = document.getElementById('tomorrow-unit-info');
        const yesterdayDateDisplay = document.getElementById('yesterday-date-display');
        const yesterdayLessonsList = document.getElementById('yesterday-lessons-list');
        const yesterdayUnitInfo = document.getElementById('yesterday-unit-info');

        const studentSelect = document.getElementById('student-select');
        const selectedStudentName = document.getElementById('selected-student-name');
        const studentLessonsList = document.getElementById('student-lessons');
        const studentWorkList = document.getElementById('student-work');
        const studentReflectionNotes = document.getElementById('student-reflections');

        const reflectionPromptTextarea = document.getElementById('reflection-prompt');
        const saveReflectionBtn = document.getElementById('save-reflection-btn');

        const licenseStatusBanner = document.getElementById('license-status');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeButton = document.querySelector('.modal .close-button');

        let calendar; // Main dashboard calendar
        let unitCalendar; // New Unit Only calendar
        let currentLessonId = null;
        let subjectColorMap = {};
        let currentUnitId = null;
        let currentNoSchoolId = null;

        // Helper to convert hex to rgba with opacity (moved to global scope for reuse)
        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            // Handle shorthand hex (e.g., #abc)
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }


        // Utility to get current form elements based on what's in the modal
        // This function must query *modalBody* to get the correct, live elements.
        function getModalFormElements(formType) {
            let elements = {};
            switch(formType) {
                case 'lesson':
                    elements.form = modalBody.querySelector('#lesson-form');
                    elements.lessonTitleInput = modalBody.querySelector('#lesson-title');
                    elements.unitNameSelect = modalBody.querySelector('#unit-name-select');
                    elements.unitNameNewInput = modalBody.querySelector('#unit-name-new-input');
                    elements.taskInput = modalBody.querySelector('#task');
                    elements.subjectClassSelect = modalBody.querySelector('#subject-class');
                    elements.lessonDateInput = modalBody.querySelector('#lesson-date');
                    elements.standardsSelect = modalBody.querySelector('#standards');
                    elements.objectiveTextarea = modalBody.querySelector('#objective');
                    elements.detailedLessonPlanTextarea = modalBody.querySelector('#activities');
                    elements.materialsTextarea = modalBody.querySelector('#materials');
                    elements.differentiationStrategiesCheckboxes = modalBody.querySelector('#differentiation-strategies-checkboxes');
                    elements.differentiationNotesTextarea = modalBody.querySelector('#differentiation-notes');
                    elements.assessmentsTextarea = modalBody.querySelector('#assessments');
                    elements.studentNotesSelect = modalBody.querySelector('#student-notes');
                    elements.studentNotesDetailTextarea = modalBody.querySelector('#student-notes-detail');
                    elements.reflectionNotesTextarea = modalBody.querySelector('#reflection-notes');
                    elements.lessonFileUpload = modalBody.querySelector('#lesson-file-upload');
                    elements.uploadedFilesList = modalBody.querySelector('#uploaded-files-list');
                    elements.saveBtn = modalBody.querySelector('#modal-save-lesson-btn');
                    elements.reuseBtn = modalBody.querySelector('#modal-reuse-lesson-btn');
                    elements.exportBtn = modalBody.querySelector('#modal-export-doc-btn');
                    elements.cancelBtn = modalBody.querySelector('#modal-cancel-lesson-edit');
                    break;
                case 'unit':
                    elements.form = modalBody.querySelector('#unit-form');
                    elements.unitNameInput = modalBody.querySelector('#modal-unit-name-input');
                    elements.unitSubjectSelect = modalBody.querySelector('#modal-unit-subject-select');
                    elements.unitStartDateInput = modalBody.querySelector('#modal-unit-start-date');
                    elements.unitEndDateInput = modalBody.querySelector('#modal-unit-end-date');
                    elements.unitNotesTextarea = modalBody.querySelector('#modal-unit-notes');
                    elements.saveBtn = modalBody.querySelector('#modal-save-unit-btn');
                    elements.cancelBtn = modalBody.querySelector('#modal-cancel-unit-btn');
                    break;
                case 'noschool':
                    elements.form = modalBody.querySelector('#noschool-form');
                    elements.noSchoolStartDateInput = modalBody.querySelector('#modal-noschool-start-date'); // Changed ID
                    elements.noSchoolEndDateInput = modalBody.querySelector('#modal-noschool-end-date');    // Added ID
                    elements.noSchoolReasonInput = modalBody.querySelector('#modal-noschool-reason');
                    elements.saveBtn = modalBody.querySelector('#modal-save-noschool-btn');
                    elements.cancelBtn = modalBody.querySelector('#modal-cancel-noschool-btn');
                    break;
            }
            return elements;
        }


        function showView(viewId) {
            // No showLoader() here, as individual render functions will handle it
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));

            // Corrected line: Directly derive the button ID from the viewId
            let targetButtonId;
            if (viewId === 'dashboard-view') {
                targetButtonId = 'dashboard-btn';
            } else if (viewId === 'unit-view-module') { // This is for your new unit view
                targetButtonId = 'unit-view-btn';
            } else if (viewId === 'student-view-module') {
                targetButtonId = 'student-view-btn';
            } else if (viewId === 'customize-view') {
                targetButtonId = 'customize-btn';
            } else {
                // Fallback for any other view if needed, but above are explicit
                targetButtonId = viewId.replace('-view-module', '-btn').replace('-view', '-btn');
            }

            const targetButton = document.getElementById(targetButtonId);
            if (targetButton) {
                targetButton.classList.add('active');
            } else {
                console.error(`[showView Error] Could not find navigation button with ID: ${targetButtonId} for view: ${viewId}`);
            }

            console.log(`[View] Showing view: ${viewId}`);
            if (addDropdownMenuElement) {
                addDropdownMenuElement.classList.remove('active');
            }
            // Loader will be hidden in the respective render/load functions of the views
        }

        function showModal(title, contentHtml, confirmCallback = null) {
            console.log('[Modal] showModal called with:', { title: title, hasConfirmCallback: confirmCallback !== null });

            modalBody.innerHTML = ''; // Clear previous content
            modalTitle.textContent = title;

            if (contentHtml instanceof HTMLElement) {
                modalBody.appendChild(contentHtml);
            } else {
                modalBody.innerHTML = contentHtml;
            }

            modal.style.display = 'flex'; // Show modal

            const modalContentDiv = modal.querySelector('.modal-content');
            if (modalContentDiv) {
                // Remove all previous click listeners on modalContentDiv to prevent conflicts
                // This is a more robust way to ensure only one listener is active.
                // We'll use a custom property to store references to listeners.
                if (modalContentDiv.__eventListeners) {
                    modalContentDiv.__eventListeners.forEach(listener => {
                        modalContentDiv.removeEventListener(listener.type, listener.handler, listener.useCapture);
                    });
                }
                modalContentDiv.__eventListeners = []; // Reset the stored listeners array

                // Attach a new click listener in the bubbling phase.
                // This stops clicks *inside* the modal from affecting elements *outside* the modal
                // (like the window.onclick listener that closes the modal overlay).
                // It ensures that clicks on buttons/inputs within the modal are processed first.
                const newModalContentClickListener = (e) => {
                    e.stopPropagation();
                    console.log('[Modal] Click inside modal content handled (bubbling phase), propagation stopped to outer elements.');
                };
                modalContentDiv.addEventListener('click', newModalContentClickListener, false); // 'false' for bubbling phase
                modalContentDiv.__eventListeners.push({ type: 'click', handler: newModalContentClickListener, useCapture: false });
            }

            const modalConfirmBtn = modal.querySelector('#modal-confirm-btn');
            const modalCancelBtn = modal.querySelector('#modal-cancel-btn');

            if (modalConfirmBtn) modalConfirmBtn.style.display = confirmCallback ? 'inline-block' : 'none';
            if (modalCancelBtn) modalCancelBtn.textContent = confirmCallback ? 'Cancel' : 'Ok';

            // IMPORTANT: Clear previous direct onclick assignments to prevent multiple firings
            if (modalConfirmBtn) modalConfirmBtn.onclick = null;
            if (modalCancelBtn) modalCancelBtn.onclick = null;
            if (closeButton) closeButton.onclick = null;


            const handleClose = () => {
                modal.style.display = 'none';
                console.log('[Modal] Modal closed.');
                // Removing content here can sometimes cause issues if elements are still being referenced
                // It's often safer to just let the next showModal overwrite innerHTML
                // if (modalBody.firstChild && modalBody.firstChild.nodeType === 1) {
                //      modalBody.removeChild(modalBody.firstChild);
                // }
            };

            if (modalConfirmBtn) {
                modalConfirmBtn.onclick = () => {
                    if (confirmCallback) confirmCallback();
                    handleClose();
                };
            }
            if (modalCancelBtn) {
                console.log('[DEBUG] Attaching handler to modalCancelBtn:', modalCancelBtn);
                modalCancelBtn.onclick = handleClose;
            }
            if (closeButton) {
                console.log('[DEBUG] Attaching handler to closeButton (X):', closeButton);
                closeButton.onclick = handleClose;
            }

            // Ensure the add dropdown menu is closed when any other modal opens
            if (addDropdownMenuElement) {
                addDropdownMenuElement.classList.remove('active');
            }
        }


        function clearLessonFormInModal() {
            const elements = currentLessonFormElements;
            if (elements.form) elements.form.reset();
            if (elements.standardsSelect) elements.standardsSelect.innerHTML = '';
            // Clear differentiation strategies checkboxes
            if (elements.differentiationStrategiesCheckboxes) {
                elements.differentiationStrategiesCheckboxes.innerHTML = '';
                elements.differentiationStrategiesCheckboxes.dataset.hasBeenPopulated = 'false'; // Reset flag
            }
            if (elements.studentNotesSelect) elements.studentNotesSelect.innerHTML = '';
            if (elements.uploadedFilesList) elements.uploadedFilesList.innerHTML = '';
            currentLessonId = null;

            if (elements.unitNameSelect) elements.unitNameSelect.value = '';
            if (elements.unitNameNewInput) {
                elements.unitNameNewInput.value = '';
                elements.unitNameNewInput.style.display = 'none';
            }

            modalBody.querySelectorAll('.optional-field-group').forEach(group => {
                group.style.display = 'none';
            });
            modalBody.querySelectorAll('.toggle-field-btn').forEach(button => {
                const descriptiveText = button.dataset.descriptiveText;
                if (descriptiveText) {
                    button.innerHTML = `<i class="fas fa-plus"></i> Add ${descriptiveText}`;
                }
            });
            console.log('[Lesson Form] Lesson form in modal cleared.');
        }

        function clearUnitFormInModal() {
            const elements = currentUnitFormElements;
            if (elements.form) elements.form.reset();
            currentUnitId = null;
            if (elements.saveBtn) elements.saveBtn.textContent = 'Save Unit';
            console.log('[Unit Form] Unit form in modal cleared.');
        }

        function clearNoSchoolFormInModal() {
            const elements = currentNoSchoolFormElements;
            if (elements.form) elements.form.reset();
            currentNoSchoolId = null;
            if (elements.saveBtn) elements.saveBtn.textContent = 'Add No-School Day(s)'; // Update button text
            console.log('[No-School Form] No-School form in modal cleared.');
        }


        function getSelectedSubjects() {
            const selected = [];
            document.querySelectorAll('#dashboard-subject-checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selected.push(checkbox.value);
            });
            console.log('[Dashboard Filters] Selected subjects:', selected);
            return selected;
        }

        async function populateDropdowns() {
            console.log('[Dropdowns] Starting populateDropdowns...');
            // Loader managed by runScriptAsPromise
            try {
                console.log('[Dropdowns] Calling getDropdownOptions...');
                const dropdownData = await runScriptAsPromise('getDropdownOptions');
                console.log('[Dropdowns] Received dropdownData:', dropdownData);
                const dropdownMap = dropdownData.reduce((acc, row) => {
                    if (!acc[row.type]) acc[row.type] = [];
                    acc[row.type].push(row);
                    return acc;
                }, {});

                // Populate dashboard subject checkboxes
                dashboardSubjectCheckboxes.innerHTML = '';
                subjectColorMap = {}; // Reset subject color map
                (dropdownMap['Subjects'] || []).forEach(subject => {
                    subjectColorMap[subject.value] = subject.color || '#607D8B';
                    const label = document.createElement('label');
                    label.className = 'subject-checkbox-item';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = subject.value;
                    checkbox.checked = true;
                    if (!checkbox.dataset.listenerAdded) {
                        checkbox.addEventListener('change', () => {
                            // When filters change, refetch both calendars if they exist
                            if (calendar) calendar.refetchEvents();
                            if (unitCalendar) unitCalendar.refetchEvents(); // NEW: Refetch unit calendar
                            updateDailyLessonSummaries();
                        });
                        checkbox.dataset.listenerAdded = true;
                    }
                    const span = document.createElement('span');
                    span.textContent = subject.value;
                    span.style.color = subjectColorMap[subject.value];
                    span.style.fontWeight = 'bold';
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    dashboardSubjectCheckboxes.appendChild(label);
                });
                console.log('[Dropdowns] Populated dashboardSubjectCheckboxes.');

                // Populate student selects on main page (student view)
                console.log('[Dropdowns] Calling getStudents...');
                const students = await runScriptAsPromise('getStudents');
                populateSelect(studentSelect, students.map(s => s.Name), [], true);
                console.log('[Dropdowns] Populated student selects (for Student View).');

                console.log('[Dropdowns] populateDropdowns finished successfully.');
            } catch (error) {
                console.error('[Dropdowns Error] Failed to populate dropdowns:', error);
                showModal('Error', 'Failed to populate dropdowns: ' + error.message);
                throw error;
            }
        }

        function populateSelect(selectElement, options, selectedValues = [], prependEmpty = false) {
            if (!selectElement) {
                console.warn('[populateSelect] selectElement is null or undefined. Skipping population.');
                return;
            }
            selectElement.innerHTML = '';
            if (prependEmpty) {
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Select...';
                selectElement.appendChild(emptyOption);
            }
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                if (selectedValues.includes(optionText)) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
            console.log(`[populateSelect] Populated ${selectElement.id} with ${options.length} options. Selected: ${selectedValues.join(', ')}`);
        }

        function populateCheckboxes(containerElement, options, selectedValues = []) {
            if (!containerElement) {
                console.warn('[populateCheckboxes] Container element is null or undefined. Skipping population.');
                return;
            }
            containerElement.innerHTML = '';
            options.forEach(optionText => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = optionText;
                if (selectedValues.includes(optionText)) {
                    checkbox.checked = true;
                }
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(optionText));
                containerElement.appendChild(label);
            });
            console.log(`[populateCheckboxes] Populated ${containerElement.id} with ${options.length} checkboxes. Selected: ${selectedValues.join(', ')}`);
            containerElement.dataset.hasBeenPopulated = 'true';
        }


        async function updateDailyLessonSummaries() {
            console.log('[Daily Summary] Starting updateDailyLessonSummaries...');
            // Loader managed by runScriptAsPromise
            try {
                const subjects = getSelectedSubjects();
                const today = moment('2025-08-15'); // Fixed date for mockup
                const tomorrow = moment(today).add(1, 'days');
                const yesterday = moment(today).subtract(1, 'days');

                todayDateDisplay.textContent = today.format('MMMM D, YYYY');
                tomorrowDateDisplay.textContent = tomorrow.format('MMMM D, YYYY');
                yesterdayDateDisplay.textContent = yesterday.format('MMMM D, YYYY');

                await Promise.all([
                    populateSummarySection(todayLessonsList, todayUnitInfo, today.format('YYYY-MM-DD'), subjects, 'Today'),
                    populateSummarySection(tomorrowLessonsList, tomorrowUnitInfo, tomorrow.format('YYYY-MM-DD'), subjects, 'Tomorrow'),
                    populateSummarySection(yesterdayLessonsList, yesterdayUnitInfo, yesterday.format('YYYY-MM-DD'), subjects, 'Yesterday')
                ]);
                console.log('[Daily Summary] All daily summaries updated successfully.');
            } catch (error) {
                console.error('[Daily Summary Error] Failed to update one or more daily summaries:', error);
            }
        }

        async function populateSummarySection(ulElement, pElement, dateStr, subjects, label) {
            console.log(`[Summary Section] Populating ${label} for date ${dateStr} with subjects ${subjects.join(',') || 'All'}...`);
            ulElement.innerHTML = '<li>Loading...</li>';
            pElement.textContent = ''; // Clear previous unit info
            try {
                console.log(`[Summary Section] Calling getLessonsAndUnitsForSummary for ${label}...`);
                // Use the new combined backend function
                const result = await runScriptAsPromise('getLessonsAndUnitsForSummary', dateStr, subjects);

                // Add defensive checks and default values for destructuring
                const lessons = result?.lessons || []; // Use optional chaining and default empty array
                const units = result?.units || [];
                const noSchoolDays = result?.noSchoolDays || [];

                console.log(`[Calendar Click Handler] Lessons for date:`, lessons);
                console.log(`[Calendar Click Handler] Units for context:`, units);
                console.log(`[Calendar Click Handler] NoSchoolDays for context:`, noSchoolDays);

                ulElement.innerHTML = '';
                if (lessons.length > 0) {
                    for (const lesson of lessons) {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${lesson.LessonTitle} (${lesson.SubjectClass})</strong>${lesson.Task ? ' - Task: ' + lesson.Task : ''}`;
                        ulElement.appendChild(li);
                    }
                } else {
                    ulElement.innerHTML = `<li>No lessons planned for ${label}.</li>`;
                }

                // Display Unit Info for Today's Summary
                // Ensure lessons[0] exists before accessing its properties
                if (label === 'Today' && lessons.length > 0 && lessons[0].UnitName) {
                    // Find the unit details from the fetched units
                    const unitDetail = units.find(unit =>
                        unit.UnitName === lessons[0].UnitName && unit.Subject === lessons[0].SubjectClass
                    );

                    if (unitDetail) {
                        const todayMoment = moment('2025-08-15'); // Fixed date for mockup
                        const unitEndMoment = moment(unitDetail.EndDate);

                        // Only calculate remaining days if unit hasn't ended or ends today/future
                        if (unitEndMoment.isSameOrAfter(todayMoment, 'day')) {
                               // Call backend to calculate remaining working days *from today*
                            const remainingWorkingDays = await runScriptAsPromise('getRemainingWorkingDays', unitDetail.EndDate);
                            pElement.textContent = `Unit: ${unitDetail.UnitName} (Ends: ${unitEndMoment.format('MMMM D, YYYY')}, Remaining Working Days: ${remainingWorkingDays})`;
                            console.log(`[Summary Section] Found unit detail for ${label}:`, unitDetail, `Remaining: ${remainingWorkingDays}`);
                        } else {
                            pElement.textContent = `Unit: ${unitDetail.UnitName} (Ended on ${unitEndMoment.format('MMMM D, YYYY')})`;
                            console.log(`[Summary Section] Unit ended for ${label}:`, unitDetail);
                        }
                    } else {
                        pElement.textContent = `Unit: ${lessons[0].UnitName} (Details not available)`;
                        console.warn(`[Summary Section] Unit detail not found for ${lessons[0].UnitName} in fetched units.`);
                    }
                } else {
                    // Clear unit info if no lessons, no unit name, or not today's summary
                    pElement.textContent = '';
                }
                console.log(`[Summary Section] Finished populating ${label}.`);

            } catch (error) {
                console.error(`[Summary Section Error] Error loading lessons for ${label}:`, error);
                ulElement.innerHTML = `<li>Error loading lessons for ${label}: ${error.message}</li>`;
            }
        }


        // --- Navigation Button Event Listeners ---
        dashboardBtn.addEventListener('click', () => {
            showView('dashboard-view');
            renderCalendar(); // Render main calendar
            updateDailyLessonSummaries();
        });
        unitViewBtn.addEventListener('click', () => { // NEW: Unit View Button
            showView('unit-view-module');
            renderUnitCalendar(); // Render unit-only calendar
        });
        studentViewBtn.addEventListener('click', async () => { // Added async for cleaner flow
            showView('student-view-module');
            // No direct showLoader/hideLoader here, populateDropdowns will trigger it
            await populateDropdowns(); // Ensure dropdowns are populated before student select interaction
            if (studentSelect.value) { // Trigger load for initial student if selected
                 studentSelect.dispatchEvent(new Event('change'));
            } else if (MOCK_DATA.students.length > 0) { // Select first student if available
                studentSelect.value = MOCK_DATA.students[0].Name;
                studentSelect.dispatchEvent(new Event('change'));
            }
        });
        customizeBtn.addEventListener('click', async () => { // Added async for cleaner flow
            showView('customize-view');
            // No direct showLoader/hideLoader here, loadSettings will trigger it
            await loadSettings();
        });

        // --- MODAL FORM FUNCTIONS ---

        async function openLessonModal(lessonId = null, initialDate = null, isReuse = false) {
            // Loader managed by runScriptAsPromise calls
            try {
                const clonedContent = lessonFormContentTemplate.cloneNode(true);
                clonedContent.style.display = 'block';

                let modalTitleText = "New Lesson Plan";
                if (lessonId) {
                    modalTitleText = "Edit Lesson Plan";
                }
                showModal(modalTitleText, clonedContent);

                // CRITICAL: Get references to the *live* elements AFTER showModal has rendered them
                currentLessonFormElements = getModalFormElements('lesson');

                const [dropdownData, unitObjects, students] = await Promise.all([
                    runScriptAsPromise('getDropdownOptions'),
                    runScriptAsPromise('getUnits'),
                    runScriptAsPromise('getStudents')
                ]);
                console.log('[openLessonModal] Fetched all necessary data for dropdowns/checkboxes.');

                const dropdownMap = dropdownData.reduce((acc, row) => {
                    if (!acc[row.type]) acc[row.type] = [];
                    acc[row.type].push(row);
                    return acc;
                }, {});

                const unitNames = unitObjects.map(u => u.UnitName);
                populateSelect(currentLessonFormElements.unitNameSelect, ['Add New...'].concat(unitNames), [], true);

                const subjectsForForm = (dropdownMap['Subjects'] || []).map(item => item.value);
                populateSelect(currentLessonFormElements.subjectClassSelect, subjectsForForm);

                populateSelect(currentLessonFormElements.studentNotesSelect, students.map(s => s.Name));

                if (lessonId) {
                    await loadLessonForEditInModal(lessonId, isReuse);
                } else {
                    clearLessonFormInModal();
                    if (currentLessonFormElements.lessonDateInput) {
                        currentLessonFormElements.lessonDateInput.value = initialDate || moment().format('YYYY-MM-DD');
                    }
                    const differentiationStrategiesForForm = (dropdownMap['Differentiation Strategies'] || []).map(item => item.value);
                    populateCheckboxes(currentLessonFormElements.differentiationStrategiesCheckboxes, differentiationStrategiesForForm);
                }

                // Ensure listeners are attached to the correct, currently active form instance
                if (currentLessonFormElements.form) {
                    currentLessonFormElements.form.removeEventListener('submit', handleLessonFormSubmit);
                    currentLessonFormElements.form.addEventListener('submit', handleLessonFormSubmit);
                }

                if (currentLessonFormElements.reuseBtn) {
                    currentLessonFormElements.reuseBtn.removeEventListener('click', handleReuseLesson);
                    currentLessonFormElements.reuseBtn.addEventListener('click', handleReuseLesson);
                }
                if (currentLessonFormElements.exportBtn) {
                    currentLessonFormElements.exportBtn.removeEventListener('click', handleExportLesson);
                    currentLessonFormElements.exportBtn.addEventListener('click', handleExportLesson);
                }
                if (currentLessonFormElements.cancelBtn) {
                    currentLessonFormElements.cancelBtn.removeEventListener('click', handleCancelLessonEdit);
                    currentLessonFormElements.cancelBtn.addEventListener('click', handleCancelLessonEdit);
                }

                modalBody.querySelectorAll('.toggle-field-btn').forEach(button => {
                    const groupId = button.dataset.target;
                    let descriptiveText = '';
                    if (groupId === 'detailed-lesson-plan-group') {
                        descriptiveText = 'Detailed Lesson Plan';
                    } else if (groupId === 'standards-group') {
                        descriptiveText = 'Standards';
                    } else if (groupId === 'materials-group') {
                        descriptiveText = 'Materials';
                    } else if (groupId === 'differentiation-group') {
                        descriptiveText = 'Differentiation Options';
                    } else if (groupId === 'assessments-group') {
                        descriptiveText = 'Assessments';
                    } else if (groupId === 'student-notes-group') {
                        descriptiveText = 'Student-Specific Notes';
                    } else if (groupId === 'reflection-upload-group') {
                        descriptiveText = 'Reflection & File Uploads';
                    }
                    button.dataset.descriptiveText = descriptiveText;

                    const targetGroup = modalBody.querySelector(`#${groupId}`);
                    if (targetGroup && targetGroup.style.display === 'block') {
                            button.innerHTML = `<i class="fas fa-minus"></i> Hide ${descriptiveText}`;
                    } else {
                            button.innerHTML = `<i class="fas fa-plus"></i> Add ${descriptiveText}`;
                    }

                    button.removeEventListener('click', handleToggleField);
                    button.addEventListener('click', handleToggleField);
                });

                if (currentLessonFormElements.unitNameSelect && !currentLessonFormElements.unitNameSelect.dataset.listenerAdded) {
                    currentLessonFormElements.unitNameSelect.addEventListener('change', () => {
                        if (currentLessonFormElements.unitNameSelect.value === 'Add New...') {
                            currentLessonFormElements.unitNameNewInput.style.display = 'block';
                            currentLessonFormElements.unitNameNewInput.focus();
                        } else {
                            currentLessonFormElements.unitNameNewInput.style.display = 'none';
                        }
                    });
                    currentLessonFormElements.unitNameSelect.dataset.listenerAdded = true;
                }

                if (currentLessonFormElements.subjectClassSelect && !currentLessonFormElements.subjectClassSelect.dataset.listenerAdded) {
                    currentLessonFormElements.subjectClassSelect.addEventListener('change', async () => {
                        const selectedSubject = currentLessonFormElements.subjectClassSelect.value;
                        if (selectedSubject) {
                            try {
                                const standards = await runScriptAsPromise('getStandardsBySubject', selectedSubject);
                                populateSelect(currentLessonFormElements.standardsSelect, standards);
                                currentLessonFormElements.standardsSelect.dataset.hasBeenPopulated = 'true';
                            } catch (error) {
                                showModal('Error', 'Failed to load standards: ' + error.message);
                            }
                        } else {
                            currentLessonFormElements.standardsSelect.innerHTML = '';
                        }
                    });
                    currentLessonFormElements.subjectClassSelect.dataset.listenerAdded = true;
                }

            } catch (error) {
                console.error('[Open Lesson Modal Error]', error);
                showModal('Error', 'Failed to open lesson form: ' + error.message);
            }
        }

        async function loadLessonForEditInModal(lessonId, isReuse = false) {
            console.log('[Load Lesson In Modal] Attempting to load lesson for edit/reuse with ID:', lessonId, 'isReuse:', isReuse);

            try {
                const lesson = await runScriptAsPromise('getLessonById', lessonId);
                if (lesson) {
                    currentLessonId = isReuse ? null : lesson.ID;
                    currentLessonFormElements.lessonTitleInput.value = isReuse ? `(REUSED) ${lesson.LessonTitle}` : lesson.LessonTitle;
                    currentLessonFormElements.taskInput.value = lesson.Task;
                    currentLessonFormElements.lessonDateInput.value = isReuse ? moment().format('YYYY-MM-DD') : lesson.Date;

                    const unitObjects = await runScriptAsPromise('getUnits');
                    const unitNames = unitObjects.map(u => u.UnitName);
                    populateSelect(currentLessonFormElements.unitNameSelect, ['Add New...'].concat(unitNames), [], true);

                    if (lesson.UnitName && unitNames.includes(lesson.UnitName)) {
                        currentLessonFormElements.unitNameSelect.value = lesson.UnitName;
                        currentLessonFormElements.unitNameNewInput.style.display = 'none';
                    } else if (lesson.UnitName && String(lesson.UnitName).trim() !== '') {
                        currentLessonFormElements.unitNameSelect.value = 'Add New...';
                        currentLessonFormElements.unitNameNewInput.value = lesson.UnitName;
                        currentLessonFormElements.unitNameNewInput.style.display = 'block';
                    } else {
                        currentLessonFormElements.unitNameSelect.value = '';
                        currentLessonFormElements.unitNameNewInput.style.display = 'none';
                    }

                    const dropdownData = await runScriptAsPromise('getDropdownOptions');
                    const dropdownMap = dropdownData.reduce((acc, row) => {
                        if (!acc[row.type]) acc[row.type] = [];
                        acc[row.type].push(row);
                        return acc;
                    }, {});

                    populateSelect(currentLessonFormElements.subjectClassSelect, (dropdownMap['Subjects'] || []).map(item => item.value), [lesson.SubjectClass]);

                    const standards = await runScriptAsPromise('getStandardsBySubject', lesson.SubjectClass);
                    populateSelect(currentLessonFormElements.standardsSelect, standards, lesson.Standards.split(', ').filter(s => s));
                    currentLessonFormElements.standardsSelect.dataset.hasBeenPopulated = 'true';


                    const allDiffStrategies = (dropdownMap['Differentiation Strategies'] || []).map(item => item.value);
                    const selectedDiffStrategies = lesson.DifferentiationStrategies ? lesson.DifferentiationStrategies.split(', ').filter(s => s.trim() !== '') : [];
                    populateCheckboxes(currentLessonFormElements.differentiationStrategiesCheckboxes, allDiffStrategies, selectedDiffStrategies);


                    const students = await runScriptAsPromise('getStudents');
                    populateSelect(currentLessonFormElements.studentNotesSelect, students.map(s => s.Name), lesson.StudentNotes ? lesson.StudentNotes.split(', ').filter(s => s) : []);
                    currentLessonFormElements.studentNotesSelect.dataset.hasBeenPopulated = 'true';


                    currentLessonFormElements.objectiveTextarea.value = lesson.Objective;
                    currentLessonFormElements.detailedLessonPlanTextarea.value = lesson.Activities;
                    currentLessonFormElements.materialsTextarea.value = lesson.Materials;
                    currentLessonFormElements.differentiationNotesTextarea.value = lesson.DifferentiationNotes;
                    currentLessonFormElements.assessmentsTextarea.value = lesson.Assessments;
                    currentLessonFormElements.studentNotesDetailTextarea.value = lesson.StudentNotesDetail;
                    currentLessonFormElements.reflectionNotesTextarea.value = lesson.ReflectionNotes;

                    if (lesson.Activities && String(lesson.Activities).trim() !== '') {
                        toggleOptionalField('detailed-lesson-plan-group', true, currentLessonFormElements.form);
                    }
                    if (lesson.Standards && String(lesson.Standards).trim() !== '') {
                        toggleOptionalField('standards-group', true, currentLessonFormElements.form);
                    }
                    if (lesson.Materials && String(lesson.Materials).trim() !== '') {
                        toggleOptionalField('materials-group', true, currentLessonFormElements.form);
                    }
                    if ((lesson.DifferentiationStrategies && String(lesson.DifferentiationStrategies).trim() !== '') || (lesson.DifferentiationNotes && String(lesson.DifferentiationNotes).trim() !== '')) {
                        toggleOptionalField('differentiation-group', true, currentLessonFormElements.form);
                    }
                    if (lesson.Assessments && String(lesson.Assessments).trim() !== '') {
                        toggleOptionalField('assessments-group', true, currentLessonFormElements.form);
                    }
                    if ((lesson.StudentNotes && String(lesson.StudentNotes).trim() !== '') || (lesson.StudentNotesDetail && String(lesson.StudentNotesDetail).trim() !== '')) {
                        toggleOptionalField('student-notes-group', true, currentLessonFormElements.form);
                    }
                    if ((lesson.ReflectionNotes && String(lesson.ReflectionNotes).trim() !== '') || (lesson.Attachments && lesson.Attachments.length > 0)) {
                        toggleOptionalField('reflection-upload-group', true, currentLessonFormElements.form);
                    }

                    if (!isReuse && lesson.Attachments && lesson.Attachments.length > 0) {
                        currentLessonFormElements.uploadedFilesList.innerHTML = '<h4>Attached Files:</h4>';
                        lesson.Attachments.forEach(file => {
                            const fileLink = document.createElement('p');
                            fileLink.innerHTML = `<a href="${file.Url}" target="_blank"><i class="fas fa-paperclip"></i> ${file.FileName}</a>`;
                            currentLessonFormElements.uploadedFilesList.appendChild(fileLink);
                        });
                    } else {
                        currentLessonFormElements.uploadedFilesList.innerHTML = '';
                    }

                } else {
                    console.warn('[Load Lesson In Modal] Lesson not found for ID:', lessonId);
                    showModal('Error', 'Lesson not found.');
                }
            } catch (error) {
                console.error('[Load Lesson In Modal Error] Failed to load lesson:', error);
                showModal('Error', 'Failed to load lesson: ' + error.message);
            }
        }

        async function handleLessonFormSubmit(e) {
            e.preventDefault();
            console.log('[Save Lesson Modal] Form submitted.');
            const elements = currentLessonFormElements;

            if (!elements.saveBtn || !elements.lessonTitleInput || !elements.subjectClassSelect || !elements.lessonDateInput) {
                showModal('Error', 'Form elements not properly initialized. Please refresh.');
                console.error('[Save Lesson Modal Error] Critical form elements missing:', elements);
                return;
            }

            elements.saveBtn.disabled = true;
            elements.saveBtn.textContent = 'Saving...';

            let selectedUnitName = elements.unitNameSelect.value;
            if (selectedUnitName === 'Add New...') {
                selectedUnitName = elements.unitNameNewInput.value.trim();
                if (!selectedUnitName) {
                    showModal('Validation Error', 'Please enter a name for the new unit.');
                    elements.saveBtn.disabled = false;
                    elements.saveBtn.textContent = 'Save Lesson';
                    return;
                }
            }

            const selectedStrategies = Array.from(elements.differentiationStrategiesCheckboxes.querySelectorAll('input[type="checkbox"]:checked'))
                                                     .map(checkbox => checkbox.value)
                                                     .join(', ');

            const lessonData = {
                id: currentLessonId,
                title: elements.lessonTitleInput.value,
                unitName: selectedUnitName,
                task: elements.taskInput.value,
                subjectClass: elements.subjectClassSelect.value,
                date: elements.lessonDateInput.value,
                standards: Array.from(elements.standardsSelect.selectedOptions).map(opt => opt.value).join(', '),
                objective: elements.objectiveTextarea.value,
                activities: elements.detailedLessonPlanTextarea.value,
                materials: elements.materialsTextarea.value,
                differentiationStrategies: selectedStrategies,
                differentiationNotes: elements.differentiationNotesTextarea.value,
                assessments: elements.assessmentsTextarea.value,
                studentNotes: Array.from(elements.studentNotesSelect.selectedOptions).map(opt => opt.value).join(', '),
                studentNotesDetail: elements.studentNotesDetailTextarea.value,
                reflectionNotes: elements.reflectionNotesTextarea.value
            };

            try {
                const newLessonId = await runScriptAsPromise('saveLesson', lessonData);
                currentLessonId = newLessonId;
                if (elements.lessonFileUpload.files.length > 0) {
                    await uploadFiles(newLessonId, elements.lessonFileUpload, elements.subjectClassSelect.value, elements.lessonDateInput.value);
                }
                showModal('Success', 'Lesson saved successfully!', () => {
                    modal.style.display = 'none';
                    renderCalendar();
                    updateDailyLessonSummaries();
                });

            } catch (error) {
                showModal('Error', 'Failed to save lesson: ' + error.message);
            } finally { // This finally is okay because it's local to the async function
                elements.saveBtn.disabled = false;
                elements.saveBtn.textContent = 'Save Lesson';
            }
        }

        async function uploadFiles(lessonId, fileInput, subjectClass, lessonDate) {
            const files = fileInput.files;
            if (files.length === 0) return;

            const fileDataPromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve({
                            fileName: file.name,
                            mimeType: file.type,
                            data: e.target.result.split(',')[1]
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });

            try {
                const fileUploads = await Promise.all(fileDataPromises);
                await runScriptAsPromise('uploadLessonFiles', {
                    lessonId: lessonId,
                    subjectClass: subjectClass,
                    lessonDate: lessonDate,
                    files: fileUploads
                });
                console.log('[Upload Files] Files uploaded successfully.');
            } catch (error) {
                console.error('[Upload Files Error] Error during file upload:', error);
                throw new Error('Error uploading files: ' + error.message);
            }
        }

        function handleReuseLesson() {
            showModal('Reuse Past Lesson', `
                <p>Enter the ID of the lesson to reuse, or select from a past date/subject.</p>
                <div class="form-group">
                    <label for="reuse-lesson-id">Lesson ID (optional):</label>
                    <input type="text" id="reuse-lesson-id" placeholder="Enter lesson ID">
                </div>
                <div class="form-group">
                    <label for="reuse-date">Or select Date:</label>
                    <input type="date" id="reuse-date">
                </div>
                <div class="form-group">
                    <label for="reuse-subject">And Subject:</label>
                    <select id="reuse-subject"></select>
                </div>
                <button id="find-reuse-lesson" class="btn secondary-btn">Find Lesson</button>
                <div id="reuse-results"></div>
            `, null);

            runScriptAsPromise('getDropdownOptionsByType', 'Subjects').then(subjects => {
                populateSelect(document.getElementById('reuse-subject'), subjects);
            }).catch(error => {
                console.error('[Reuse Lesson Error] Failed to load subjects for reuse:', error);
                showModal('Error', 'Failed to load subjects for this section: ' + error.message);
            });

            document.getElementById('find-reuse-lesson').onclick = async () => {
                const reuseId = document.getElementById('reuse-lesson-id').value;
                const reuseDate = document.getElementById('reuse-date').value;
                const reuseSubject = document.getElementById('reuse-subject').value;
                const reuseResultsDiv = document.getElementById('reuse-results');
                reuseResultsDiv.innerHTML = 'Searching...';

                try {
                    const lessons = await runScriptAsPromise('getLessonsForReuse', reuseId, reuseDate, reuseSubject);
                    if (lessons.length > 0) {
                        reuseResultsDiv.innerHTML = '<h4>Select a lesson to load:</h4>';
                        lessons.forEach(lesson => {
                            const lessonItem = document.createElement('div');
                            lessonItem.classList.add('reuse-item');
                            lessonItem.innerHTML = `
                                <p><strong>${lesson.Title}</strong> - ${lesson.Date} (${lesson.SubjectClass})</p>
                                <button data-lesson-id="${lesson.ID}" class="btn small-btn load-reuse-lesson-from-search">Load</button>
                            `;
                            reuseResultsDiv.appendChild(lessonItem);
                        });
                        document.querySelectorAll('.load-reuse-lesson-from-search').forEach(button => {
                            button.onclick = (e) => {
                                console.log('[Calendar Modal] Adding new lesson from calendar date.');
                                modal.style.display = 'none';
                                openLessonModal(e.target.dataset.lessonId, null, true);
                            };
                        });
                    } else {
                        reuseResultsDiv.innerHTML = '<p>No lessons found with the criteria.</p>';
                    }
                } catch (error) {
                    console.error('[Reuse Lesson Error] Error searching for lessons:', error);
                    reuseResultsDiv.innerHTML = '<p>Error searching for lessons: ' + error.message + '</p>';
                }
            };
        }

        async function handleExportLesson() {
            if (!currentLessonId) {
                showModal('Error', 'Please save the lesson first before exporting.');
                return;
            }
            const elements = currentLessonFormElements;
            if (!elements.exportBtn) return;

            elements.exportBtn.disabled = true;
            elements.exportBtn.textContent = 'Exporting...';
            try {
                const docUrl = await runScriptAsPromise('exportLessonAsGoogleDoc', currentLessonId);
                showModal('Export Complete', `Lesson exported successfully! <a href="${docUrl}" target="_blank">Open Google Doc</a>`);
            } catch (error) {
                showModal('Error', 'Failed to export lesson: ' + error.message);
            } finally {
                elements.exportBtn.disabled = false;
                elements.exportBtn.textContent = 'Export as Google Doc';
            }
        }

        function handleCancelLessonEdit() {
            modal.style.display = 'none';
        }

        async function openUnitModal(unitId = null) {
            // Loader managed by runScriptAsPromise
            try {
                const clonedContent = unitFormContentTemplate.cloneNode(true);
                clonedContent.style.display = 'block';

                let modalTitleText = "New Unit";
                if (unitId) {
                    modalTitleText = "Edit Unit";
                }

                showModal(modalTitleText, clonedContent);

                // CRITICAL: Now get references to the *live* elements from modalBody
                currentUnitFormElements = getModalFormElements('unit');

                // Defensive check: Ensure form element was found
                if (!currentUnitFormElements.form) {
                    throw new Error("Unit form element not found in modal. Cannot proceed with listener attachment.");
                }

                const subjects = await runScriptAsPromise('getDropdownOptionsByType', 'Subjects');
                populateSelect(currentUnitFormElements.unitSubjectSelect, subjects, [], true);

                if (unitId) {
                    await loadUnitForEditInModal(unitId);
                } else {
                    clearUnitFormInModal();
                    if (currentUnitFormElements.unitStartDateInput) {
                        currentUnitFormElements.unitStartDateInput.value = moment().format('YYYY-MM-DD');
                    }
                    if (currentUnitFormElements.unitEndDateInput) {
                        currentUnitFormElements.unitEndDateInput.value = moment().add(1, 'month').format('YYYY-MM-DD');
                    }
                }

                // Ensure listeners are added to the correct, currently active form instance
                // Remove previous listeners to prevent multiple attachments
                currentUnitFormElements.form.removeEventListener('submit', handleUnitFormSubmit);
                currentUnitFormElements.form.addEventListener('submit', handleUnitFormSubmit);
                console.log('[openUnitModal] Unit form submit listener attached to live element.');


                if (currentUnitFormElements.cancelBtn) {
                    currentUnitFormElements.cancelBtn.removeEventListener('click', () => modal.style.display = 'none');
                    currentUnitFormElements.cancelBtn.addEventListener('click', () => modal.style.display = 'none');
                    console.log('[openUnitModal] Unit form cancel listener attached to live element.');
                }

            } catch (error) {
                console.error('[Open Unit Modal Error]', error);
                showModal('Error', 'Failed to open unit form: ' + error.message);
            }
        }

        async function loadUnitForEditInModal(unitId) {
            console.log('[Load Unit In Modal] Fetching unit for editing, ID:', unitId);
            // Loader managed by runScriptAsPromise
            try {
                const units = await runScriptAsPromise('getUnits');
                const unit = units.find(u => u.ID === unitId);
                if (unit) {
                    currentUnitId = unit.ID;
                    currentUnitFormElements.unitNameInput.value = unit.UnitName;
                    currentUnitFormElements.unitSubjectSelect.value = unit.Subject;
                    currentUnitFormElements.unitStartDateInput.value = unit.StartDate;
                    currentUnitFormElements.unitEndDateInput.value = unit.EndDate;
                    currentUnitFormElements.unitNotesTextarea.value = unit.Notes;
                    if(currentUnitFormElements.saveBtn) currentUnitFormElements.saveBtn.textContent = 'Update Unit';
                    console.log('[Load Unit In Modal] Unit data loaded into form:', unit);
                } else {
                    console.warn('[Load Unit In Modal] Unit not found for ID:', unitId);
                    showModal('Error', 'Unit not found.');
                }
            } catch (error) {
                console.error('[Load Unit In Modal Error] Failed to load unit for editing:', error);
                showModal('Error', 'Failed to load unit for editing: ' + error.message);
            }
        }

        async function handleUnitFormSubmit(e) {
            e.preventDefault();
            console.log('[DEBUG] handleUnitFormSubmit started. Event prevented default.'); // ADDED DEBUG LOG
            const elements = currentUnitFormElements;

            if (!elements.saveBtn || !elements.unitNameInput || !elements.unitSubjectSelect || !elements.unitStartDateInput || !elements.unitEndDateInput) {
                console.error('[Save Unit Modal Error] Critical form elements missing in currentUnitFormElements:', elements); // IMPROVED LOGGING
                showModal('Error', 'Form elements not properly initialized. Please refresh.');
                return; // Exit early if elements are missing
            }

            // Frontend validation for required fields
            if (!elements.unitNameInput.value.trim() || !elements.unitSubjectSelect.value || !elements.unitStartDateInput.value || !elements.unitEndDateInput.value) {
                showModal('Validation Error', 'Unit Name, Subject, Start Date, and End Date are required.');
                // No need to disable/enable save button here as it's not yet disabled
                return;
            }

            elements.saveBtn.disabled = true;
            elements.saveBtn.textContent = 'Saving...';
            console.log('[DEBUG] Save button disabled, text changed to Saving...'); // ADDED DEBUG LOG


            const unitData = {
                id: currentUnitId,
                unitName: elements.unitNameInput.value.trim(),
                subject: elements.unitSubjectSelect.value,
                startDate: elements.unitStartDateInput.value,
                endDate: elements.unitEndDateInput.value,
                notes: elements.unitNotesTextarea.value.trim()
            };
            console.log('[DEBUG] Prepared unitData:', unitData); // ADDED DEBUG LOG

            try {
                console.log('[DEBUG] Calling backend function saveUnit...'); // ADDED DEBUG LOG
                await runScriptAsPromise('saveUnit', unitData);
                console.log('[DEBUG] Backend saveUnit call successful.'); // ADDED DEBUG LOG

                showModal('Success', `Unit "${unitData.unitName}" saved!`, () => {
                    modal.style.display = 'none';
                    renderCalendar(); // Re-render main calendar to show new unit (if it affects it)
                    renderUnitCalendar(); // NEW: Re-render unit calendar as well
                    updateDailyLessonSummaries(); // Update summaries if unit affects them
                });
            } catch (error) {
                showModal('Error', `Failed to save unit: ${error.message}`);
            } finally { // This finally is okay because it's local to the async function
                elements.saveBtn.disabled = false;
                elements.saveBtn.textContent = 'Save Unit';
                console.log('[DEBUG] Save process finished, save button re-enabled.');
            }
        }


        async function openNoSchoolModal(noSchoolId = null) {
            // Loader managed by runScriptAsPromise
            try {
                const clonedContent = noSchoolFormContentTemplate.cloneNode(true);
                clonedContent.style.display = 'block';

                let modalTitleText = "Add No-School Day(s)"; // Updated title
                // Editing existing no-school day is not supported directly in the UI for ranges
                if (noSchoolId) {
                    showModal('Error', 'Editing no-school days is not currently supported for ranges. Please delete and re-add.');
                    return; // Exit here as showModal is called
                }
                showModal(modalTitleText, clonedContent);

                // CRITICAL: Now get references to the *live* elements from modalBody
                currentNoSchoolFormElements = getModalFormElements('noschool');


                clearNoSchoolFormInModal();
                // Set default dates to today
                if (currentNoSchoolFormElements.noSchoolStartDateInput) {
                    currentNoSchoolFormElements.noSchoolStartDateInput.value = moment().format('YYYY-MM-DD');
                }
                if (currentNoSchoolFormElements.noSchoolEndDateInput) {
                    currentNoSchoolFormElements.noSchoolEndDateInput.value = moment().format('YYYY-MM-DD'); // Default end date to today
                }


                // Ensure listeners are added to the correct, currently active form instance
                if (currentNoSchoolFormElements.form) {
                    currentNoSchoolFormElements.form.removeEventListener('submit', handleNoSchoolFormSubmit);
                    currentNoSchoolFormElements.form.addEventListener('submit', handleNoSchoolFormSubmit);
                }

                if (currentNoSchoolFormElements.cancelBtn) {
                    currentNoSchoolFormElements.cancelBtn.removeEventListener('click', () => modal.style.display = 'none');
                    currentNoSchoolFormElements.cancelBtn.addEventListener('click', () => modal.style.display = 'none');
                }

            } catch (error) {
                console.error('[Open No-School Modal Error]', error);
                showModal('Error', 'Failed to open no-school form: ' + error.message);
            }
        }

        async function handleNoSchoolFormSubmit(e) {
            e.preventDefault();
            console.log('[Save No-School Modal] Form submitted.');
            const elements = currentNoSchoolFormElements;

            if (!elements.saveBtn || !elements.noSchoolStartDateInput || !elements.noSchoolReasonInput) {
                showModal('Error', 'Form elements not properly initialized. Please refresh.');
                console.error('[Save No-School Modal Error] Critical form elements missing:', elements);
                return;
            }

            // Get both start and end dates
            const startDate = elements.noSchoolStartDateInput.value;
            // If end date is empty, it's a single day. Otherwise use the provided end date.
            const endDate = elements.noSchoolEndDateInput.value || startDate;

            const noSchoolDayData = {
                id: currentNoSchoolId, // Will be null for new entries
                startDate: startDate,
                endDate: endDate,
                reason: elements.noSchoolReasonInput.value.trim()
            };

            // Validation for dates
            if (!noSchoolDayData.startDate || !noSchoolDayData.reason) {
                showModal('Validation Error', 'Start Date and Reason are required for no-school day(s).');
                return;
            }
            if (moment(noSchoolDayData.endDate).isBefore(moment(noSchoolDayData.startDate))) {
                showModal('Validation Error', 'End Date cannot be before Start Date.');
                return;
            }


            elements.saveBtn.disabled = true;
            elements.saveBtn.textContent = 'Adding...';

            try {
                // Pass both start and end dates to the backend
                await runScriptAsPromise('saveNoSchoolDay', noSchoolDayData);
                showModal('Success', `No-School Day(s) from ${startDate} to ${endDate} added!`, () => {
                    modal.style.display = 'none';
                    renderCalendar(); // Refresh main calendar
                    renderUnitCalendar(); // Refresh unit calendar (if active)
                    updateDailyLessonSummaries(); // Update summaries
                });
            } catch (error) {
                showModal('Error', `Failed to add no-school day(s): ${error.message}`);
            } finally { // This finally is okay because it's local to the async function
                elements.saveBtn.disabled = false;
                elements.saveBtn.textContent = 'Add No-School Day(s)';
            }
        }


        studentSelect.addEventListener('change', async () => {
            console.log('[Student View] Student select changed.'); // Added log
            // Loader managed by populateDropdowns
            const studentName = studentSelect.value;
            selectedStudentName.textContent = studentName;
            studentLessonsList.innerHTML = 'Loading...';
            studentWorkList.innerHTML = 'Loading...';
            studentReflectionNotes.innerHTML = 'Loading...';

            if (!studentName) {
                studentLessonsList.innerHTML = '<li>Please select a student.</li>';
                studentWorkList.innerHTML = '<li></li>';
                studentReflectionNotes.innerHTML = '<li></li>';
                // No hideLoader here, as populateDropdowns handles it.
                return;
            }

            try {
                console.log('[Student View] Calling getStudentTrackingData for student:', studentName);
                const studentData = await runScriptAsPromise('getStudentTrackingData', studentName);
                console.log('[Student View] Received student data:', studentData);
                studentLessonsList.innerHTML = '';
                studentWorkList.innerHTML = '';
                studentReflectionNotes.innerHTML = '';

                if (studentData.lessons.length > 0) {
                    studentData.lessons.forEach(lesson => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${lesson.Title}</strong> (${lesson.Date}): ${lesson.StudentNotesDetail}`;
                        studentLessonsList.appendChild(li);
                    });
                } else {
                    studentLessonsList.innerHTML = '<li>No lessons found for this student.</li>';
                }

                if (studentData.attachments.length > 0) {
                    studentData.attachments.forEach(file => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${file.Url}" target="_blank"><i class="fas fa-file"></i> ${file.FileName}</a> (from ${file.LessonDate})`;
                        studentWorkList.appendChild(li);
                    });
                } else {
                    studentWorkList.innerHTML = '<li>No uploaded work found for this student.</li>';
                }

                if (studentData.reflections.length > 0) {
                    studentData.reflections.forEach(reflection => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${reflection.Date}</strong>: ${reflection.Summary}`;
                        studentReflectionNotes.appendChild(li);
                    });
                } else {
                    studentReflectionNotes.innerHTML = '<li>No reflections found for this student.</li>';
                }
                console.log('[Student View] Student data rendered.');

            } catch (error) {
                console.error('[Student View Error] Failed to load student data:', error);
                showModal('Error', 'Failed to load student data: ' + error.message);
            }
        });

        async function renderCalendar() {
            console.log('[Calendar] Starting renderCalendar (Dashboard View)...');
            const calendarEl = document.getElementById('calendar');

            // Destroy existing calendar instance if it exists
            if (calendar) {
                calendar.destroy();
                console.log('[Calendar] Existing dashboard calendar destroyed.');
            }
            // Destroy unit calendar if it exists and is being switched from
            if (unitCalendar) {
                unitCalendar.destroy();
                unitCalendar = null; // Clear reference
                console.log('[Calendar] Unit calendar destroyed for view switch.');
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                initialDate: '2025-08-01', // Set calendar to start in August 2025
                customButtons: {
                    addBtn: {
                        text: 'Add +',
                        click: function(fcEvent) {
                            console.log('[FullCalendar] Add + button clicked.');

                            if (!addDropdownMenuElement) {
                                addDropdownMenuElement = document.createElement('div');
                                addDropdownMenuElement.id = 'add-dropdown-menu';
                                addDropdownMenuElement.innerHTML = `
                                    <button id="add-lesson-option-fc"><i class="fas fa-plus-circle"></i> New Lesson</button>
                                    <button id="add-unit-option-fc"><i class="fas fa-layer-group"></i> New Unit</button>
                                    <button id="add-noschool-option-fc"><i class="fas fa-calendar-times"></i> New No-School Day(s)</button>
                                `;
                                document.body.appendChild(addDropdownMenuElement);

                                addDropdownMenuElement.querySelector('#add-lesson-option-fc').addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    openLessonModal();
                                    addDropdownMenuElement.classList.remove('active');
                                });
                                addDropdownMenuElement.querySelector('#add-unit-option-fc').addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    openUnitModal();
                                    addDropdownMenuElement.classList.remove('active');
                                });
                                addDropdownMenuElement.querySelector('#add-noschool-option-fc').addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    openNoSchoolModal();
                                    addDropdownMenuElement.classList.remove('active');
                                });

                                console.log('[FullCalendar] Add dropdown menu created and listeners attached.');
                            }

                            const rect = this.getBoundingClientRect();
                            addDropdownMenuElement.style.top = `${rect.bottom + window.scrollY + 5}px`;
                            addDropdownMenuElement.style.left = `${rect.left + window.scrollX}px`;
                            addDropdownMenuElement.style.position = 'absolute';
                            addDropdownMenuElement.style.zIndex = '2001';

                            addDropdownMenuElement.classList.toggle('active');
                            if (fcEvent && typeof fcEvent.stopPropagation === 'function') {
                                fcEvent.stopPropagation();
                            }
                        }
                    }
                },
                headerToolbar: {
                    left: 'addBtn prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                dateClick: async function(info) {
                    await handleCalendarDateOrEventClick(info.dateStr);
                },
                eventClick: async function(info) {
                    console.log('[Calendar Event Click] Event clicked (lesson/noschool). Event ID:', info.event.id);
                    const eventId = info.event.id;

                    // Check if it's a no-school day event first
                    if (String(eventId).startsWith('noschool-')) {
                        const noSchoolId = eventId.replace('noschool-', '');
                        try {
                            const allNoSchoolDays = await runScriptAsPromise('getNoSchoolDays');
                            const nsd = allNoSchoolDays.find(n => n.ID === noSchoolId);
                            if (nsd) {
                                showModal('No-School Day', `
                                    <strong>Date:</strong> ${nsd.Date}<br>
                                    <strong>Reason:</strong> ${nsd.Reason}
                                    <div class="modal-actions" style="margin-top: 15px;">
                                        <button class="btn secondary-btn small-btn" onclick="deleteNoSchoolDay('${nsd.ID}')" style="background-color: #f44336; color: white;"><i class="fas fa-trash-alt"></i> Delete</button>
                                    </div>
                                `);
                            } else {
                                showModal('No-School Day', `<strong>Reason:</strong> ${info.event.title} (Details not found)`);
                            }
                        } catch (error) {
                            console.error('[Calendar Event Click Error] Failed to load no-school day details for modal:', error);
                            showModal('Error', 'Failed to load no-school day details: ' + error.message);
                        }
                    }
                    else if (String(eventId).startsWith('unit-')) {
                         console.warn('[Calendar Event Click] Unexpected unit event clicked on main calendar. ID:', eventId);
                         const unitId = eventId.replace('unit-', '');
                        try {
                            const allUnits = await runScriptAsPromise('getUnits');
                            const unit = allUnits.find(u => u.ID === unitId);
                            if (unit) {
                                showModal('Unit Information', `
                                    <strong>Unit:</strong> ${unit.UnitName}<br>
                                    <strong>Subject:</strong> ${unit.Subject}<br>
                                    <strong>Start Date:</strong> ${unit.StartDate}<br>
                                    <strong>End Date:</strong> ${unit.EndDate}<br>
                                    <strong>Working Days:</strong> ${unit.TotalWorkingDays}<br>
                                    <strong>Notes:</strong> ${unit.Notes || 'N/A'}
                                    <div class="modal-actions" style="margin-top: 15px;">
                                        <button class="btn primary-btn small-btn" onclick="openUnitModal('${unitId}')"><i class="fas fa-edit"></i> Edit Unit</button>
                                    </div>
                                `);
                            } else {
                                showModal('Unit Information', `<strong>Unit:</strong> ${info.event.title.replace('Unit: ', '')} (Details not found)`);
                            }
                        } catch (error) {
                            console.error('[Unit Calendar Event Click Error] Failed to load unit details for modal:', error);
                            showModal('Error', 'Failed to load unit details: ' + error.message);
                        }
                    }
                    else { // This is the block for your regular lesson events
                        // For regular lesson clicks, treat it like a date click to show all lessons for that date.
                        console.log('[Calendar Event Click] Assuming lesson event. Delegating to handleCalendarDateOrEventClick for date:', info.event.startStr);
                        await handleCalendarDateOrEventClick(info.event.startStr); // Pass the event's start date
                    }
                },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    console.log('[Calendar Events] Fetching events for dashboard calendar, range:', fetchInfo.startStr, 'to', fetchInfo.endStr);
                    const start = moment(fetchInfo.start).format('YYYY-MM-DD');
                    const end = moment(fetchInfo.end).format('YYYY-MM-DD');
                    const subjects = getSelectedSubjects();
                    console.log('[Calendar Events] Subjects filter:', subjects);

                    try {
                        // CORRECTED LINE: Call getLessonsForCalendar directly and get noSchoolDays separately
                        const lessons = await runScriptAsPromise('getLessonsForCalendar', start, end, subjects);
                        const noSchoolDays = await runScriptAsPromise('getNoSchoolDays');

                        console.log('[Calendar Events] Received noSchoolDays count:', noSchoolDays.length, 'lessons count:', lessons.length);

                        const events = lessons.map(lesson => ({
                            id: lesson.ID,
                            title: `${lesson.LessonTitle}${lesson.Task ? ' - ' + lesson.Task : ''} (${lesson.SubjectClass})`,
                            start: lesson.Date,
                            backgroundColor: subjectColorMap[lesson.SubjectClass] || '#607D8B',
                            extendedProps: {
                                lessonId: lesson.ID,
                                date: lesson.Date,
                                subject: lesson.SubjectClass
                            }
                        }));

                        noSchoolDays.forEach(nsd => {
                            events.push({
                                id: 'noschool-' + nsd.ID,
                                title: nsd.Reason,
                                start: nsd.Date,
                                display: 'background',
                                backgroundColor: '#F44336' // Explicit red for no-school days
                            });
                        });

                        console.log('[Calendar Events] Total events prepared:', events.length);
                        successCallback(events);
                    } catch (error) {
                        console.error('[Calendar Events Error] Failed to load calendar events:', error);
                        failureCallback(error);
                        showModal('Error', 'Failed to load calendar events: ' + error.message);
                    }
                },
                // Add dayCellDidMount to highlight weekends directly
                dayCellDidMount: function(info) {
                    const dayOfWeek = info.date.getDay(); // 0 = Sunday, 6 = Saturday
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        info.el.classList.add('fc-day-weekend');
                    }
                }
            });
            calendar.render();
            console.log('[Calendar] Dashboard Calendar rendered.');
        }


        // NEW FUNCTION: Render Unit Only Calendar
        async function renderUnitCalendar() {
            console.log('[Unit Calendar] Starting renderUnitCalendar...');
            const unitCalendarEl = document.getElementById('unit-calendar');

            // Destroy existing calendar instance if it exists (main calendar)
            if (calendar) {
                calendar.destroy();
                calendar = null; // Clear reference
                console.log('[Calendar] Dashboard calendar destroyed for view switch.');
            }
            // Destroy existing unit calendar instance if it exists
            if (unitCalendar) {
                unitCalendar.destroy();
                console.log('[Unit Calendar] Existing unit calendar destroyed.');
            }

            unitCalendar = new FullCalendar.Calendar(unitCalendarEl, {
                initialView: 'dayGridMonth', // Or 'timeGridWeek' if you prefer a timeline look
                initialDate: '2025-08-01', // Set calendar to start in August 2025
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek' // Offer week view for closer unit inspection
                },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    console.log('[Unit Calendar Events] Fetching units for unit calendar, range:', fetchInfo.startStr, 'to', fetchInfo.endStr);
                    try {
                        const allUnits = await runScriptAsPromise('getUnits'); // Fetch all units
                        const noSchoolDays = await runScriptAsPromise('getNoSchoolDays'); // Needed for remaining days calculation

                        const events = [];
                        allUnits.forEach(unit => {
                            const unitColor = subjectColorMap[unit.Subject] || '#2196F3'; // Default to blue if no subject color
                            events.push({
                                id: 'unit-' + unit.ID,
                                title: `${unit.UnitName} (${unit.Subject})`,
                                start: unit.StartDate,
                                end: moment(unit.EndDate).add(1, 'days').format('YYYY-MM-DD'), // +1 day for exclusive end date
                                backgroundColor: unitColor,
                                classNames: ['fc-unit-event'], // Apply custom unit event styling
                                extendedProps: {
                                    unitId: unit.ID,
                                    unitName: unit.UnitName,
                                    subject: unit.Subject,
                                    startDate: unit.StartDate,
                                    endDate: unit.EndDate,
                                    totalWorkingDays: unit.TotalWorkingDays,
                                    notes: unit.Notes // Pass notes for tooltip
                                }
                            });
                        });

                        // Also add no-school days so their red highlights show on this calendar too
                        noSchoolDays.forEach(nsd => {
                            events.push({
                                id: 'noschool-' + nsd.ID,
                                title: nsd.Reason,
                                start: nsd.Date,
                                display: 'background',
                                backgroundColor: '#F44336' // Explicit red for no-school days
                            });
                        });

                        console.log('[Unit Calendar Events] Total unit events prepared:', events.length);
                        successCallback(events);
                    } catch (error) {
                        console.error('[Unit Calendar Events Error] Failed to load unit calendar events:', error);
                        failureCallback(error);
                        showModal('Error', 'Failed to load unit calendar events: ' + error.message);
                    }
                },
                // Unit bar click to open unit modal
                eventClick: async function(info) {
                    console.log('[Unit Calendar Event Click] Event clicked, ID:', info.event.id);
                    const eventId = info.event.id;
                    if (String(eventId).startsWith('unit-')) {
                        const unitId = info.event.extendedProps.unitId; // Use extendedProps for convenience
                        // Re-use your existing unit info modal logic
                        try {
                            const allUnits = await runScriptAsPromise('getUnits'); // Get all units again to avoid passing too much in event object
                            const unit = allUnits.find(u => u.ID === unitId);
                            if (unit) {
                                showModal('Unit Information', `
                                    <strong>Unit:</strong> ${unit.UnitName}<br>
                                    <strong>Subject:</strong> ${unit.Subject}<br>
                                    <strong>Start Date:</strong> ${unit.StartDate}<br>
                                    <strong>End Date:</strong> ${unit.EndDate}<br>
                                    <strong>Working Days:</strong> ${unit.TotalWorkingDays}<br>
                                    <strong>Notes:</strong> ${unit.Notes || 'N/A'}
                                    <div class="modal-actions" style="margin-top: 15px;">
                                        <button class="btn primary-btn small-btn" onclick="openUnitModal('${unitId}')"><i class="fas fa-edit"></i> Edit Unit</button>
                                    </div>
                                `);
                            } else {
                                showModal('Unit Information', `<strong>Unit:</strong> ${info.event.title.replace('Unit: ', '')} (Details not found)`);
                            }
                        } catch (error) {
                            console.error('[Unit Calendar Event Click Error] Failed to load unit details for modal:', error);
                            showModal('Error', 'Failed to load unit details: ' + error.message);
                        }
                    } else if (String(eventId).startsWith('noschool-')) {
                        const noSchoolId = eventId.replace('noschool-', '');
                        try {
                            const allNoSchoolDays = await runScriptAsPromise('getNoSchoolDays');
                            const nsd = allNoSchoolDays.find(n => n.ID === noSchoolId);
                            if (nsd) {
                                showModal('No-School Day', `
                                    <strong>Date:</strong> ${nsd.Date}<br>
                                    <strong>Reason:</strong> ${nsd.Reason}
                                    <div class="modal-actions" style="margin-top: 15px;">
                                        <button class="btn secondary-btn small-btn" onclick="deleteNoSchoolDay('${nsd.ID}')" style="background-color: #f44336; color: white;"><i class="fas fa-trash-alt"></i> Delete</button>
                                    </div>
                                `);
                            } else {
                                showModal('No-School Day', `<strong>Reason:</strong> ${info.event.title} (Details not found)`);
                            }
                        } catch (error) {
                            console.error('[Unit Calendar Event Click Error] Failed to load no-school day details for modal:', error);
                            showModal('Error', 'Failed to load no-school day details: ' + error.message);
                        }
                    }
                },
                // Add dayCellDidMount to highlight weekends directly
                dayCellDidMount: function(info) {
                    const dayOfWeek = info.date.getDay(); // 0 = Sunday, 6 = Saturday
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        info.el.classList.add('fc-day-weekend');
                    }
                },
                // NEW: Tooltip on hover for unit events
                eventDidMount: function(info) {
                    if (String(info.event.id).startsWith('unit-')) {
                        const unit = info.event.extendedProps; // Get directly from extendedProps as we already populated it

                        // Create and append tooltip element
                        let tooltip = document.createElement('div');
                        tooltip.className = 'unit-tooltip';
                        tooltip.style.display = 'none'; // Crucial: Ensure it's hidden initially
                        document.body.appendChild(tooltip);

                        // Store a unique timeout ID for this specific tooltip
                        // Attach the timeout to the tooltip element itself for easy cleanup
                        tooltip.__hideTimeout = null;

                        info.el.addEventListener('mouseover', (e) => {
                            clearTimeout(tooltip.__hideTimeout); // Clear any pending hide
                            tooltip.innerHTML = `
                                <p><strong>Unit:</strong> ${unit.unitName}</p>
                                <p><strong>Subject:</strong> ${unit.subject}</p>
                                <p><strong>Duration:</strong> ${moment(unit.startDate).format('MMMM D, YYYY')} - ${moment(unit.endDate).format('MMMM D, YYYY')}</p>
                                <p><strong>Working Days:</strong> ${unit.totalWorkingDays}</p>
                                ${unit.notes ? `<p><strong>Notes:</strong> ${unit.notes}</p>` : ''}
                            `;
                            // Position tooltip next to cursor or event
                            tooltip.style.left = `${e.pageX + 10}px`;
                            tooltip.style.top = `${e.pageY + 10}px`;
                        });

                        info.el.addEventListener('mousemove', (e) => {
                             tooltip.style.left = `${e.pageX + 10}px`;
                             tooltip.style.top = `${e.pageY + 10}px`;
                        });

                        info.el.addEventListener('mouseleave', () => {
                            // Hide after a small delay to allow re-entry without flicker
                            tooltip.__hideTimeout = setTimeout(() => {
                                tooltip.style.display = 'none';
                            }, 50);
                        });
                        // Store the tooltip element directly on the event element for later removal
                        info.el.__unitTooltip = tooltip;
                    }
                }
            });
            unitCalendar.render();
            console.log('[Unit Calendar] Unit Only Calendar rendered.');
            hideLoader(); // Hide loader after calendar rendering
        }


        async function handleCalendarDateOrEventClick(dateStr) {
            console.log(`[Calendar Click Handler] Handling click for date: ${dateStr}`);
            // Loader managed by runScriptAsPromise calls
            const subjects = getSelectedSubjects();
            try {
                // Modified backend call to get more details for the modal display
                const result = await runScriptAsPromise('getLessonsAndUnitsForSummary', dateStr, subjects);

                // Add defensive checks and default values for destructuring
                const lessons = result?.lessons || []; // Use optional chaining and default empty array
                const units = result?.units || [];
                const noSchoolDays = result?.noSchoolDays || [];

                console.log(`[Calendar Click Handler] Lessons for date:`, lessons);
                console.log(`[Calendar Click Handler] Units for context:`, units);
                console.log(`[Calendar Click Handler] NoSchoolDays for context:`, noSchoolDays);

                let modalContentHtml = ``;
                if (lessons && lessons.length > 0) {
                    for (const basicLesson of lessons) {
                        const fullLesson = await runScriptAsPromise('getLessonById', basicLesson.ID); // Still fetch full lesson for full modal details
                        if (fullLesson) {
                            modalContentHtml += generateLessonModalHtml(fullLesson);
                        } else {
                            modalContentHtml += `<div class="lesson-modal-item"><h4>${basicLesson.LessonTitle} (${basicLesson.SubjectClass}) - Details Not Found</h4><p>Could not load full lesson details for lesson ID: ${basicLesson.ID}.</p></div>`;
                        }
                    }
                } else {
                    modalContentHtml += `<p>No lessons planned for this date/class(es).</p>`;
                }
                modalContentHtml += `<div class="modal-actions" style="justify-content: flex-start;">
                                        <button id="add-new-lesson-from-calendar" class="btn primary-btn"><i class="fas fa-plus-circle"></i> Add New Lesson</button>
                                    </div>`;


                showModal('View Lessons for ' + moment(dateStr).format('MMMM D, YYYY'), modalContentHtml);

                document.getElementById('add-new-lesson-from-calendar').onclick = () => {
                    console.log('[Calendar Modal] Adding new lesson from calendar date.');
                    modal.style.display = 'none';
                    openLessonModal(null, dateStr);
                };

                document.querySelectorAll('.edit-lesson-in-modal').forEach(button => {
                    button.onclick = (e) => {
                        console.log('[Calendar Modal] Editing lesson from calendar modal, ID:', e.target.dataset.lessonId);
                        modal.style.display = 'none';
                        openLessonModal(e.target.dataset.lessonId);
                    };
                });

                document.querySelectorAll('.export-doc-in-modal').forEach(button => {
                    button.onclick = async (e) => {
                        console.log('[Calendar Modal] Exporting lesson from modal, ID:', e.target.dataset.lessonId);
                        const lessonIdToExport = e.target.dataset.lessonId;
                        try {
                            const docUrl = await runScriptAsPromise('exportLessonAsGoogleDoc', lessonIdToExport);
                            showModal('Export Complete', `Lesson exported successfully! <a href="${docUrl}" target="_blank">Open Google Doc</a>`);
                        } catch (error) {
                            showModal('Error', 'Failed to export lesson: ' + error.message);
                        }
                    };
                });

                document.querySelectorAll('.delete-lesson-in-modal').forEach(button => {
                    button.onclick = (e) => {
                        const lessonIdToDelete = e.target.dataset.lessonId;
                        showModal('Confirm Deletion', 'Are you sure you want to delete this lesson?', async () => {
                            try {
                                await runScriptAsPromise('deleteLesson', lessonIdToDelete);
                                showModal('Success', 'Lesson deleted.');
                                modal.style.display = 'none';
                                calendar.refetchEvents();
                                updateDailyLessonSummaries();
                            } catch (error) {
                                showModal('Error', 'Failed to delete lesson: ' + error.message);
                            }
                        });
                    };
                });

            } catch (error) {
                console.error('[Calendar Click Handler Error] Failed to process calendar click:', error);
                showModal('Error', 'Failed to load lesson details: ' + error.message);
            }
        }

        function generateLessonModalHtml(lesson) {
            let html = `<div class="lesson-modal-item">
                                        <h4>
                                            ${lesson.LessonTitle} (${lesson.SubjectClass})
                                            <div class="modal-lesson-controls">
                                                <button class="btn small-btn edit-lesson-in-modal" data-lesson-id="${lesson.ID}"><i class="fas fa-edit"></i> Edit</button>
                                                <button class="btn small-btn export-doc-in-modal" data-lesson-id="${lesson.ID}"><i class="fas fa-file-export"></i> Export</button>
                                                <button class="btn small-btn secondary-btn delete-lesson-in-modal" data-lesson-id="${lesson.ID}" style="background-color: #f44336; color: white;"><i class="fas fa-trash-alt"></i> Delete</button>
                                            </div>
                                        </h4>`;

            if (lesson.Task && String(lesson.Task).trim()) {
                html += `<p><strong>Task:</strong> ${lesson.Task}</p>`;
            }
            if (lesson.UnitName && String(lesson.UnitName).trim()) {
                html += `<p><strong>Unit:</strong> ${lesson.UnitName}</p>`;
            }

            if (lesson.Objective && String(lesson.Objective).trim()) {
                html += `<details><summary><i class="fas fa-caret-right"></i> Objective</summary><div class="lesson-detail-section"><p>${lesson.Objective}</p></div></details>`;
            }
            if (lesson.Activities && String(lesson.Activities).trim()) {
                const activitiesList = String(lesson.Activities).split('\n').filter(s => s.trim()).map(s => `<li>${s.trim()}</li>`).join('');
                html += `<details><summary><i class="fas fa-caret-right"></i> Detailed Plan</summary><div class="lesson-detail-section"><ul>${activitiesList}</ul></div></details>`;
            }
            if (lesson.Standards && String(lesson.Standards).trim()) {
                const standardsList = String(lesson.Standards).split(', ').filter(s => s.trim()).map(s => `<li>${s.trim()}</li>`).join('');
                html += `<details><summary><i class="fas fa-caret-right"></i> Standards</summary><div class="lesson-detail-section"><ul>${standardsList}</ul></div></details`;
            }
            if (lesson.Materials && String(lesson.Materials).trim()) {
                html += `<details><summary><i class="fas fa-caret-right"></i> Materials</summary><div class="lesson-detail-section"><p>${lesson.Materials}</p></div></details>`;
            }
            if ((lesson.DifferentiationStrategies && String(lesson.DifferentiationStrategies).trim()) || (lesson.DifferentiationNotes && String(lesson.DifferentiationNotes).trim())) {
                let diffContent = '';
                if (lesson.DifferentiationStrategies && String(lesson.DifferentiationStrategies).trim()) {
                    const diffStrategiesList = String(lesson.DifferentiationStrategies).split(', ').filter(s => s.trim()).map(s => `<li>${s.trim()}</li>`).join('');
                    diffContent += `<p>Strategies:</p><ul>${diffStrategiesList}</ul>`;
                }
                if (lesson.DifferentiationNotes && String(lesson.DifferentiationNotes).trim()) {
                    diffContent += `<p>Notes: ${lesson.DifferentiationNotes}</p>`;
                }
                if (diffContent) {
                    html += `<details><summary><i class="fas fa-caret-right"></i> Differentiation</summary><div class="lesson-detail-section">${diffContent}</div></details>`;
                }
            }
            if (lesson.Assessments && String(lesson.Assessments).trim()) {
                html += `<details><summary><i class="fas fa-caret-right"></i> Assessments</summary><div class="lesson-detail-section"><p>${lesson.Assessments}</p></div></details`;
            }
            if ((lesson.StudentNotes && String(lesson.StudentNotes).trim()) || (lesson.StudentNotesDetail && String(lesson.StudentNotesDetail).trim())) {
                let studentNotesContent = '';
                if (lesson.StudentNotes && String(lesson.StudentNotes).trim()) {
                    studentNotesContent += `<p>Students: ${lesson.StudentNotes}</p>`;
                }
                if (lesson.StudentNotesDetail && String(lesson.StudentNotesDetail).trim()) {
                    studentNotesContent += `<p>Details: ${lesson.StudentNotesDetail}</p>`;
                }
                if (studentNotesContent) {
                    html += `<details><summary><i class="fas fa-caret-right"></i> Student Notes</summary><div class="lesson-detail-section">${studentNotesContent}</div></details>`;
                }
            }
            if ((lesson.ReflectionNotes && String(lesson.ReflectionNotes).trim()) || (lesson.Attachments && lesson.Attachments.length > 0)) {
                let reflectionContent = '';
                if (lesson.ReflectionNotes && String(lesson.ReflectionNotes).trim()) {
                    reflectionContent += `<p>Reflection: ${lesson.ReflectionNotes}</p>`;
                }
                if (lesson.Attachments && lesson.Attachments.length > 0) {
                    reflectionContent += `<p>Attached Files:</p><ul>`;
                    lesson.Attachments.forEach(file => {
                        reflectionContent += `<li><a href="${file.Url}" target="_blank"><i class="fas fa-paperclip"></i> ${file.FileName}</a></li>`;
                    });
                    reflectionContent += `</ul>`;
                }
                if (reflectionContent) {
                    html += `<details><summary><i class="fas fa-caret-right"></i> Reflection & Files</summary><div class="lesson-detail-section">${reflectionContent}</div></details>`;
                }
            }

            html += `</div>`;
            return html;
        }


        dashboardSubjectCheckboxes.addEventListener('change', () => {
            console.log('[Dashboard Filters] Subject checkbox changed.');
            // Refetch events for both calendars if they exist
            if (calendar) calendar.refetchEvents();
            if (unitCalendar) unitCalendar.refetchEvents();
            updateDailyLessonSummaries();
        });

        async function checkLicense() {
            console.log('[License] Checking license status...');
            // Loader managed by runScriptAsPromise
            try {
                const licenseStatus = await runScriptAsPromise('getLicenseStatus');
                console.log('[License] License status received:', licenseStatus);
                const addBtn = document.querySelector('.fc-addBtn-button');
                if (licenseStatus.expired) {
                    licenseStatusBanner.classList.add('expired');
                    licenseStatusBanner.innerHTML = `<i class="fas fa-exclamation-triangle"></i> License expired. Please renew on TpT!`;
                    if (addBtn) {
                        addBtn.disabled = true;
                        addBtn.style.opacity = '0.5';
                        addBtn.style.cursor = 'not-allowed';
                        console.warn('[License] License expired. FullCalendar add button disabled.');
                    }
                } else {
                    licenseStatusBanner.classList.add('active');
                    licenseStatusBanner.innerHTML = `<i class="fas fa-check-circle"></i> ${licenseStatus.daysRemaining} days remaining.`;
                    console.log('[License] License active.');
                    if (addBtn) {
                        addBtn.disabled = false;
                        addBtn.style.opacity = '1';
                        addBtn.style.cursor = 'pointer';
                    }
                }
            } catch (error) {
                console.error('[License Error] Error checking license:', error);
                licenseStatusBanner.classList.add('error');
                licenseStatusBanner.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error checking license: ${error.message}`;
                const addBtn = document.querySelector('.fc-addBtn-button');
                if (addBtn) {
                    addBtn.disabled = true;
                    addBtn.style.opacity = '0.5';
                    addBtn.style.cursor = 'not-allowed';
                }
            }
        }

        async function loadSettings() {
            console.log('[Settings] Loading settings...');
            // Loader managed by runScriptAsPromise
            const dropdownsEditorDiv = document.getElementById('dropdowns-editor');
            dropdownsEditorDiv.innerHTML = 'Loading settings...';
            try {
                console.log('[Settings] Calling getDropdownOptions...');
                const dropdownOptions = await runScriptAsPromise('getDropdownOptions');
                console.log('[Settings] Received dropdown options:', dropdownOptions);
                const groupedOptions = dropdownOptions.reduce((acc, item) => {
                    if (!acc[item.type]) acc[item.type] = [];
                    acc[item.type].push(item);
                    return acc;
                }, {});

                let html = '';
                for (const type in groupedOptions) {
                    html += `
                        <div class="setting-group">
                            <h4>${type} Options:</h4>
                            <ul class="tag-list">
                                ${groupedOptions[type].map(item => `<li class="tag" style="background-color: ${item.type === 'Subjects' && item.color ? item.color + '33' : '#e0f2f7'}; border-color: ${item.type === 'Subjects' && item.color ? item.color : '#b2ebf2'}; color: ${item.type === 'Subjects' && item.color ? 'black' : '#00838F'};">
                                            ${item.value}
                                            ${item.type === 'Subjects' ? `<input type="color" class="subject-color-picker" value="${item.color || '#607d8b'}" data-type="${item.type}" data-value="${item.value}">` : ''}
                                            <span class="remove-tag" data-type="${item.type}" data-value="${item.value}">&times;</span>
                                        </li>`).join('')}
                            </ul>
                            <input type="text" placeholder="Add new ${type}" class="add-dropdown-input" data-type="${type}">
                            ${type === 'Subjects' ? '<input type="color" class="add-subject-color" value="#ffffff">' : ''}
                            <button class="btn small-btn add-dropdown-btn" data-type="${type}"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    `;
                }
                dropdownsEditorDiv.innerHTML = html;
                console.log('[Settings] Dropdown editor HTML rendered.');

                dropdownsEditorDiv.querySelectorAll('.add-dropdown-btn').forEach(button => {
                    button.removeEventListener('click', addDropdownOptionHandler);
                    button.addEventListener('click', addDropdownOptionHandler);
                });

                dropdownsEditorDiv.querySelectorAll('.remove-tag').forEach(button => {
                    button.removeEventListener('click', removeDropdownOptionHandler);
                    button.addEventListener('click', removeDropdownOptionHandler);
                });

                dropdownsEditorDiv.querySelectorAll('.subject-color-picker').forEach(picker => {
                    picker.removeEventListener('change', updateDropdownOptionColorHandler);
                    picker.addEventListener('change', updateDropdownOptionColorHandler);
                });

            } catch (error) {
                console.error('[Settings Error] Error loading settings:', error);
                dropdownsEditorDiv.innerHTML = '<p>Error loading settings: ' + error.message + '</p>';
            }
            runScriptAsPromise('getReflectionPrompt').then(prompt => {
                if (prompt) reflectionPromptTextarea.value = prompt;
            }).catch(error => {
                console.warn('[Settings] Failed to load reflection prompt: ' + error.message);
            });
        }

        if (typeof google.script.run.getReflectionPrompt !== 'function') {
            google.script.run.getReflectionPrompt = (prompt) => {
                console.warn("Backend function 'getReflectionPrompt' not implemented.");
                return "";
            };
        }


        async function addDropdownOptionHandler(e) {
            const type = e.target.dataset.type;
            const settingGroup = e.target.closest('.setting-group');

            const textInput = settingGroup.querySelector('.add-dropdown-input[data-type="' + type + '"]');
            const colorInput = type === 'Subjects' ? settingGroup.querySelector('.add-subject-color') : null;

            const value = textInput ? textInput.value.trim() : '';
            const color = colorInput ? colorInput.value : '';

            console.log(`[Settings Add] Attempting to add ${type}: "${value}" (Color: ${color})`);

            if (!value) {
                showModal('Validation Error', 'Dropdown value cannot be empty.');
                console.warn('[Settings Add] Value is empty.');
                return;
            }

            try {
                await runScriptAsPromise('addDropdownOption', type, value, color);
                showModal('Success', `Added "${value}" to ${type}.`);
                if (textInput) textInput.value = '';
                if (colorInput) colorInput.value = '#ffffff';
                await loadSettings();
                await populateDropdowns(); // Re-populate dashboard subject checkboxes
                if(calendar) calendar.refetchEvents(); // Re-render calendar with new subjects/colors
                if(unitCalendar) unitCalendar.refetchEvents(); // NEW: Re-render unit calendar as well
                console.log(`[Settings Add] Successfully added ${value} to ${type}.`);
            } catch (error) {
                console.error(`[Settings Add Error] Failed to add option "${value}" to ${type}:`, error);
                showModal('Error', 'Failed to add option: ' + error.message);
            }
        }

        async function removeDropdownOptionHandler(e) {
            const type = e.target.dataset.type;
            const value = e.target.dataset.value;
            console.log(`[Settings Remove] Attempting to remove ${type}: "${value}"`);

            showModal('Confirm Deletion', `Are you sure you want to remove "${value}" from ${type}?`, async () => {
                try {
                    await runScriptAsPromise('removeDropdownOption', type, value);
                    showModal('Success', `Removed "${value}" from ${type}.`);
                    await loadSettings();
                    await populateDropdowns(); // Re-populate dashboard subject checkboxes
                    if(calendar) calendar.refetchEvents(); // Re-render calendar without removed subject/color
                    if(unitCalendar) unitCalendar.refetchEvents(); // NEW: Re-render unit calendar as well
                    console.log(`[Settings Remove] Successfully removed ${value} from ${type}.`);
                } catch (error) {
                    console.error(`[Settings Remove Error] Failed to remove option "${value}" from ${type}:`, error);
                    showModal('Error', 'Failed to remove option: ' + error.message);
                }
            });
        }

        async function updateDropdownOptionColorHandler(e) {
            const type = e.target.dataset.type;
            const value = e.target.dataset.value;
            const newColor = e.target.value;
            console.log(`[Settings Color] Updating color for ${type}: "${value}" to ${newColor}`);
            try {
                await runScriptAsPromise('updateDropdownOptionColor', type, value, newColor);
                showModal('Success', `Updated color for "${value}".`);
                await loadSettings();
                await populateDropdowns(); // Re-populate dashboard subject checkboxes
                if(calendar) calendar.refetchEvents(); // Re-render calendar with new subject color
                if(unitCalendar) unitCalendar.refetchEvents(); // NEW: Re-render unit calendar as well
                console.log(`[Settings Color] Successfully updated color for ${value}.`);
            } catch (error) {
                console.error(`[Settings Color Error] Failed to update color for "${value}":`, error);
                showModal('Error', `Failed to update color for "${value}": ` + error.message);
            }
        }

        saveReflectionBtn.addEventListener('click', async () => {
            const reflectionText = reflectionPromptTextarea.value;
            console.log('[Save Reflection] Save reflection button clicked. Text:', reflectionText);
            if (!reflectionText.trim()) {
                showModal('Warning', 'Please write something for your reflection.');
                console.warn('[Save Reflection] Reflection text is empty.');
                return;
            }
            saveReflectionBtn.disabled = true;
            saveReflectionBtn.textContent = 'Saving...';
            try {
                await runScriptAsPromise('saveReflectionPrompt', reflectionText);
                console.log('[Save Reflection] Reflection prompt saved successfully.');
                showModal('Success', 'Reflection prompt saved!');
            } catch (error) {
                console.error('[Save Reflection Error] Failed to save reflection prompt:', error);
                showModal('Error', 'Failed to save reflection prompt: ' + error.message);
            } finally { // This finally is okay because it's local to the async function
                saveReflectionBtn.disabled = false;
                saveReflectionBtn.textContent = 'Save Reflection';
            }
        });

        if (typeof google.script.run.saveReflectionPrompt !== 'function') {
            google.script.run.saveReflectionPrompt = (prompt) => {
                console.warn("Backend function 'saveReflectionPrompt' not implemented.");
                return "";
            };
        }

        function toggleOptionalField(groupId, forceShow = false, formContainer = document) {
            const group = formContainer.querySelector(`#${groupId}`);
            if (!group) return;

            const toggleButton = formContainer.querySelector(`.toggle-field-btn[data-target="${groupId}"]`);
            if (!toggleButton) return;

            const descriptiveText = toggleButton.dataset.descriptiveText;
            if (!descriptiveText) {
                console.warn(`[toggleOptionalField] No descriptive text found for group: ${groupId}. Ensure data-descriptiveText is set.`);
                return;
            }

            const elements = getModalFormElements('lesson'); // Note: This always gets lesson elements, confirm if intended for units too

            if (group.style.display === 'none' || forceShow) {
                group.style.display = 'block';
                toggleButton.innerHTML = `<i class="fas fa-minus"></i> Hide ${descriptiveText}`;

                if (groupId === 'standards-group' && elements.standardsSelect && elements.standardsSelect.dataset.hasBeenPopulated !== 'true') {
                    const selectedSubject = elements.subjectClassSelect.value;
                    if (selectedSubject) {
                        runScriptAsPromise('getStandardsBySubject', selectedSubject)
                            .then(standards => {
                                populateSelect(elements.standardsSelect, standards);
                                elements.standardsSelect.dataset.hasBeenPopulated = 'true';
                            })
                            .catch(error => console.error('Failed to load standards on toggle:', error));
                    }
                } else if (groupId === 'differentiation-group' && elements.differentiationStrategiesCheckboxes && elements.differentiationStrategiesCheckboxes.dataset.hasBeenPopulated !== 'true') {
                    runScriptAsPromise('getDropdownOptionsByType', 'Differentiation Strategies')
                        .then(strategies => {
                            populateCheckboxes(elements.differentiationStrategiesCheckboxes, strategies);
                            elements.differentiationStrategiesCheckboxes.dataset.hasBeenPopulated = 'true';
                        })
                        .catch(error => console.error('Failed to load differentiation strategies on toggle:', error));
                } else if (groupId === 'student-notes-group' && elements.studentNotesSelect && elements.studentNotesSelect.dataset.hasBeenPopulated !== 'true') {
                    runScriptAsPromise('getStudents')
                        .then(students => {
                            populateSelect(elements.studentNotesSelect, students.map(s => s.Name));
                            elements.studentNotesSelect.dataset.hasBeenPopulated = 'true';
                        })
                        .catch(error => console.error('Failed to load students on toggle:', error));
                }

                console.log(`[UI Toggle] Showing group: ${groupId}`);
            } else {
                group.style.display = 'none';
                toggleButton.innerHTML = `<i class="fas fa-plus"></i> Add ${descriptiveText}`;
                console.log(`[UI Toggle] Hiding group: ${groupId}`);
            }
        }

        function handleToggleField(e) {
            const targetId = e.currentTarget.dataset.target;
            if (targetId) {
                // Passing e.currentTarget.closest('.modal-content') to ensure we operate within the correct modal instance
                toggleOptionalField(targetId, false, e.currentTarget.closest('.modal-content') || document);
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.toggle-field-btn').forEach(button => {
                const groupId = button.dataset.target;
                let descriptiveText;
                if (groupId === 'detailed-lesson-plan-group') {
                    descriptiveText = 'Detailed Lesson Plan';
                } else if (groupId === 'standards-group') {
                    descriptiveText = 'Standards';
                } else if (groupId === 'materials-group') {
                    descriptiveText = 'Materials';
                } else if (groupId === 'differentiation-group') {
                    descriptiveText = 'Differentiation Options';
                } else if (groupId === 'assessments-group') {
                    descriptiveText = 'Assessments';
                } else if (groupId === 'student-notes-group') {
                    descriptiveText = 'Student-Specific Notes';
                } else if (groupId === 'reflection-upload-group') {
                    descriptiveText = 'Reflection & File Uploads';
                } else {
                    // Fallback to extract text if data-descriptiveText is not set
                    descriptiveText = button.textContent.replace(/^(Add|Hide)\s+/, '').replace(/\s*\<i class="fas fa-(plus|minus|caret-right)".*?\<\/i>\s*/, '').trim();
                }
                button.dataset.descriptiveText = descriptiveText; // Store for future use

                const targetGroup = document.getElementById(groupId);
                if (targetGroup && targetGroup.style.display === 'block') {
                    button.innerHTML = `<i class="fas fa-minus"></i> Hide ${descriptiveText}`;
                } else {
                    button.innerHTML = `<i class="fas fa-plus"></i> Add ${descriptiveText}`;
                }

                // Only attach listener if it's NOT inside a modal's cloned content
                // and has not been attached before for this *static* button
                if (!button.closest('.modal-content') && !button.dataset.listenerAdded) {
                    button.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.dataset.target;
                        if (targetId) {
                            toggleOptionalField(targetId, false, document); // Use document as container for static buttons
                        }
                    });
                    button.dataset.listenerAdded = true; // Mark listener as attached
                }
            });

            // Add the document-level click listener to close the dropdown only ONCE on DOMContentLoaded
            // This listener will only fire if the click is outside the dropdown AND outside the button that opened it.
            document.addEventListener('click', (event) => {
                const clickedButton = document.querySelector('.fc-addBtn-button'); // Get the current FC add button
                if (addDropdownMenuElement && addDropdownMenuElement.classList.contains('active')) { // Only act if dropdown is visible
                    // Check if the click target is outside the dropdown AND outside the FC button
                    if (!addDropdownMenuElement.contains(event.target) && (!clickedButton || !clickedButton.contains(event.target))) {
                        addDropdownMenuElement.classList.remove('active');
                        console.log('[Dropdown] Closed by external click.');
                    }
                }
            }, true); // Use capture phase for this global listener
        });


        window.addEventListener('load', async () => {
            console.log('[App Init] Window loaded. Starting app initialization.');
            // Initial showLoader managed by runScriptAsPromise calls below

            try {
                await populateDropdowns(); // Populates subjectColorMap and dashboard filters
                console.log('[App Init] Dashboard dropdowns populated.');

                await renderCalendar(); // Renders the default Dashboard calendar
                console.log('[App Init] Dashboard Calendar rendered.');

                await checkLicense();
                console.log('[App Init] License check complete.');

                await updateDailyLessonSummaries(); // Call this AFTER renderCalendar, as it uses FullCalendar's current date
                console.log('[App Init] Daily summaries updated.');

                showView('dashboard-view'); // Ensure dashboard is the default view
                console.log('[App Init] Dashboard view shown.');

            } catch (error) {
                console.error("[App Init Error] An error occurred during application startup:", error);
                showModal('Initialization Error', 'An error occurred during application startup. Please check the browser console for details. Error: ' + error.message);
                hideLoader(); // Ensure loader is hidden on critical startup failure
            }
        });
    </script>
</body>
</html>