<!DOCTYPE html>
<html>
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>MailFlow Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
     
    :root {
      --primary-color: #3b3b3b;  
      --primary-dark: #2a2a2a;  
      --secondary-color: #555555;  
      --accent-color: #444444;  
      --success-color: #28a745;  
      --warning-color: #ffc107;  
      --danger-color: #dc3545;  
      --background-color: #1a1a1a;  
      --card-background: #2b2b2b;  
      --text-primary: #e0e0e0;  
      --text-secondary: #b0b0b0;  
      --text-muted: #808080;  
      --border-color: #3a3a3a;  
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.25);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      }
     
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;  
    }
     
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--background-color) 0%, #2a2a2a 100%);  
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      overflow: hidden;  
      font-size: 1.25rem;  
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .container {
      width: 100%;  
      height: 100%;  
      margin: 0 auto;  
      padding: 0 12px;  
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      overflow: hidden;  
    }
    header {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
      color: white;
      padding: 24px 20px;  
      text-align: center;
      box-shadow: var(--shadow-lg);
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      margin: 0;  
    }
    header::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.05) 0%, transparent 100%);
      pointer-events: none;
    }
    h1 {
      margin: 0;
      font-size: 2.5rem;  
      font-weight: 700;
      letter-spacing: -0.025em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
     
    nav {
      background: var(--card-background);
      padding: 16px 20px;  
      margin: 0 0 12px 0;  
      box-shadow: var(--shadow-sm);
      display: flex;
      justify-content: space-around;
      gap: 16px;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border-color);
    }
    nav button {
      background: var(--background-color);
      border: 2px solid transparent;
      padding: 16px 24px;  
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 2.2rem;  
      font-weight: 500;
      flex-grow: 1;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      position: relative;
      overflow: hidden;
      min-height: 48px;  
    }
    nav button::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    nav button:hover::before { left: 100%; }
    nav button.active {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-color: var(--primary-dark);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    nav button:hover:not(.active) {
      background: var(--border-color);
      transform: translateY(-1px);
    }
     
    .dashboard-view {
         
        flex-grow: 1;
        display: flex;  
        justify-content: center;
        align-items: center;
        padding: 0;
        text-align: center;
        position: relative;
        overflow: hidden;
        width: 100%;
        height: 100%;
    }

     
    .task-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;  
        padding: 20px;  
        overflow-y: auto;  
        align-content: start;  
        width: 100%;  
        height: 100%;  
        box-sizing: border-box;  
    }

    .card-wrapper {
        width: 100%; height: 100%;  
        position: relative; display: flex; justify-content: center; align-items: center;
        padding: 0;  
        box-sizing: border-box;
    }
     
    .email-card {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      margin: 0;  
      padding: 28px;  
      overflow: hidden; position: relative; text-align: left;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out;
      touch-action: pinch-zoom; cursor: grab;
      width: 100%; height: 100%;  
      box-sizing: border-box;
      display: flex; flex-direction: column; justify-content: space-between;
      border: 1px solid var(--border-color);
    }
    .email-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      border-top-left-radius: var(--radius-lg);
      border-top-right-radius: var(--radius-lg);
    }
    .email-card.dragging {
      transition: none; cursor: grabbing;
      box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
    }
    .email-card-header h3 {
      margin: 0 0 12px 0; color: var(--text-primary);
      font-size: 2.2rem !important;  
      font-weight: 600; line-height: 1.3;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .email-card-header p {
      margin: 0 0 8px 0; font-size: 2rem !important;   color: var(--text-secondary); font-weight: 400;
      line-height: 1.4;
    }
     
    #emailCardContainer .email-card-snippet {  
      flex-grow: 1; margin: 16px 0;
      font-size: 2rem !important;  
      line-height: 1.6;
      color: var(--text-primary);
      max-height: 300px !important;  
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 10;  
      -webkit-box-orient: vertical;
    }
     
    #emailCardContainer .email-card-snippet p,
    #emailCardContainer .email-card-snippet span,
    #emailCardContainer .email-card-snippet div {
        font-size: inherit;  
    }
     

    .email-card-meta {
      font-size: 1rem;   color: var(--text-muted); margin-top: 12px; text-align: right; font-weight: 500;
    }
     
    .email-card-actions {
      display: grid; grid-template-columns: 1fr 1fr;   gap: 12px;  
      margin-top: 20px; max-height: 200px; overflow-y: auto;
    }
    .email-card-actions button {
      background: var(--background-color); border: 1px solid var(--border-color);
      padding: 16px 20px;   border-radius: var(--radius-sm);
      cursor: pointer; font-size: 1.8rem;   font-weight: 500; color: var(--text-primary);
      transition: all 0.2s ease; position: relative; overflow: hidden;
      min-height: 58px;  
    }
    .email-card-actions button:hover {
      background: var(--primary-color); color: white; border-color: var(--primary-color);
      transform: translateY(-1px); box-shadow: var(--shadow-sm);
    }
    .email-card-actions button:active { transform: translateY(0); }

     
    .swipe-hint {
        position: absolute;
        font-size: 3.5rem;  
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
        pointer-events: none;
        z-index: 5;
        white-space: nowrap;
        text-align: center;
         
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;  
        align-items: center;  
        justify-content: center;  
        box-sizing: border-box;  
    }
    .swipe-hint.show { opacity: 1; }
     
    .swipe-hint.left {  
        justify-content: flex-start;  
        padding-left: 30px;  
        color: var(--danger-color);
        background: linear-gradient(90deg, rgba(220,53,69,0.3), transparent);  
    }
    .swipe-hint.right {  
        justify-content: flex-end;  
        padding-right: 30px;  
        color: var(--success-color);
        background: linear-gradient(270deg, rgba(40,167,69,0.3), transparent);  
    }
    .swipe-hint.up {  
        top: 20px; bottom: auto;  
        color: var(--danger-color);
        background: linear-gradient(180deg, rgba(220,53,69,0.3), transparent);  
        border-radius: var(--radius-lg);
        width: calc(100% - 40px); height: calc(100% - 40px);  
        left: 20px;
        align-items: flex-start;  
        padding-top: 30px;  
    }
    .swipe-hint.down {  
        bottom: 20px; top: auto;  
        color: var(--warning-color);
        background: linear-gradient(0deg, rgba(255,193,7,0.3), transparent);  
        border-radius: var(--radius-lg);
        width: calc(100% - 40px); height: calc(100% - 40px);  
        left: 20px;
        align-items: flex-end;  
        padding-bottom: 30px;  
    }

     
    .modal {
      display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
      justify-content: center; align-items: center; padding: 20px; animation: fadeIn 0.2s ease-out;
      overflow-x: auto;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background: var(--card-background); margin: auto;
      padding: 28px; border: none; border-radius: var(--radius-lg);
      width: 95%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35); position: relative; animation: slideUp 0.3s ease-out;
      overflow-x: auto;
    }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-content h2 { margin-top: 0; margin-bottom: 20px; color: var(--text-primary); font-weight: 600; font-size: 1.6rem; }  
    .modal-body {
        flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color);
        padding: 20px; background: var(--background-color); border-radius: var(--radius-sm);
        font-size: 1.1rem;   line-height: 1.6; margin-bottom: 16px;
    }
    .modal-body.raw-html { white-space: pre-wrap; font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; }
    .close-button {
      color: var(--text-muted); float: right; font-size: 38px;   font-weight: bold;
      position: absolute; top: 20px; right: 24px; cursor: pointer; transition: color 0.2s ease;
    }
    .close-button:hover, .close-button:focus { color: var(--text-primary); text-decoration: none; }
     
    .modal-content label {
      display: block; width: 100%; margin-bottom: 12px; font-weight: 500; color: var(--text-primary); font-size: 1.1rem;  
    }
    .modal-content input, .modal-content textarea, .modal-content select {
      display: block; width: 100%; margin-bottom: 20px; padding: 18px;  
      border: 2px solid var(--border-color); border-radius: var(--radius-sm); font-size: 1.1rem;  
      transition: border-color 0.2s ease; background: var(--background-color); color: var(--text-primary);
      box-sizing: border-box;
    }
    .modal-content input:focus, .modal-content textarea:focus, .modal-content select:focus {
      outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
    }
    .modal-content button {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white; border: none; padding: 18px 36px;   border-radius: var(--radius-sm);
      cursor: pointer; font-size: 1.1rem;   font-weight: 600; margin-top: 16px;
      transition: all 0.2s ease; box-shadow: var(--shadow-md);
      min-height: 52px;  
    }
    .modal-content button:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .modal-content button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
     
    .full-email-actions {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }
    .full-email-actions button {
      background: var(--background-color); color: var(--text-primary); border: 1px solid var(--border-color);
      padding: 16px 20px;   border-radius: var(--radius-sm); cursor: pointer;
      font-size: 1.8rem !important;   font-weight: 500; margin-top: 0; transition: all 0.2s ease;
      min-height: 52px;  
    }
    .full-email-actions button:hover {
      background: var(--primary-color); color: white; border-color: var(--primary-color);
    }
     
    #snackbar {
      visibility: hidden; min-width: 300px; margin-left: -150px; background: var(--card-background);
      color: var(--text-primary); text-align: center; border-radius: var(--radius-md);
      padding: 22px;   position: fixed; z-index: 101; left: 50%; bottom: 50px;
      font-size: 1.1rem;   font-weight: 500; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color);
    }
    #snackbar.show {
      visibility: visible;
      -webkit-animation: snackbarFadeIn 0.5s, snackbarFadeOut 0.5s 2.5s;
      animation: snackbarFadeIn 0.5s, snackbarFadeOut 0.5s 2.5s;
    }
    #snackbar button {
        background: var(--success-color); color: white; border: none;
        padding: 14px 22px;   margin-left: 16px; cursor: pointer; border-radius: var(--radius-sm); font-weight: 500;
        transition: background 0.2s ease; min-height: 44px;  
    }
    #snackbar button:hover { background: #38a169; }
    @keyframes snackbarFadeIn { from { bottom: 0; opacity: 0; transform: scale(0.8); } to { bottom: 50px; opacity: 1; transform: scale(1); } }
    @keyframes snackbarFadeOut { from { bottom: 50px; opacity: 1; transform: scale(1); } to { bottom: 0; opacity: 0; transform: scale(0.8); } }

     
    .task-card {
        background: var(--card-background);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        padding: 28px;  
         
        margin-bottom: 0;
        border: 1px solid var(--border-color);
        transition: box-shadow 0.2s ease;
         
        width: 100%;
        height: auto;  
        display: flex;
        flex-direction: column;
        overflow-x: auto;
    }

    .task-card:hover {
        box-shadow: var(--shadow-md);
    }
    .task-card-header h3 {
        color: var(--text-primary);
        font-size: 2.4rem !important;  
        font-weight: 600;
        margin-bottom: 12px;
    }
    .task-card-details p {
        margin: 0 0 8px 0;
        font-size: 2.2rem !important;  
        color: var(--text-secondary);
    }
    .task-card-actions {
        display: flex;
        gap: 12px;
        margin-top: auto;  
        padding-top: 10px;  
        border-top: 1px solid var(--border-color);  
        flex-wrap: wrap;  
        justify-content: flex-end;  
    }
    .task-card-actions button {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        padding: 14px 22px;  
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 2rem !important;  
        font-weight: 500;
        transition: all 0.2s ease;
        min-height: 48px;  
    }
    .task-card-actions button.done {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }
    .task-card-actions button.edit {
        background: var(--warning-color);
        color: white;
        border-color: var(--warning-color);
    }
    .task-card-actions button.email {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
     
    #loadingEmails,
    #loadingTasks {
        color: var(--text-secondary);
        font-size: 4rem;  
        font-weight: 500;
        padding: 20px;
    }

     
    @media (min-width: 600px) {
      body { font-size: 1.05rem; }  
      .container { padding: 20px; }  
      nav { border-radius: var(--radius-md); margin-bottom: 16px; }  
      .email-card { padding: 24px; }  
      .email-card-header h3 { font-size: 1.5rem; }  
       
      #emailCardContainer .email-card-snippet { font-size: 1.1rem; max-height: 150px; -webkit-line-clamp: 6; }  
      #emailCardContainer .email-card-snippet p,
      #emailCardContainer .email-card-snippet span,
      #emailCardContainer .email-card-snippet div {
          font-size: inherit;
      }
       
      .email-card-meta { font-size: 0.85rem; }  
      .email-card-actions { grid-template-columns: repeat(3, 1fr); gap: 12px; }  
      .full-email-actions { grid-template-columns: repeat(3, 1fr); }
      .swipe-hint { font-size: 3rem; }  
       
      .swipe-hint.left { left: 40px; width: calc(100% - 80px); }
      .swipe-hint.right { right: 40px; width: calc(100% - 80px); }
      .swipe-hint.up { top: 40px; width: calc(100% - 80px); height: calc(100% - 80px); left: 40px; }
      .swipe-hint.down { bottom: 40px; width: calc(100% - 80px); height: calc(100% - 80px); left: 40px; }

       
      .modal-content h2 { font-size: 1.8rem; }
      .modal-body { font-size: 1rem; }
      .modal-content label { font-size: 1rem; }
      .modal-content input, .modal-content textarea, .modal-content select { font-size: 1rem; }
      .modal-content button { font-size: 1.1rem; }
      .full-email-actions button { font-size: 1rem; }
      #snackbar { font-size: 1rem; }

       
      .task-card-header h3 { font-size: 1.3rem; }
      .task-card-details p { font-size: 0.95rem; }
      .task-card-actions button { font-size: 0.95rem; }
    }

     
     
    @media (min-width: 1024px) {
      body {
        font-size: 1.0rem;
      }
      .container {
        max-width: 1200px;
        padding: 40px;
      }

       
      header {
        padding: 24px 20px;  
      }
      header h1 {
        font-size: 3.0rem;  
      }

       
      footer {
        padding: 15px 20px;  
        font-size: 1.05rem;  
      }

      nav button {
        font-size: 1.3rem;
      }
      .email-card-header h3 {
        font-size: 1.8rem !important;
      }
      #emailCardContainer .email-card-snippet {
        font-size: 1.1rem !important;
        max-height: 200px !important;
        -webkit-line-clamp: 8;
      }
      .email-card-header p,
      .email-card-details p {
        font-size: 0.95rem !important;
      }
      .task-grid-container {
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>MailFlow Manager</h1>
    </header>

    <nav>
      <button id="showEmailsBtn" class="active">Emails</button>
      <button id="showTasksBtn">Tasks</button>
    </nav>

    <div id="emailDashboard" class="dashboard-view">
      <div id="swipeHintLeft" class="swipe-hint left">LEAVE AS UNREAD</div>
      <div id="swipeHintRight" class="swipe-hint right">MARK AS READ</div>
      <div id="swipeHintUp" class="swipe-hint up">MOVE TO TRASH</div>
      <div id="swipeHintDown" class="swipe-hint down">REPLY LATER</div>

      <div id="emailCardContainer" class="card-wrapper">
        <p id="loadingEmails">Loading emails...</p>
        </div>
    </div>

    <div id="taskDashboard" class="dashboard-view" style="display: none;">
      <div id="taskCardsContainer" class="task-grid-container">
        <p id="loadingTasks">Loading tasks...</p>
        </div>
    </div>

    <div id="summaryModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('summaryModal')">&times;</span>
        <h2>Email Summary</h2>
        <div id="summaryText" class="modal-body">Loading summary...</div>
        <button id="generateSummaryBtn">Generate Summary (AI)</button>
        <p style="font-size: 0.8em; color: #777;">Note: Free AI summary limit applies (e.g., 10/month).</p>
      </div>
    </div>

    <div id="createTaskModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('createTaskModal')">&times;</span>
        <h2>Create New Task</h2>
        <form id="taskForm">
          <label for="taskAction">Task Action:</label>
          <input type="text" id="taskAction" required>

          <label for="taskDueDate">Due Date:</label>
          <input type="date" id="taskDueDate">

          <label for="taskDueTime">Due Time:</label>
          <input type="time" id="taskDueTime">

          <label for="taskAssignee">Assignee Email (Optional):</label>
          <input type="email" id="taskAssignee">

          <label for="taskNotes">Notes:</label>
          <textarea id="taskNotes" rows="4" placeholder="Add any relevant notes or details here..."></textarea>

          <input type="hidden" id="taskMessageId">
          <button type="submit">Save Task</button>
        </form>
      </div>
    </div>

    <div id="replyModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('replyModal')">&times;</span>
        <h2>Reply to Email</h2>
        <form id="replyForm">
          <label for="replyBody">Your Reply:</label>
          <textarea id="replyBody" rows="8" required></textarea>
          <input type="hidden" id="replyMessageId">
          <button type="submit">Send Reply</button>
        </form>
      </div>
    </div>

    <div id="fullEmailModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('fullEmailModal')">&times;</span>
        <h2>Full Email Content</h2>
        <div id="fullEmailContent" class="modal-body">Loading email...</div>
        <div class="full-email-actions">
          </div>
      </div>
    </div>

    <div id="replyLaterModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('replyLaterModal')">&times;</span>
        <h2>Remind Me To Reply Later</h2>
        <form id="replyLaterForm">
          <label for="reminderTimeSelect">Remind me:</label>
          <select id="reminderTimeSelect" required>
            <option value="">Choose a time...</option>
            <option value="in 30 minutes">In 30 Minutes</option>
            <option value="in 1 hour">In 1 Hour</option>
            <option value="in 2 hours">In 2 Hours</option>
            <option value="in 3 hours">In 3 Hours</option>
            <option value="mid-day">Today Mid-day (12 PM)</option>
            <option value="end-of-day">Today End-of-Day (5 PM)</option>
            <option value="tomorrow 8am">Tomorrow Morning (8 AM)</option>
          </select>
          <input type="hidden" id="replyLaterMessageId">
          <button type="submit">Set Reminder</button>
        </form>
      </div>
    </div>

    <div id="snackbar"></div>
  </div>

  <footer style="
    background: var(--primary-dark);
    color: var(--text-muted);
    text-align: center;
    padding: 15px 20px;
    font-size: 1.4rem;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0; /* Prevents footer from shrinking */
    margin-top: auto; /* Pushes footer to the bottom if content is short */
  ">
    <p>Made by GC Education Analytics</p>
    <p>&copy; 2025 <a href="https://GCEducationAnalytics.com" target="_blank" style="color: var(--text-secondary); text-decoration: none;">GCEducationAnalytics.com</a>. All rights reserved.</p>
    <p style="margin-top: 5px;">MailFlow Manager v1.0</p>
  </footer>

  <script>
    const emailDashboard = document.getElementById('emailDashboard');
    const taskDashboard = document.getElementById('taskDashboard');
    const loadingEmails = document.getElementById('loadingEmails');
    const loadingTasks = document.getElementById('loadingTasks');
    const summaryModal = document.getElementById('summaryModal');
    const createTaskModal = document.getElementById('createTaskModal');
    const replyModal = document.getElementById('replyModal');
    const fullEmailModal = document.getElementById('fullEmailModal');
    const replyLaterModal = document.getElementById('replyLaterModal'); 
    const snackbar = document.getElementById('snackbar');
    const emailCardContainer = document.getElementById('emailCardContainer');
    const fullEmailActionsDiv = document.querySelector('#fullEmailModal .full-email-actions');
    const taskCardsContainer = document.getElementById('taskCardsContainer');


    
    const swipeHintLeft = document.getElementById('swipeHintLeft');
    const swipeHintRight = document.getElementById('swipeHintRight');
    const swipeHintUp = document.getElementById('swipeHintUp');
    const swipeHintDown = document.getElementById('swipeHintDown');


    let emailQueue = [];
    let isFetching = false;
    let emailBeforeModal = null;
    const PRELOAD_THRESHOLD = 2;
    const BATCH_FETCH_COUNT = 10;

    let currentEmailDisplayed = null; 
    let currentFullEmailMessageId = null; 
    let currentTasks = []; 
    let undoAction = null;

    
    let initialTouchX = 0;
    let initialTouchY = 0;
    let currentTranslateX = 0;
    let currentTranslateY = 0;
    let isDragging = false;
    let isSwipeDetected = false; 
    let dominantAxis = null; 
    const SWIPE_THRESHOLD = 80; 
    const SWIPE_OPACITY_START_THRESHOLD = 30; 
    const SWIPE_OPACITY_END_THRESHOLD = 150; 


    
    document.getElementById('showEmailsBtn').addEventListener('click', () => showView('emails'));
    document.getElementById('showTasksBtn').addEventListener('click', () => showView('tasks'));

    function showView(view) {
        if (view === 'emails') {
            emailDashboard.style.display = 'flex';
            taskDashboard.style.display = 'none';
            document.getElementById('showEmailsBtn').classList.add('active');
            document.getElementById('showTasksBtn').classList.remove('active');
            if (!currentEmailDisplayed && emailQueue.length === 0) {
                preloadEmails(true); 
            } else if (!currentEmailDisplayed && emailQueue.length > 0) {
                displayNextEmail();
            }
        } else if (view === 'tasks') {
            emailDashboard.style.display = 'none';
            taskDashboard.style.display = 'flex'; 
            document.getElementById('showEmailsBtn').classList.remove('active');
            document.getElementById('showTasksBtn').classList.add('active');
            refreshTasks(); 
        }
    }

    function showSnackbar(message, actionText = null, actionCallback = null) {
        snackbar.textContent = message;
        let existingButton = snackbar.querySelector('button');
        if (existingButton) snackbar.removeChild(existingButton);

        if (actionText && actionCallback) {
            const actionButton = document.createElement('button');
            actionButton.textContent = actionText;
            actionButton.onclick = () => {
                actionCallback();
                snackbar.classList.remove('show');
            };
            snackbar.appendChild(actionButton);
        }

        snackbar.classList.add('show');
        setTimeout(() => {
            snackbar.classList.remove('show');
        }, 3000);
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
      
      
      if (modalId === 'summaryModal' || modalId === 'createTaskModal' || modalId === 'replyModal' || modalId === 'fullEmailModal' || modalId === 'replyLaterModal') {
          if (currentEmailDisplayed) {
              emailBeforeModal = currentEmailDisplayed; 
              const card = emailCardContainer.querySelector('.email-card');
              if (card) {
                  card.style.transition = 'opacity 0.2s ease-out'; 
                  card.style.opacity = '0'; 
                  card.style.transform = 'translate3d(0, 0, 0)'; 
              }
          }
      }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';

        
        if (modalId === 'createTaskModal') {
            document.getElementById('taskForm').removeAttribute('data-editing-taskId');
            document.getElementById('createTaskModal').querySelector('h2').innerText = 'Create New Task';
            document.getElementById('createTaskModal').querySelector('button[type="submit"]').innerText = 'Save Task';
            document.getElementById('taskForm').reset();
        }
        if (modalId === 'replyModal') {
            document.getElementById('replyBody').value = '';
        }
        if (modalId === 'replyLaterModal') {
            document.getElementById('reminderTimeSelect').value = '';
        }

        
        
        if (['summaryModal', 'createTaskModal', 'replyModal', 'fullEmailModal', 'replyLaterModal'].includes(modalId)) {
            
            
            
            if (emailBeforeModal && currentEmailDisplayed && emailBeforeModal.id === currentEmailDisplayed.id) {
                renderSingleEmailCard(currentEmailDisplayed); 
                resetCardPosition(); 
            }
            emailBeforeModal = null; 
        }
    }

    
    function updateReminderOptions() {
        const now = new Date();
        const currentHour = now.getHours(); 

        const midDayOption = document.querySelector('#reminderTimeSelect option[value="mid-day"]');
        const endOfDayOption = document.querySelector('#reminderTimeSelect option[value="end-of-day"]');

        if (midDayOption) {
            
            if (currentHour >= 12) { 
                midDayOption.textContent = 'Tomorrow Mid-day (12 PM)';
            } else {
                midDayOption.textContent = 'Today Mid-day (12 PM)';
            }
        }

        if (endOfDayOption) {
            
            if (currentHour >= 17) { 
                endOfDayOption.textContent = 'Tomorrow End-of-Day (5 PM)';
            } else {
                endOfDayOption.textContent = 'Today End-of-Day (5 PM)';
            }
        }
    }

    function handleError(error) {
        console.error("Mock Error:", error);
        showSnackbar("Error: " + (error.message || "An unknown error occurred."), true);
    }

    
    function handleTaskFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const taskIdToEdit = form.dataset.editingTaskId;
        const taskMessageId = document.getElementById('taskMessageId').value; 

        const taskDetails = {
            id: taskIdToEdit || 'mock-task-' + Date.now(),
            action: document.getElementById('taskAction').value,
            dueDate: document.getElementById('taskDueDate').value,
            dueTime: document.getElementById('taskDueTime').value,
            assigneeEmail: document.getElementById('taskAssignee').value,
            notes: document.getElementById('taskNotes').value,
            messageId: document.getElementById('taskMessageId').value,
            status: 'Pending'
        };

        if (taskIdToEdit) {
            
            const taskIndex = currentTasks.findIndex(task => task.id === taskIdToEdit);
            if (taskIndex !== -1) {
                currentTasks[taskIndex] = { ...currentTasks[taskIndex], ...taskDetails };
                closeModal('createTaskModal');
                showSnackbar('Task updated successfully!');
                refreshTasks();
            } else {
                showError("Mock Task not found for update.");
            }
            emailBeforeModal = null; 
        } else {
            
            currentTasks.push(taskDetails);
            closeModal('createTaskModal');
            showSnackbar('Task created successfully!');
            refreshTasks();
            
            if (taskMessageId) {
                emailBeforeModal = null; 
                displayNextEmail();
            } else {
                
                if (currentEmailDisplayed) {
                    renderSingleEmailCard(currentEmailDisplayed);
                    resetCardPosition();
                }
                emailBeforeModal = null; 
            }
        }
    }

    
    document.addEventListener('DOMContentLoaded', () => {
        
        preloadEmails(true); 

        
        document.getElementById('showEmailsBtn').addEventListener('click', () => showView('emails'));
        document.getElementById('showTasksBtn').addEventListener('click', () => showView('tasks'));

        
        document.getElementById('taskForm').addEventListener('submit', handleTaskFormSubmit);
        document.getElementById('replyForm').addEventListener('submit', handleReplyFormSubmit);
        document.getElementById('generateSummaryBtn').addEventListener('click', handleGenerateSummary);
        document.getElementById('replyLaterForm').addEventListener('submit', handleReplyLaterFormSubmit);
        
        updateReminderOptions();
        document.getElementById('replyLaterModal').addEventListener('click', updateReminderOptions);
    });

    

    
    const mockEmails = [
        {
            id: 'email-1',
            threadId: 'thread-1',
            from: 'Sarah Chen <sarah.chen@districtschools.org>',
            subject: 'Urgent: Absences & Substitute Coverage for 3rd Grade',
            snippet: 'Good morning Principal [Your Last Name], Mr. Davis (3rd Grade) called in sick and we have no substitute. His class has been split amongst other teachers but classroom 302 needs attention. Please advise.',
            date: new Date('2025-06-15T07:45:00Z').toISOString(), 
            isUnread: true,
            hasAttachment: false,
            fullBody: `<p>Good morning Principal [Your Last Name],</p><p>Mr. Davis (3rd Grade) called in sick this morning. Unfortunately, due to the late notice, we do not have a substitute available. His class has been temporarily split amongst Ms. Rodriguez (301) and Mr. Kim (303) for first period, but we need a longer-term solution.</p><p>Classroom 302 itself also needs a quick tidy-up after a spilled milk incident yesterday that Mr. Davis didn't get to. It's not urgent, but should be addressed when possible.</p><p>Please advise on the best course of action for the remainder of the day regarding substitute coverage for 3rd grade. I've already notified the front office.</p><p>Thanks,</p><p>Sarah Chen<br>School Secretary</p>`
        },
        {
            id: 'email-2',
            threadId: 'thread-2',
            from: 'Parent Council <parentcouncil@community.org>',
            subject: 'Volunteer Request: Fall Festival Planning Meeting Tonight',
            snippet: 'Dear Principal, a quick reminder about the Fall Festival planning meeting tonight at 6 PM in the library. We\'re still looking for volunteers to help with booth setup and coordination. Your presence is highly valued!',
            date: new Date('2025-06-14T18:00:00Z').toISOString(), 
            isUnread: true,
            hasAttachment: true,
            fullBody: `<p>Dear Principal,</p><p>This is a quick reminder about the Parent Council meeting tonight, **June 14th, at 6:00 PM in the school library**. The primary agenda item is the planning for our annual Fall Festival.</p><p>We are still actively looking for parent volunteers to help with various aspects, including booth setup, game coordination, food vendors, and promotion. Your insights and support are crucial for making this event a success for our students and community.</p><p>We will be discussing budget allocations, vendor selections, and volunteer assignments. Please come prepared with any ideas or suggestions you may have. Minutes from the last meeting are attached.</p><p>We look forward to seeing you there!</p><p>Sincerely,</p><p>The Parent Council Leadership Team</p>`
        },
        {
            id: 'email-3',
            threadId: 'thread-3',
            from: 'District IT Support <itsupport@districtschools.org>',
            subject: 'Mandatory Software Update: Chrome OS for Student Devices',
            snippet: 'Attention Principals, a mandatory Chrome OS update will be rolled out to all student Chromebooks this weekend (June 15-16). Please ensure all devices are charged and connected to school Wi-Fi by Friday dismissal for seamless update. Failure to update may impact device functionality.',
            date: new Date('2025-06-13T10:00:00Z').toISOString(), 
            isUnread: true,
            hasAttachment: false,
            fullBody: `<p>Attention Principals,</p><p>Please be advised of a mandatory Chrome OS update scheduled for all student Chromebooks across the district this weekend, **June 15-16**.</p><p>To ensure a seamless update process and minimize disruption, please ensure that all student devices are charged and connected to the school Wi-Fi network before dismissal on Friday, June 14th. Devices not connected to the network during this window may not receive the update and could experience functionality issues when school resumes.</p><p>A brief guide on verifying the update status will be shared early next week. If you encounter significant issues with devices post-update, please submit an IT ticket through the usual portal.</p><p>Thank you for your cooperation.</p><p>Sincerely,</p><p>District IT Support Team</p>`
        },
        {
            id: 'email-4',
            threadId: 'thread-4',
            from: 'Teacher Lead Ms. Davis <m.davis@districtschools.org>',
            subject: 'Request for Meeting: New Curriculum Implementation Concerns',
            snippet: 'Dear Principal, I would like to request a brief meeting with you and perhaps other grade-level leads to discuss some emerging concerns regarding the implementation of the new Math curriculum. Specifically, pacing and resource allocation for differentiation. Available Tuesday or Wednesday afternoon.',
            date: new Date('2025-06-12T14:30:00Z').toISOString(), 
            isUnread: true,
            hasAttachment: false,
            fullBody: `<p>Dear Principal,</p><p>I am writing on behalf of several teachers from my grade level to request a brief meeting with you. We would also welcome the presence of other grade-level leads or your assistant principal, if available.</p><p>Our main objective is to discuss some emerging concerns and challenges we are facing with the implementation of the new Math curriculum. Specifically, we are finding difficulties with the prescribed pacing, and there are questions regarding the allocation of resources to effectively differentiate instruction for all students, especially those needing additional support or enrichment.</p><p>We believe addressing these issues proactively will be beneficial for student learning outcomes and teacher morale. I am available to meet on Tuesday afternoon (June 17th) between 1:00 PM and 3:00 PM, or Wednesday afternoon (June 18th) between 2:00 PM and 4:00 PM.</p><p>Please let me know what time works best for you. Thank you for your time and consideration.</p><p>Sincerely,</p><p>Ms. Davis<br>5th Grade Lead Teacher</p>`
        },
        {
            id: 'email-5',
            threadId: 'thread-5',
            from: 'District Superintendent <superintendent@districtschools.org>',
            subject: 'Superintendent\'s Weekly Briefing: Focus on Student Wellness',
            snippet: 'Good afternoon, Principals. This week\'s briefing focuses on student wellness initiatives. We are launching new mental health support programs next quarter. Please review the attached policy updates and prepare for discussion at next month\'s district meeting.',
            date: new Date('2025-06-11T16:45:00Z').toISOString(), 
            isUnread: true,
            hasAttachment: true,
            fullBody: `<p>Good afternoon, Principals,</p><p>This week's Superintendent's Briefing is centered on a critical area: **Student Wellness Initiatives**. Our goal is to ensure a supportive and healthy environment for all students.</p><p>We are excited to announce the forthcoming launch of new mental health support programs, including expanded counseling services and resilience-building workshops, starting next quarter. Details regarding funding, staffing, and implementation timelines are outlined in the attached "Student Wellness Policy Updates 2025.pdf".</p><p>Please review these policy updates thoroughly. We will be dedicating a significant portion of our next monthly district meeting (July 10th) to discuss the implications and implementation strategies for these programs at the school level.</p><p>Your feedback and insights are invaluable as we roll out these vital services.</p><p>Best regards,</p><p>Dr. Eleanor Vance<br>District Superintendent</p>`
        }
    ];

    function preloadEmails(forceDisplay = false) {
        if (isFetching) {
            console.log("Already fetching emails, skipping preload.");
            return;
        }
        isFetching = true;
        
        if (emailQueue.length === 0 && !currentEmailDisplayed) {
            emailCardContainer.innerHTML = '<p id="loadingEmails">Loading emails...</p>';
            loadingEmails.style.display = 'block';
        }

        
        setTimeout(() => {
            isFetching = false;
            
            if (emailQueue.length === 0) {
                emailQueue.push(...mockEmails);
            }
            if (!currentEmailDisplayed || forceDisplay) {
                displayNextEmail();
            }
        }, 500); 
    }

    function displayNextEmail() {
        if (emailQueue.length > 0) {
            loadingEmails.style.display = 'none';
            currentEmailDisplayed = emailQueue.shift();
            renderSingleEmailCard(currentEmailDisplayed);
            resetCardPosition(); 
        } else {
            currentEmailDisplayed = null;
            emailCardContainer.innerHTML = '<p>No more unread or important emails at the moment! ðŸŽ‰</p><p>Check back later or switch to tasks.</p>';
        }
    }

    function renderSingleEmailCard(email) {
      emailCardContainer.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'email-card';
      card.dataset.messageId = email.id;

      const date = new Date(email.date).toLocaleString();
      const attachmentIndicator = email.hasAttachment ? '<span style="font-weight: bold; color: #FF9800;">Has Attachment</span>' : '';

      card.innerHTML = `
        <div class="email-card-header">
          <h3>${email.subject}</h3>
          <p>From: ${email.from} - Received: ${date}</p>
        </div>
        <div class="email-card-snippet">
          ${email.snippet || "No preview available."}
        </div>
        <div class="email-card-meta">
            ${attachmentIndicator}
        </div>
        <div class="email-card-actions">
          <button onclick="handleEmailAction('${email.id}', 'reply')">Reply Now</button>
          <button onclick="handleEmailAction('${email.id}', 'archive')">Archive</button>
          <button onclick="handleEmailAction('${email.id}', 'trash')">Trash</button>
          <button onclick="handleEmailAction('${email.id}', 'replyLater')">Reply Later</button>
          <button onclick="handleEmailAction('${email.id}', 'createTask')">Create Task</button>
          <button onclick="handleEmailAction('${email.id}', 'summarize')">Summarize</button>
          <button onclick="handleEmailAction('${email.id}', 'readFull')">Read Full Email</button>
          <button onclick="handleEmailAction('${email.id}', 'unread')">Leave Unread</button>
        </div>
      `;
      emailCardContainer.appendChild(card);

      
      card.addEventListener('touchstart', handleTouchStart);
      card.addEventListener('touchmove', handleTouchMove);
      card.addEventListener('touchend', handleTouchEnd);
    }

    function handleEmailAction(messageId, action) {
      if (!currentEmailDisplayed || currentEmailDisplayed.id !== messageId) {
          showError("Action attempted on an outdated email card.");
          return;
      }

      let successMessage = '';
      let shouldAdvanceUI = false;

      
      const immediateActions = ['archive', 'trash', 'read', 'unread']; 

      
      const modalActions = ['reply', 'replyLater', 'createTask', 'summarize', 'readFull'];

      if (immediateActions.includes(action)) {
        shouldAdvanceUI = true;
        switch (action) {
          case 'archive':
            successMessage = 'Email archived.';
            showSnackbar(successMessage, 'Undo', () => console.log('Mock Undo Archive'));
            break;
          case 'trash':
            successMessage = 'Email moved to trash.';
            showSnackbar(successMessage, 'Undo', () => console.log('Mock Undo Trash'));
            break;
          case 'read':
            successMessage = 'Email marked as read.';
            showSnackbar(successMessage);
            break;
          case 'unread':
            successMessage = 'Email marked as unread.';
            showSnackbar(successMessage);
            break;
        }

        
        const card = emailCardContainer.querySelector('.email-card');
        if (card) {
            let flingX = 0, flingY = 0;
            if (action === 'unread') flingX = -window.innerWidth * 1.5;
            else if (action === 'read') flingX = window.innerWidth * 1.5;
            else if (action === 'trash') flingY = -window.innerHeight * 1.5;
            
            
            else if (action === 'archive') flingX = window.innerWidth * 1.5; 
            
            card.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
            card.style.transform = `translate3d(${flingX}px, ${flingY}px, 0)`;
            card.style.opacity = '0';
        }

      } else if (modalActions.includes(action)) {
          
          
          
          switch (action) {
            case 'reply': openReplyModal(messageId); break;
            case 'replyLater': openReplyLaterModal(messageId); break;
            case 'createTask': openCreateTaskModal(messageId, currentEmailDisplayed.subject); break;
            case 'summarize': openSummaryModal(messageId); break;
            case 'readFull': openFullEmailModal(messageId); break;
            case 'goToNext': 
                shouldAdvanceUI = true; 
                successMessage = 'Skipping to next email.';
                break;
          }
      } else {
        showError("Invalid email action.");
        
        if (currentEmailDisplayed) { 
            renderSingleEmailCard(currentEmailDisplayed);
            resetCardPosition();
        }
        emailBeforeModal = null; 
        return; 
      }

      if (shouldAdvanceUI) {
          
          setTimeout(displayNextEmail, 300);
      }
    }

    
    function openSummaryModal(messageId) {
      const emailToSummarize = currentEmailDisplayed;
      if (!emailToSummarize || emailToSummarize.id !== messageId) {
        showError("Email not found for summarization.");
        return;
      }
      document.getElementById('summaryText').innerHTML = emailToSummarize.snippet || "No preview available.";
      document.getElementById('generateSummaryBtn').style.display = 'block';
      document.getElementById('generateSummaryBtn').disabled = false;
      openModal('summaryModal');
    }

    function handleGenerateSummary() {
      const emailToSummarize = currentEmailDisplayed;
      if (!emailToSummarize) return;

      document.getElementById('summaryText').innerHTML = 'Generating summary... (this may take a moment)';
      document.getElementById('generateSummaryBtn').disabled = true;

      setTimeout(() => {
          const mockSummary = `AI Summary: This email requires your urgent attention. Mr. Davis (3rd Grade) is sick, no substitute is available. His class is split, but Room 302 needs attention. Advise on substitute coverage for the day.`;
          document.getElementById('summaryText').innerHTML = mockSummary;
          if (currentEmailDisplayed && currentEmailDisplayed.id === emailToSummarize.id) {
              currentEmailDisplayed.snippet = mockSummary;
              renderSingleEmailCard(currentEmailDisplayed); 
          }
          showSnackbar('Summary generated successfully!');
          document.getElementById('generateSummaryBtn').disabled = false;
      }, 1500); 
    }

    
    function openReplyModal(messageId) {
      document.getElementById('replyMessageId').value = messageId;
      document.getElementById('replyBody').value = '';
      openModal('replyModal');
    }

    function handleReplyFormSubmit(event) {
        event.preventDefault();
        const messageId = document.getElementById('replyMessageId').value;
        const replyBody = document.getElementById('replyBody').value;

        
        console.log(`Mock Reply to ${messageId}: "${replyBody}"`);
        closeModal('replyModal');
        showSnackbar('Reply sent successfully!');
        
        emailBeforeModal = null; 
        displayNextEmail();
    }

    
    let currentReplyLaterMessageId = null; 

    function openReplyLaterModal(messageId) {
        currentReplyLaterMessageId = messageId;
        document.getElementById('replyLaterMessageId').value = messageId; 
        document.getElementById('reminderTimeSelect').value = ''; 
        updateReminderOptions(); 
        openModal('replyLaterModal');
    }

    function handleReplyLaterFormSubmit(event) {
        event.preventDefault();
        const messageId = document.getElementById('replyLaterMessageId').value;
        const reminderTimeChoice = document.getElementById('reminderTimeSelect').value;

        if (!reminderTimeChoice) {
            showError("Please select a reminder time.");
            return;
        }

        
        console.log(`Mock Reminder set for ${messageId} at ${reminderTimeChoice}`);
        closeModal('replyLaterModal');
        showSnackbar('Reminder set!');
        
        emailBeforeModal = null; 
        displayNextEmail();
    }


    
    
    currentTasks = [
        {
            id: 'task-1',
            messageId: 'email-1',
            action: 'Address 3rd Grade Substitute Coverage',
            dueDate: '2025-06-15', 
            dueTime: '09:00', 
            assigneeEmail: 'assistant.principal@example.com',
            notes: 'Find sub for Mr. Davis. Check on split class arrangement. Tidy Room 302.',
            status: 'Pending'
        },
        {
            id: 'task-2',
            messageId: 'email-2',
            action: 'Prepare for Fall Festival Planning Meeting',
            dueDate: '2025-06-14', 
            dueTime: '17:30', 
            assigneeEmail: 'principal@example.com',
            notes: 'Review attached minutes. Brainstorm volunteer incentives. Prepare agenda points for booths/food.',
            status: 'Done' 
        },
        {
            id: 'task-3',
            messageId: 'email-4',
            action: 'Meet with Ms. Davis regarding new Math curriculum',
            dueDate: '2025-06-18', 
            dueTime: '15:00', 
            assigneeEmail: 'principal@example.com',
            notes: 'Discuss pacing and differentiation resources. Consider involving curriculum coordinator.',
            status: 'Pending'
        },
        {
            id: 'task-4',
            messageId: 'email-5',
            action: 'Review Superintendent\'s Briefing: Student Wellness',
            dueDate: '2025-07-09', 
            dueTime: '16:00', 
            assigneeEmail: 'principal@example.com',
            notes: 'Read attached policy updates. Prepare questions/feedback for July 10th district meeting.',
            status: 'Pending'
        },
        {
            id: 'task-5',
            messageId: 'email-3',
            action: 'Notify staff about Chrome OS update for student Chromebooks',
            dueDate: '2025-06-14', 
            dueTime: '14:00', 
            assigneeEmail: 'it.coordinator@example.com',
            notes: 'Send school-wide announcement. Remind teachers to have students charge devices.',
            status: 'Done' 
        }
    ];

    function openCreateTaskModal(messageId = '', subject = '', taskId = '', action = '', rawDueDate = '', rawDueTime = '', assigneeEmail = '', notes = '') {
        const modal = document.getElementById('createTaskModal');
        const form = document.getElementById('taskForm');

        form.reset(); 
        form.removeAttribute('data-editing-taskId'); 
        document.getElementById('taskMessageId').value = ''; 

        
        if (taskId) {
            modal.querySelector('h2').innerText = 'Edit Task';
            modal.querySelector('button[type="submit"]').innerText = 'Update Task';
            form.dataset.editingTaskId = taskId; 

            
            document.getElementById('taskAction').value = action;
            document.getElementById('taskDueDate').value = rawDueDate;
            document.getElementById('taskDueTime').value = rawDueTime;
            document.getElementById('taskAssignee').value = assigneeEmail;
            document.getElementById('taskNotes').value = notes;
            document.getElementById('taskMessageId').value = messageId;
        } else {
            modal.querySelector('h2').innerText = 'Create New Task';
            modal.querySelector('button[type="submit"]').innerText = 'Save Task';

            
            document.getElementById('taskMessageId').value = messageId;
            document.getElementById('taskAction').value = subject ? `Follow up on: ${subject}` : '';
            document.getElementById('taskDueDate').value = '';
            document.getElementById('taskDueTime').value = '';
            document.getElementById('taskAssignee').value = '';
            document.getElementById('taskNotes').value = '';
        }

        openModal('createTaskModal');
    }

    function refreshTasks() {
        
        taskCardsContainer.innerHTML = '<p id="loadingTasks" style="text-align: center; padding: 20px;">Loading tasks...</p>';
        const existingLoadingP = document.getElementById('loadingTasks');
        if (existingLoadingP) existingLoadingP.style.display = 'block';

        setTimeout(() => {
            displayMockTasksGrid(currentTasks);
        }, 500); 
    }

    
    function displayMockTasksGrid(tasks) {
        let tasksHtml = '';
        const pendingTasks = tasks.filter(task => task.status !== 'Done');

        if (pendingTasks.length === 0) {
            tasksHtml = '<p id="loadingTasks" style="text-align: center; padding: 20px;">No pending tasks found.</p>';
        } else {
            pendingTasks.forEach(task => {
                let dueDateDisplay = 'N/A';
                let dueTimeDisplay = '';
                let rawDateOnly = task.dueDate || '';
                let rawTimeOnly = task.dueTime || '';

                if (task.dueDate) {
                    try {
                        const dueDateObj = new Date(`${task.dueDate}T${task.dueTime || '00:00'}`);
                        
                        const optionsDate = { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'America/Chicago' };
                        const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'America/Chicago' };

                        dueDateDisplay = dueDateObj.toLocaleDateString('en-US', optionsDate);
                        dueTimeDisplay = dueDateObj.toLocaleTimeString('en-US', optionsTime);
                    } catch (e) {
                        console.error(`Invalid due date/time for task ${task.id}:`, e);
                        dueDateDisplay = 'Invalid Date';
                        dueTimeDisplay = '';
                    }
                }

                tasksHtml += `
                    <div class="task-card"
                         data-task-id="${task.id}"
                         data-raw-duedate="${rawDateOnly}"
                         data-raw-duetime="${rawTimeOnly}"
                         data-raw-notes="${task.notes}"
                         data-message-id="${task.messageId}">
                        <div class="task-card-header">
                            <h3>${task.action}</h3>
                        </div>
                        <div class="task-card-details">
                            <p><strong>Assigned To:</strong> ${task.assigneeEmail}</p>
                            <p><strong>Due Date:</strong> ${dueDateDisplay}</p>
                            ${dueTimeDisplay ? `<p><strong>Due Time:</strong> ${dueTimeDisplay}</p>` : ''}
                            <p><strong>Status:</strong> ${task.status}</p>
                            ${task.notes ? `<p><strong>Notes:</strong> ${task.notes}</p>` : ''}
                        </div>
                        <div class="task-card-actions">
                            <button class="done">Mark Done</button>
                            <button class="edit">Edit</button>
                            ${task.assigneeEmail && task.assigneeEmail !== 'principal@example.com' ? `<button class="email">Email Assignee</button>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        taskCardsContainer.innerHTML = tasksHtml;
        attachTaskButtonListeners();
    }

    function attachTaskButtonListeners() {
        document.querySelectorAll('.task-card-actions .done').forEach(button => {
            button.onclick = function() {
                const taskId = this.closest('.task-card').dataset.taskId;
                updateTaskStatus(taskId, 'Done');
            };
        });

        document.querySelectorAll('.task-card-actions .edit').forEach(button => {
            button.onclick = function() {
                const card = this.closest('.task-card');
                const taskId = card.dataset.taskId;
                const task = currentTasks.find(t => t.id === taskId);
                if (task) {
                    openCreateTaskModal(task.messageId, task.subject, task.id, task.action, task.dueDate, task.dueTime, task.assigneeEmail, task.notes);
                } else {
                    showError("Mock Task not found for editing.");
                }
            };
        });

        document.querySelectorAll('.task-card-actions .email').forEach(button => {
            button.onclick = function() {
                const taskId = this.closest('.task-card').dataset.taskId;
                emailAssignee(taskId);
            };
        });
    }

    function updateTaskStatus(taskId, status) {
        const taskIndex = currentTasks.findIndex(task => task.id === taskId);
        if (taskIndex !== -1) {
            currentTasks[taskIndex].status = status;
            showSnackbar(`Task marked as ${status}!`);
            refreshTasks();
        } else {
            showError("Mock Task not found for status update.");
        }
    }

    function emailAssignee(taskId) {
        const task = currentTasks.find(t => t.id === taskId);
        if (task && task.assigneeEmail) {
            showSnackbar(`Simulating email sent to ${task.assigneeEmail} for task "${task.action}"!`);
        } else {
            showError("No assignee found for this task or task not found.");
        }
    }

    
    function openFullEmailModal(messageId) {
        currentFullEmailMessageId = messageId;
        const fullEmailContentDiv = document.getElementById('fullEmailContent');
        fullEmailContentDiv.innerHTML = '<p>Loading full email...</p>';
        fullEmailContentDiv.classList.remove('raw-html');
        openModal('fullEmailModal');

        fullEmailActionsDiv.innerHTML = `
            <button onclick="handleModalEmailAction('${messageId}', 'reply')">Reply Now</button>
            <button onclick="handleModalEmailAction('${messageId}', 'archive')">Archive</button>
            <button onclick="handleModalEmailAction('${messageId}', 'trash')">Trash</button>
            <button onclick="handleModalEmailAction('${messageId}', 'replyLater')">Reply Later</button>
            <button onclick="handleModalEmailAction('${messageId}', 'createTask')">Create Task</button>
            <button onclick="handleModalEmailAction('${messageId}', 'summarize')">Summarize</button>
            <button onclick="handleModalEmailAction('${messageId}', 'unread')">Leave Unread</button>
            <button onclick="handleModalEmailAction('${messageId}', 'goToNext')">Go to Next Email</button>
        `;

        const email = mockEmails.find(e => e.id === messageId);
        if (email) {
            setTimeout(() => {
                fullEmailContentDiv.innerHTML = email.fullBody;
                showSnackbar('Full email loaded.');
            }, 500); 
        } else {
            fullEmailContentDiv.textContent = `Error: Mock email with ID ${messageId} not found.`;
            showError("Mock email not found for full view.");
        }
    }

    function handleModalEmailAction(messageId, action) {
        if (!messageId) {
            showError("No email currently loaded in full view modal for action.");
            closeModal('fullEmailModal');
            return;
        }

        let successMessage = '';

        switch (action) {
            case 'archive':
                successMessage = 'Email archived.';
                showSnackbar(successMessage, 'Undo', () => console.log('Mock Undo Archive from Modal'));
                break;
            case 'trash':
                successMessage = 'Email moved to trash.';
                showSnackbar(successMessage, 'Undo', () => console.log('Mock Undo Trash from Modal'));
                break;
            case 'unread':
                successMessage = 'Email marked as unread.';
                showSnackbar(successMessage);
                break;
            case 'reply':
                closeModal('fullEmailModal');
                openReplyModal(messageId);
                return;
            case 'replyLater':
                closeModal('fullEmailModal');
                openReplyLaterModal(messageId);
                return;
            case 'createTask':
                closeModal('fullEmailModal');
                
                const originalEmail = mockEmails.find(e => e.id === messageId);
                openCreateTaskModal(messageId, originalEmail ? originalEmail.subject : '');
                return;
            case 'summarize':
                closeModal('fullEmailModal');
                openSummaryModal(messageId);
                return;
            case 'goToNext':
                showSnackbar('Skipping to next email.');
                break;
            default:
                showError("Invalid modal action.");
                return;
        }

        closeModal('fullEmailModal');
        displayNextEmail();
    }


    
    function handleTouchStart(e) {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            initialTouchX = touch.clientX;
            initialTouchY = touch.clientY;
            const card = e.currentTarget;
            card.classList.add('dragging');
            isDragging = true;
            isSwipeDetected = false;
            
            currentTranslateX = 0;
            currentTranslateY = 0;

            hideAllSwipeHints();
        }
    }

    function handleTouchMove(e) {
        if (!isDragging || e.touches.length !== 1) return;

        const touch = e.touches[0];
        let deltaX = touch.clientX - initialTouchX;
        let deltaY = touch.clientY - initialTouchY;
        const card = e.currentTarget;

        
        currentTranslateX = deltaX;
        currentTranslateY = deltaY;

        card.style.transform = `translate3d(${deltaX}px, ${deltaY}px, 0)`;

        const absDelta = Math.max(Math.abs(deltaX), Math.abs(deltaY)); 
        const opacityStrength = Math.min(1, Math.max(0, (absDelta - SWIPE_OPACITY_START_THRESHOLD) / SWIPE_OPACITY_END_THRESHOLD));
        card.style.opacity = 1 - (opacityStrength * 0.5);

        hideAllSwipeHints();
        if (absDelta > SWIPE_OPACITY_START_THRESHOLD) {
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) { 
                if (deltaX < 0) swipeHintLeft.classList.add('show');
                else swipeHintRight.classList.add('show');
            } else { 
                if (deltaY < 0) swipeHintUp.classList.add('show');
                else swipeHintDown.classList.add('show');
            }
        }
    }

    function handleTouchEnd(e) {
        if (!isDragging) return;

        isDragging = false;
        const card = e.currentTarget;
        card.classList.remove('dragging');
        hideAllSwipeHints();

        const absDeltaX = Math.abs(currentTranslateX);
        const absDeltaY = Math.abs(currentTranslateY);

        let actionTriggered = false;
        let triggeredAction = null;

        
        if (absDeltaX >= SWIPE_THRESHOLD || absDeltaY >= SWIPE_THRESHOLD) {
            if (absDeltaX > absDeltaY) { 
                if (currentTranslateX < 0) { triggeredAction = 'unread'; }
                else { triggeredAction = 'read'; }
            } else { 
                if (currentTranslateY < 0) { triggeredAction = 'trash'; }
                else { triggeredAction = 'replyLater'; } 
            }

            if (triggeredAction) {
                
                handleEmailAction(card.dataset.messageId, triggeredAction);
                actionTriggered = true;
            }
        }

        if (!actionTriggered) {
            
            
            
            resetCardPosition();
        }
        
        
        initialTouchX = 0;
        initialTouchY = 0;
        currentTranslateX = 0;
        currentTranslateY = 0;
    }

    function resetCardPosition() {
        const card = emailCardContainer.querySelector('.email-card');
        if (card) {
            card.style.transform = 'translate3d(0, 0, 0)';
            card.style.opacity = '1';
        }
    }

    function hideAllSwipeHints() {
        swipeHintLeft.classList.remove('show');
        swipeHintRight.classList.remove('show');
        swipeHintUp.classList.remove('show');
        swipeHintDown.classList.remove('show');
    }


    
    function showError(error) {
      console.error('Mock Error:', error);
      showSnackbar(`Error: ${error.message || 'An unknown error occurred.'}`);
    }

    
    
    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
        window.google = {
            script: {
                run: {
                    withSuccessHandler: function(callback) {
                        return {
                            withFailureHandler: function(errorCallback) {
                                return {
                                    
                                    fetchEmails: function() { console.log('Mock fetchEmails called'); callback([]); },
                                    archiveEmail: function(id) { console.log('Mock archiveEmail called for', id); callback(); },
                                    trashEmail: function(id) { console.log('Mock trashEmail called for', id); callback(); },
                                    markAsRead: function(id) { console.log('Mock markAsRead called for', id); callback(); },
                                    markAsUnread: function(id) { console.log('Mock markAsUnread called for', id); callback(); },
                                    sendReply: function(id, body) { console.log('Mock sendReply called for', id); callback(); },
                                    logReminder: function(id, time) { console.log('Mock logReminder called for', id, time); callback(); },
                                    saveTask: function(task) { console.log('Mock saveTask called', task); callback('mock-task-' + Date.now()); },
                                    updateTask: function(id, updates) { console.log('Mock updateTask called for', id, updates); callback(); },
                                    listTasks: function() { console.log('Mock listTasks called'); callback(''); }, 
                                    emailTaskAssignee: function(id) { console.log('Mock emailTaskAssignee called for', id); callback(); },
                                    getFullEmailContent: function(id) { 
                                        const email = mockEmails.find(e => e.id === id);
                                        callback(email ? email.fullBody : 'Mock Full Email Content not found.'); 
                                    },
                                    callAISummarize: function(id, body) { console.log('Mock callAISummarize called for', id); callback('Mock AI Summary for ' + id + ': ' + body.substring(0, 50) + '...'); }
                                };
                            }
                        };
                    }
                }
            }
        };
    }

  </script>
</body>
</html>